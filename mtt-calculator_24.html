<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OMOINV Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg-primary: #0a0e17;
    --bg-secondary: #111827;
    --bg-card: #1a2236;
    --bg-input: #0f1629;
    --border: #2a3550;
    --border-focus: #3b82f6;
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent-blue: #3b82f6;
    --accent-cyan: #06b6d4;
    --accent-green: #10b981;
    --accent-red: #ef4444;
    --accent-amber: #f59e0b;
    --accent-purple: #8b5cf6;
    --glow-blue: rgba(59, 130, 246, 0.15);
    --glow-green: rgba(16, 185, 129, 0.15);
    --glow-red: rgba(239, 68, 68, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  .app-container {
    position: relative;
    z-index: 1;
    max-width: 1280px;
    margin: 0 auto;
    padding: 24px 20px 60px;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 36px;
    animation: fadeDown 0.6s ease-out;
  }

  .header-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(139, 92, 246, 0.12));
    border: 1px solid rgba(59, 130, 246, 0.25);
    border-radius: 100px;
    padding: 6px 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-cyan);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 16px;
  }

  .header-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    background: var(--accent-cyan);
    border-radius: 50%;
    animation: pulse-dot 2s infinite;
  }

  .header h1 {
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(135deg, #e2e8f0 0%, #3b82f6 50%, #06b6d4 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
    line-height: 1.2;
  }

  .header p {
    color: var(--text-secondary);
    font-size: 15px;
    margin-top: 8px;
  }

  /* Cards */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
    animation: fadeUp 0.5s ease-out both;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.4), transparent);
  }

  .card:nth-child(2) { animation-delay: 0.05s; }
  .card:nth-child(3) { animation-delay: 0.1s; }
  .card:nth-child(4) { animation-delay: 0.15s; }
  .card:nth-child(5) { animation-delay: 0.2s; }

  .card-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 20px;
  }

  .card-title .icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border-radius: 10px;
    font-size: 16px;
  }

  .icon-blue { background: rgba(59, 130, 246, 0.15); }
  .icon-green { background: rgba(16, 185, 129, 0.15); }
  .icon-purple { background: rgba(139, 92, 246, 0.15); }
  .icon-cyan { background: rgba(6, 182, 212, 0.15); }
  .icon-amber { background: rgba(245, 158, 11, 0.15); }

  /* CORS Notice */
  .cors-notice {
    background: rgba(245, 158, 11, 0.06);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
    animation: fadeUp 0.5s ease-out both;
  }

  .cors-notice strong {
    color: var(--accent-amber);
    display: block;
    margin-bottom: 6px;
    font-size: 13px;
  }

  .cors-notice ul {
    list-style: none;
    padding-left: 0;
    margin: 8px 0 0;
  }

  .cors-notice ul li {
    padding: 2px 0;
    padding-left: 18px;
    position: relative;
  }

  .cors-notice ul li::before {
    content: '‚Ä∫';
    position: absolute;
    left: 4px;
    color: var(--accent-amber);
    font-weight: 700;
  }

  /* Form elements */
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }

  .form-row.triple {
    grid-template-columns: 1fr 1fr 1fr;
  }

  @media (max-width: 640px) {
    .form-row, .form-row.triple {
      grid-template-columns: 1fr;
    }
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .form-group input,
  .form-group select {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 11px 14px;
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    outline: none;
    width: 100%;
  }

  .form-group input::placeholder {
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
  }

  .form-group input:focus,
  .form-group select:focus {
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px var(--glow-blue);
  }

  .form-group select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    padding-right: 36px;
  }

  .form-group select option {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  /* Quick symbol chips */
  .symbol-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
  }

  .symbol-chip {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }

  .symbol-chip:hover {
    border-color: var(--accent-blue);
    color: var(--accent-blue);
    background: rgba(59, 130, 246, 0.08);
  }

  .symbol-chip.active {
    border-color: var(--accent-blue);
    color: var(--accent-blue);
    background: rgba(59, 130, 246, 0.12);
    box-shadow: 0 0 0 2px var(--glow-blue);
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 13px 28px;
    border-radius: 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: #fff;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
    width: 100%;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 24px rgba(59, 130, 246, 0.4);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .btn-green {
    background: linear-gradient(135deg, #10b981, #059669);
    color: #fff;
    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    width: 100%;
  }

  .btn-green:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 24px rgba(16, 185, 129, 0.4);
  }

  /* Spinner */
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: none;
  }

  .btn.loading .spinner { display: block; }
  .btn.loading .btn-text { opacity: 0.7; }

  /* Status messages */
  .status-bar {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 16px;
    margin-top: 12px;
    font-size: 13px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-muted);
    display: none;
    align-items: center;
    gap: 8px;
  }

  .status-bar.visible { display: flex; }
  .status-bar.success { border-color: rgba(16,185,129,0.3); color: var(--accent-green); }
  .status-bar.error { border-color: rgba(239,68,68,0.3); color: var(--accent-red); }

  /* OMOINV Criteria checklist */
  .criteria-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .criteria-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    transition: all 0.3s;
  }

  .criteria-item .check-icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    flex-shrink: 0;
    background: rgba(100,116,139,0.15);
    color: var(--text-muted);
    transition: all 0.3s;
  }

  .criteria-item.pass {
    border-color: rgba(16, 185, 129, 0.25);
    background: rgba(16, 185, 129, 0.04);
  }

  .criteria-item.pass .check-icon {
    background: rgba(16, 185, 129, 0.2);
    color: var(--accent-green);
  }

  .criteria-item.fail {
    border-color: rgba(239, 68, 68, 0.25);
    background: rgba(239, 68, 68, 0.04);
  }

  .criteria-item.fail .check-icon {
    background: rgba(239, 68, 68, 0.2);
    color: var(--accent-red);
  }

  .criteria-text {
    font-size: 14px;
    color: var(--text-secondary);
    flex: 1;
  }

  .criteria-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    white-space: nowrap;
  }

  /* Score display */
  .score-display {
    text-align: center;
    padding: 32px 20px;
    display: none;
  }

  .score-display.visible { display: block; }

  .score-ring-container {
    position: relative;
    width: 160px;
    height: 160px;
    margin: 0 auto 20px;
  }

  .score-ring {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }

  .score-ring-bg {
    fill: none;
    stroke: var(--border);
    stroke-width: 8;
  }

  .score-ring-fill {
    fill: none;
    stroke-width: 8;
    stroke-linecap: round;
    stroke-dasharray: 408;
    stroke-dashoffset: 408;
    transition: stroke-dashoffset 1.2s ease-out, stroke 0.3s;
  }

  .score-number {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .score-number .value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 42px;
    font-weight: 700;
    line-height: 1;
  }

  .score-number .label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }

  .score-verdict {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .score-subtitle {
    font-size: 13px;
    color: var(--text-secondary);
  }

  /* Breadth meter */
  .breadth-meter {
    margin-top: 16px;
  }

  .breadth-bar-track {
    height: 10px;
    background: var(--bg-input);
    border-radius: 100px;
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .breadth-bar-fill {
    height: 100%;
    border-radius: 100px;
    transition: width 0.8s ease-out, background 0.3s;
    width: 0%;
  }

  .breadth-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-muted);
  }

  .breadth-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 12px;
    color: var(--text-muted);
  }

  .breadth-status {
    text-align: center;
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 10px;
  }

  /* Chart container */
  .chart-container {
    position: relative;
    height: 350px;
    margin-top: 12px;
  }

  .chart-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    font-size: 14px;
    gap: 8px;
    border: 1px dashed var(--border);
    border-radius: 12px;
  }

  .chart-placeholder .ph-icon {
    font-size: 32px;
    opacity: 0.4;
  }

  /* Two-column layout */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 768px) {
    .grid-2 { grid-template-columns: 1fr; }
  }

  /* Animations */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  @keyframes score-pop {
    0% { transform: scale(0.8); opacity: 0; }
    60% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
  }

  .score-display.visible .score-ring-container {
    animation: score-pop 0.6s ease-out;
  }

  /* Data populated highlight */
  .form-group input.populated {
    border-color: rgba(16, 185, 129, 0.3);
    background: rgba(16, 185, 129, 0.04);
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 24px 0 0;
    font-size: 12px;
    color: var(--text-muted);
  }

  /* Commentary section */
  .commentary-card {
    display: none;
  }

  .commentary-card.visible {
    display: block;
  }

  .commentary-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .commentary-timestamp {
    font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-muted);
    background: var(--bg-input);
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
  }

  .commentary-body {
    line-height: 1.75;
    color: var(--text-secondary);
    font-size: 14.5px;
  }

  .commentary-body .section-label {
    display: inline-block;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 3px 10px;
    border-radius: 4px;
    margin-bottom: 8px;
    margin-top: 20px;
  }

  .commentary-body .section-label:first-child {
    margin-top: 0;
  }

  .section-label.verdict-label {
    background: rgba(59, 130, 246, 0.12);
    color: var(--accent-blue);
  }

  .section-label.trend-label {
    background: rgba(139, 92, 246, 0.12);
    color: var(--accent-purple);
  }

  .section-label.strength-label {
    background: rgba(6, 182, 212, 0.12);
    color: var(--accent-cyan);
  }

  .section-label.risk-label {
    background: rgba(245, 158, 11, 0.12);
    color: var(--accent-amber);
  }

  .section-label.action-label {
    background: rgba(16, 185, 129, 0.12);
    color: var(--accent-green);
  }

  .commentary-body p {
    margin: 6px 0 14px;
  }

  .commentary-body strong {
    color: var(--text-primary);
    font-weight: 600;
  }

  .commentary-body .highlight-green {
    color: var(--accent-green);
    font-weight: 600;
  }

  .commentary-body .highlight-red {
    color: var(--accent-red);
    font-weight: 600;
  }

  .commentary-body .highlight-amber {
    color: var(--accent-amber);
    font-weight: 600;
  }

  .commentary-body .highlight-blue {
    color: var(--accent-blue);
    font-weight: 600;
  }

  .commentary-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 18px 0;
  }

  /* Historical legend */
  .hist-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }

  .hist-legend-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg-input);
  }

  .hist-legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 3px;
  }

  /* Historical timeline blocks */
  .hist-period {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 14px;
    position: relative;
    transition: border-color 0.3s;
  }

  .hist-period.strong {
    border-left: 3px solid var(--accent-green);
  }

  .hist-period.moderate {
    border-left: 3px solid var(--accent-cyan);
  }

  .hist-period.weak {
    border-left: 3px solid var(--accent-amber);
  }

  .hist-period.bearish {
    border-left: 3px solid var(--accent-red);
  }

  .hist-period-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
    flex-wrap: wrap;
    gap: 8px;
  }

  .hist-period-date {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .hist-period-badge {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 3px 10px;
    border-radius: 4px;
  }

  .badge-green { background: rgba(16,185,129,0.15); color: var(--accent-green); }
  .badge-cyan { background: rgba(6,182,212,0.15); color: var(--accent-cyan); }
  .badge-amber { background: rgba(245,158,11,0.15); color: var(--accent-amber); }
  .badge-red { background: rgba(239,68,68,0.15); color: var(--accent-red); }

  .hist-period-text {
    font-size: 13.5px;
    line-height: 1.65;
    color: var(--text-secondary);
  }

  .hist-period-text strong {
    color: var(--text-primary);
  }

  .hist-summary-box {
    background: linear-gradient(135deg, rgba(59,130,246,0.06), rgba(139,92,246,0.06));
    border: 1px solid rgba(59,130,246,0.2);
    border-radius: 12px;
    padding: 18px 22px;
    margin-top: 20px;
    margin-bottom: 4px;
  }

  .hist-summary-box .summary-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--accent-blue);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }

  .hist-summary-box p {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-secondary);
    margin: 0;
  }

  .hist-summary-box strong {
    color: var(--text-primary);
  }

  /* ‚îÄ‚îÄ Backtest Section ‚îÄ‚îÄ */
  .backtest-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .stat-box {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    text-align: center;
  }
  .stat-box .stat-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .stat-box .stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 22px;
    font-weight: 700;
  }
  .stat-box .stat-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }
  .trade-table-wrap {
    overflow-x: auto;
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  .trade-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  .trade-table th {
    background: var(--bg-input);
    color: var(--text-muted);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 10px 14px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .trade-table td {
    padding: 10px 14px;
    border-bottom: 1px solid rgba(42,53,80,0.3);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--text-secondary);
    white-space: nowrap;
  }
  .trade-table tr:last-child td { border-bottom: none; }
  .trade-table tr:hover td { background: rgba(59,130,246,0.04); }
  .badge-buy { background: rgba(16,185,129,0.15); color: var(--accent-green); padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 10px; }
  .badge-sell { background: rgba(239,68,68,0.15); color: var(--accent-red); padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 10px; }
  .badge-hold { background: rgba(59,130,246,0.15); color: var(--accent-blue); padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 10px; }
  .backtest-config {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: end;
    margin-bottom: 16px;
  }
  .backtest-config .form-group { flex: 1; min-width: 140px; }

  /* ‚îÄ‚îÄ Screener Section ‚îÄ‚îÄ */
  .screener-input-area {
    display: flex;
    gap: 12px;
    align-items: end;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .screener-input-area .form-group { flex: 1; min-width: 200px; }
  .screener-presets {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 14px;
  }
  .screener-preset {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 12px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
  }
  .screener-preset:hover {
    border-color: var(--accent-blue);
    color: var(--accent-blue);
  }
  .screener-progress {
    margin-bottom: 16px;
    display: none;
  }
  .screener-progress.visible { display: block; }
  .screener-progress-bar {
    height: 6px;
    background: var(--bg-input);
    border-radius: 100px;
    overflow: hidden;
    border: 1px solid var(--border);
    margin-top: 8px;
  }
  .screener-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #06b6d4);
    border-radius: 100px;
    transition: width 0.3s;
    width: 0%;
  }
  .screener-progress-text {
    font-size: 12px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }
  .screener-table-wrap {
    overflow-x: auto;
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  .screener-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  .screener-table th {
    background: var(--bg-input);
    color: var(--text-muted);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
  }
  .screener-table th:hover { color: var(--accent-blue); }
  .screener-table td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(42,53,80,0.3);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--text-secondary);
    white-space: nowrap;
  }
  .screener-table tr:last-child td { border-bottom: none; }
  .screener-table tr:hover td { background: rgba(59,130,246,0.04); }
  .score-pill {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 12px;
  }
  .score-7 { background: rgba(16,185,129,0.15); color: #10b981; }

  /* ‚îÄ‚îÄ Weinstein & Zweig ‚îÄ‚îÄ */
  .framework-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  @media (max-width: 900px) { .framework-grid { grid-template-columns: 1fr; } }

  .stage-diagram { display: flex; gap: 0; margin: 16px 0; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
  .stage-box { flex: 1; padding: 14px 10px; text-align: center; position: relative; transition: all 0.4s ease; }
  .stage-box .stage-num { font-size: 22px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .stage-box .stage-name { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; opacity: 0.8; }
  .stage-box.s1 { background: rgba(148,163,184,0.08); color: var(--text-muted); }
  .stage-box.s2 { background: rgba(16,185,129,0.08); color: var(--text-muted); }
  .stage-box.s3 { background: rgba(245,158,11,0.08); color: var(--text-muted); }
  .stage-box.s4 { background: rgba(239,68,68,0.08); color: var(--text-muted); }
  .stage-box.active.s1 { background: rgba(148,163,184,0.25); color: #94a3b8; box-shadow: inset 0 0 20px rgba(148,163,184,0.1); }
  .stage-box.active.s2 { background: rgba(16,185,129,0.25); color: #10b981; box-shadow: inset 0 0 20px rgba(16,185,129,0.15); }
  .stage-box.active.s3 { background: rgba(245,158,11,0.25); color: #f59e0b; box-shadow: inset 0 0 20px rgba(245,158,11,0.1); }
  .stage-box.active.s4 { background: rgba(239,68,68,0.25); color: #ef4444; box-shadow: inset 0 0 20px rgba(239,68,68,0.1); }
  .stage-box.active .stage-num { font-size: 26px; }
  .stage-box.active::after { content: '‚ñ≤'; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 10px; }

  .stage-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0; }
  .stage-metric { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; }
  .stage-metric .metric-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 4px; }
  .stage-metric .metric-value { font-size: 16px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

  .zweig-gauge { display: flex; align-items: center; gap: 12px; margin: 14px 0; }
  .zweig-gauge-bar { flex: 1; height: 10px; border-radius: 5px; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 35%, #10b981 65%, #10b981 100%); position: relative; }
  .zweig-gauge-needle { width: 4px; height: 18px; background: white; border-radius: 2px; position: absolute; top: -4px; transition: left 0.6s ease; box-shadow: 0 0 6px rgba(255,255,255,0.5); }
  .zweig-gauge-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-top: 2px; }

  .zweig-params { display: grid; grid-template-columns: 1fr; gap: 8px; margin: 12px 0; }
  .zweig-param { display: flex; justify-content: space-between; align-items: center; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; }
  .zweig-param .zp-label { font-size: 12px; color: var(--text-secondary); }
  .zweig-param .zp-value { font-size: 13px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
  .zweig-param .zp-signal { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 4px; }
  .zp-bull { background: rgba(16,185,129,0.15); color: #10b981; }
  .zp-bear { background: rgba(239,68,68,0.15); color: #ef4444; }
  .zp-neutral { background: rgba(245,158,11,0.15); color: #f59e0b; }

  .framework-verdict { padding: 14px 16px; border-radius: 10px; margin-top: 12px; font-size: 13px; line-height: 1.6; }
  .framework-verdict.bullish { background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.2); }
  .framework-verdict.bearish { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); }
  .framework-verdict.neutral { background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); }
  .framework-verdict .fv-title { font-weight: 700; font-size: 14px; margin-bottom: 6px; }

  /* ‚îÄ‚îÄ Cycle Analysis ‚îÄ‚îÄ */
  .cycle-timeline { position: relative; padding: 16px 0 16px 28px; border-left: 2px solid var(--border); margin: 16px 0 16px 12px; }
  .cycle-event { position: relative; margin-bottom: 18px; }
  .cycle-event:last-child { margin-bottom: 0; }
  .cycle-event::before { content: ''; position: absolute; left: -34px; top: 6px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--border); background: var(--bg-card); }
  .cycle-event.past::before { background: var(--text-muted); border-color: var(--text-muted); }
  .cycle-event.upcoming::before { background: var(--accent-cyan); border-color: var(--accent-cyan); box-shadow: 0 0 8px rgba(6,182,212,0.4); }
  .cycle-event.convergence::before { background: var(--accent-amber); border-color: var(--accent-amber); box-shadow: 0 0 12px rgba(245,158,11,0.5); width: 14px; height: 14px; left: -35px; top: 5px; }
  .cycle-event.major::before { background: var(--accent-red); border-color: var(--accent-red); box-shadow: 0 0 14px rgba(239,68,68,0.5); width: 16px; height: 16px; left: -36px; top: 4px; }
  .cycle-date { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; }
  .cycle-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
  .cycle-tag { font-size: 10px; padding: 2px 7px; border-radius: 4px; font-weight: 600; letter-spacing: 0.3px; }
  .cycle-tag.armstrong { background: rgba(139,92,246,0.15); color: #a78bfa; }
  .cycle-tag.fib { background: rgba(245,158,11,0.15); color: #fbbf24; }
  .cycle-tag.convergence-tag { background: rgba(239,68,68,0.2); color: #f87171; }
  .cycle-note { font-size: 12px; color: var(--text-secondary); margin-top: 3px; line-height: 1.4; }
  .cycle-from { font-size: 10px; color: var(--text-muted); }

  .pivot-table { width: 100%; font-size: 12px; border-collapse: collapse; margin: 12px 0; }
  .pivot-table th { text-align: left; padding: 6px 10px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); border-bottom: 1px solid var(--border); }
  .pivot-table td { padding: 6px 10px; border-bottom: 1px solid rgba(42,53,80,0.4); font-family: 'JetBrains Mono', monospace; font-size: 12px; }
  .pivot-high { color: var(--accent-green); }
  .pivot-low { color: var(--accent-red); }

  .cycle-summary-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin: 14px 0; }
  @media (max-width: 900px) { .cycle-summary-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 640px) { .cycle-summary-grid { grid-template-columns: 1fr 1fr; } }
  .cycle-stat-box { background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; text-align: center; }
  .cycle-stat-box .csb-value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .cycle-stat-box .csb-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-top: 2px; }

  /* ‚îÄ‚îÄ Array tabs & panels ‚îÄ‚îÄ */
  .array-tab { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted); padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'JetBrains Mono', monospace; letter-spacing: 0.5px; text-transform: uppercase; }
  .array-tab:hover { border-color: var(--accent-purple); color: var(--text-secondary); }
  .array-tab.active { background: rgba(139,92,246,0.15); border-color: var(--accent-purple); color: #a78bfa; }
  .array-panel { display: none; }
  .array-panel.active { display: block; }
  .array-header { margin-bottom: 8px; }
  .array-label { font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: #a78bfa; }
  .array-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .array-legend { display: flex; gap: 16px; margin-top: 8px; font-size: 11px; color: var(--text-muted); }
  .al-swatch { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; vertical-align: middle; }

  /* ‚îÄ‚îÄ Gann Analysis ‚îÄ‚îÄ */
  .gann-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media (max-width: 900px) { .gann-grid { grid-template-columns: 1fr; } }

  .sq9-wheel { position: relative; margin: 12px auto; width: 260px; height: 260px; }
  .sq9-ring { position: absolute; border-radius: 50%; border: 1px solid rgba(139,92,246,0.2); display: flex; align-items: center; justify-content: center; }
  .sq9-ring.active { border-color: var(--accent-purple); box-shadow: 0 0 12px rgba(139,92,246,0.3); }
  .sq9-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 700; color: var(--accent-amber); background: var(--bg-card); padding: 6px 10px; border-radius: 8px; border: 1px solid var(--accent-amber); z-index: 2; white-space: nowrap; }
  .sq9-level { position: absolute; font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 2px 6px; border-radius: 4px; white-space: nowrap; z-index: 1; }
  .sq9-level.support { color: #10b981; background: rgba(16,185,129,0.1); }
  .sq9-level.resistance { color: #ef4444; background: rgba(239,68,68,0.1); }
  .sq9-level.cardinal { font-weight: 700; border: 1px solid; }
  .sq9-level.cardinal.support { border-color: rgba(16,185,129,0.3); }
  .sq9-level.cardinal.resistance { border-color: rgba(239,68,68,0.3); }

  .gann-levels-table { width: 100%; font-size: 12px; border-collapse: collapse; }
  .gann-levels-table th { text-align: left; padding: 6px 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); border-bottom: 1px solid var(--border); }
  .gann-levels-table td { padding: 5px 8px; border-bottom: 1px solid rgba(42,53,80,0.3); font-family: 'JetBrains Mono', monospace; font-size: 11px; }

  .gann-angle-row { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 6px; }
  .gann-angle-name { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 700; min-width: 44px; }
  .gann-angle-bar { flex: 1; height: 8px; background: var(--bg-primary); border-radius: 4px; position: relative; overflow: visible; }
  .gann-angle-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
  .gann-angle-price { font-family: 'JetBrains Mono', monospace; font-size: 11px; min-width: 65px; text-align: right; }
  .gann-angle-marker { position: absolute; top: -4px; width: 3px; height: 16px; background: white; border-radius: 2px; box-shadow: 0 0 4px rgba(255,255,255,0.5); }

  .gann-retrace-bar { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .gann-retrace-label { font-size: 10px; color: var(--text-muted); min-width: 45px; text-align: right; font-family: 'JetBrains Mono', monospace; }
  .gann-retrace-track { flex: 1; height: 6px; background: var(--bg-primary); border-radius: 3px; position: relative; }
  .gann-retrace-fill { height: 100%; border-radius: 3px; }
  .gann-retrace-price { font-size: 11px; font-family: 'JetBrains Mono', monospace; min-width: 60px; }
  .gann-retrace-current { position: absolute; top: -5px; width: 2px; height: 16px; background: white; border-radius: 1px; box-shadow: 0 0 6px rgba(255,255,255,0.6); }

  .gann-seasonal { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin: 10px 0; }
  @media (max-width: 640px) { .gann-seasonal { grid-template-columns: repeat(2, 1fr); } }
  .gann-season-item { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; text-align: center; font-size: 11px; transition: all 0.3s; }
  .gann-season-item.near { border-color: var(--accent-amber); background: rgba(245,158,11,0.08); }
  .gann-season-item.imminent { border-color: var(--accent-red); background: rgba(239,68,68,0.1); animation: pulse 2s infinite; }
  .gann-season-date { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 12px; }
  .gann-season-name { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
  .gann-season-days { font-size: 10px; margin-top: 3px; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }

  /* ‚îÄ‚îÄ Gann Analysis ‚îÄ‚îÄ */
  .gann-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media (max-width: 900px) { .gann-grid { grid-template-columns: 1fr; } }

  .sq9-container { position: relative; }
  .sq9-levels { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .sq9-level { display: flex; justify-content: space-between; align-items: center; padding: 7px 12px; border-radius: 6px; font-size: 12px; font-family: 'JetBrains Mono', monospace; border: 1px solid var(--border); background: var(--bg-input); }
  .sq9-level.current { border-color: var(--accent-cyan); background: rgba(6,182,212,0.08); }
  .sq9-level.support { border-left: 3px solid var(--accent-green); }
  .sq9-level.resistance { border-left: 3px solid var(--accent-red); }
  .sq9-level .sq9-price { font-weight: 600; }
  .sq9-level .sq9-tag { font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; padding: 1px 5px; border-radius: 3px; }

  .gann-angle-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid rgba(42,53,80,0.4); font-size: 12px; }
  .gann-angle-row:last-child { border-bottom: none; }
  .gann-angle-name { font-family: 'JetBrains Mono', monospace; font-weight: 600; min-width: 50px; }
  .gann-angle-price { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
  .gann-angle-bar { flex: 1; height: 6px; border-radius: 3px; background: var(--bg-input); margin: 0 12px; position: relative; overflow: visible; }
  .gann-angle-fill { height: 100%; border-radius: 3px; transition: width 0.4s ease; }
  .gann-angle-marker { position: absolute; width: 2px; height: 14px; background: var(--accent-cyan); top: -4px; border-radius: 1px; }

  .gann-time-row { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid rgba(42,53,80,0.3); font-size: 12px; }
  .gann-time-row:last-child { border-bottom: none; }
  .gann-time-days { font-family: 'JetBrains Mono', monospace; font-weight: 600; min-width: 45px; color: var(--accent-amber); }
  .gann-time-date { font-family: 'JetBrains Mono', monospace; min-width: 100px; }
  .gann-time-from { font-size: 10px; color: var(--text-muted); flex: 1; }
  .gann-time-status { font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 3px; }

  .gann-seasonal { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  @media (max-width: 640px) { .gann-seasonal { grid-template-columns: 1fr 1fr; } }
  .gann-season-box { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; transition: all 0.3s; }
  .gann-season-box.approaching { border-color: var(--accent-amber); background: rgba(245,158,11,0.06); }
  .gann-season-box .gs-icon { font-size: 18px; }
  .gann-season-box .gs-name { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-top: 2px; }
  .gann-season-box .gs-date { font-size: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 600; margin-top: 2px; }
  .gann-season-box .gs-days { font-size: 10px; color: var(--text-muted); }

  .gann-retrace-container { position: relative; margin: 12px 0; }
  .gann-retrace-bar { position: relative; height: 220px; width: 40px; border-radius: 6px; background: linear-gradient(180deg, rgba(239,68,68,0.15) 0%, rgba(245,158,11,0.1) 50%, rgba(16,185,129,0.15) 100%); border: 1px solid var(--border); margin: 0 auto; }
  .gann-retrace-level { position: absolute; left: 50px; display: flex; align-items: center; gap: 8px; white-space: nowrap; }
  .gann-retrace-tick { position: absolute; left: -1px; width: 42px; height: 1px; }
  .gann-retrace-label { font-size: 11px; font-family: 'JetBrains Mono', monospace; }
  .gann-retrace-pct { font-size: 10px; color: var(--text-muted); }
  .gann-retrace-price-marker { position: absolute; left: -6px; width: 52px; height: 3px; background: var(--accent-cyan); border-radius: 2px; box-shadow: 0 0 8px rgba(6,182,212,0.5); }
  .score-56 { background: rgba(6,182,212,0.15); color: #06b6d4; }
  .score-34 { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .score-low { background: rgba(239,68,68,0.15); color: #ef4444; }
  .icon-red { background: rgba(239,68,68,0.15); }

  /* Tab navigation */
  .tab-nav {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px;
  }
  .tab-btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    border-radius: 9px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    background: transparent;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .tab-btn:hover { color: var(--text-secondary); }
  .tab-btn.active {
    background: var(--bg-card);
    color: var(--text-primary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }
</style>
</head>
<body>
<div class="app-container">

  <!-- Header -->
  <div class="header">
    <div class="header-badge">Live Analysis</div>
    <h1>OMOINV</h1>
    <p>Analyze stocks using the OMOINV trend template with live market data</p>
  </div>

  <!-- CORS Notice -->
  <div class="cors-notice">
    <strong>‚ÑπÔ∏è Data Fetching Info</strong>
    This tool automatically tries multiple CORS proxies to reach Yahoo Finance. If all proxies fail, you can:
    <ul>
      <li>Install a CORS extension (<strong>Chrome:</strong> Allow CORS ¬∑ <strong>Firefox:</strong> CORS Everywhere)</li>
      <li>Enter data manually in the Technical Data section below</li>
      <li>Open the <strong>"Show connection log"</strong> to see which proxies were attempted</li>
    </ul>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('analyzer')">üéØ Analyzer</button>
    <button class="tab-btn" onclick="switchTab('backtest')">üí∞ Backtest</button>
    <button class="tab-btn" onclick="switchTab('screener')">üîç Screener</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 1: ANALYZER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel active" id="tab-analyzer">

  <!-- Symbol Selection -->
  <div class="card">
    <div class="card-title">
      <div class="icon icon-blue">üéØ</div>
      Select Symbol &amp; Date
    </div>

    <label style="font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.8px; display:block; margin-bottom:8px;">Popular Symbols</label>
    <div class="symbol-chips" id="symbolChips">
      <div class="symbol-chip" data-sym="SPY" title="S&P 500 ETF">SPY</div>
      <div class="symbol-chip" data-sym="QQQ" title="Nasdaq 100 ETF">QQQ</div>
      <div class="symbol-chip" data-sym="AAPL" title="Apple Inc.">AAPL</div>
      <div class="symbol-chip" data-sym="TSLA" title="Tesla Inc.">TSLA</div>
      <div class="symbol-chip" data-sym="GOOGL" title="Alphabet Inc.">GOOGL</div>
      <div class="symbol-chip" data-sym="NVDA" title="NVIDIA Corp.">NVDA</div>
      <div class="symbol-chip" data-sym="MSFT" title="Microsoft Corp.">MSFT</div>
      <div class="symbol-chip" data-sym="AMZN" title="Amazon.com Inc.">AMZN</div>
      <div class="symbol-chip" data-sym="META" title="Meta Platforms">META</div>
    </div>

    <div class="form-row triple">
      <div class="form-group">
        <label>Custom Symbol</label>
        <input type="text" id="customSymbol" placeholder="e.g. CRK, ACMR‚Ä¶" spellcheck="false" autocomplete="off" style="text-transform:uppercase">
      </div>
      <div class="form-group">
        <label>Analysis Date (optional)</label>
        <input type="date" id="analysisDate">
      </div>
      <div class="form-group">
        <label>Data Range</label>
        <select id="dataRange" style="background:var(--bg-input); color:var(--text-primary); border:1px solid var(--border); border-radius:8px; padding:10px 12px; font-size:14px; width:100%;">
          <option value="1100">3 Years</option>
          <option value="1830">5 Years</option>
          <option value="3660" selected>10 Years</option>
          <option value="7320">20 Years</option>
          <option value="max">Max</option>
        </select>
      </div>
    </div>

    <button class="btn btn-primary" id="fetchBtn" onclick="fetchMarketData()">
      <span class="spinner"></span>
      <span class="btn-text">üìä Fetch Market Data</span>
    </button>

    <div class="status-bar" id="fetchStatus"></div>
    <details style="margin-top:8px;">
      <summary style="font-size:12px; color:var(--text-muted); cursor:pointer; user-select:none;">Show connection log</summary>
      <pre id="debugLog" style="background:var(--bg-input); border:1px solid var(--border); border-radius:8px; padding:12px; margin-top:6px; font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--text-muted); max-height:160px; overflow-y:auto; white-space:pre-wrap; word-break:break-all;"></pre>
    </details>
  </div>

  <div class="grid-2">

    <!-- Technical Data -->
    <div class="card">
      <div class="card-title">
        <div class="icon icon-purple">üìä</div>
        Technical Data
      </div>
      <p style="font-size:12px; color:var(--text-muted); margin-bottom:16px;">Auto-populated after fetch, or enter manually</p>

      <div class="form-group" style="margin-bottom:12px">
        <label>Current Close Price</label>
        <input type="number" step="0.01" id="currentPrice" placeholder="‚Äî">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>52-Week High</label>
          <input type="number" step="0.01" id="high52" placeholder="‚Äî">
        </div>
        <div class="form-group">
          <label>52-Week Low</label>
          <input type="number" step="0.01" id="low52" placeholder="‚Äî">
        </div>
      </div>
      <div class="form-row triple">
        <div class="form-group">
          <label>50-Day SMA</label>
          <input type="number" step="0.01" id="sma50" placeholder="‚Äî">
        </div>
        <div class="form-group">
          <label>150-Day SMA</label>
          <input type="number" step="0.01" id="sma150" placeholder="‚Äî">
        </div>
        <div class="form-group">
          <label>200-Day SMA</label>
          <input type="number" step="0.01" id="sma200" placeholder="‚Äî">
        </div>
      </div>
      <div class="form-group" style="margin-top:12px">
        <label>Relative Strength vs SPY</label>
        <input type="number" step="0.01" id="relStrength" placeholder="‚Äî">
      </div>

      <button class="btn btn-green" style="margin-top:20px" onclick="calculateOMO()">
        üî¢ Calculate OMOINV Score
      </button>
    </div>

    <!-- Score + Breadth -->
    <div>
      <!-- Score -->
      <div class="card">
        <div class="card-title">
          <div class="icon icon-green">‚úÖ</div>
          OMOINV Score
        </div>
        <div class="score-display" id="scoreDisplay">
          <div class="score-ring-container">
            <svg class="score-ring" viewBox="0 0 140 140">
              <circle class="score-ring-bg" cx="70" cy="70" r="65"/>
              <circle class="score-ring-fill" id="scoreRingFill" cx="70" cy="70" r="65"/>
            </svg>
            <div class="score-number">
              <span class="value" id="scoreValue">0/7</span>
              <span class="label">Criteria</span>
            </div>
          </div>
          <div class="score-verdict" id="scoreVerdict">‚Äî</div>
          <div class="score-subtitle" id="scoreSubtitle">Enter data and calculate to see results</div>
        </div>
        <div id="scoreEmpty" style="text-align:center; padding:40px 0; color:var(--text-muted); font-size:14px;">
          Fetch data and click Calculate to see score
        </div>
      </div>

      <!-- Market Breadth -->
      <div class="card">
        <div class="card-title">
          <div class="icon icon-cyan">üåê</div>
          Market Breadth
        </div>
        <div class="breadth-value" id="breadthValue">‚Äî %</div>
        <div class="breadth-meter">
          <div class="breadth-bar-track">
            <div class="breadth-bar-fill" id="breadthFill"></div>
          </div>
          <div class="breadth-labels">
            <span>0% Bearish</span>
            <span>50% Neutral</span>
            <span>100% Bullish</span>
          </div>
        </div>
        <div class="breadth-status" id="breadthStatus">Click "Fetch Market Data" to load breadth info</div>
      </div>
    </div>
  </div>

  <!-- Criteria Checklist -->
  <div class="card">
    <div class="card-title">
      <div class="icon icon-amber">üìã</div>
      OMOINV Trend Template Components
    </div>

    <div class="criteria-list" id="criteriaList">
      <div class="criteria-item" id="crit1">
        <div class="check-icon">‚Äî</div>
        <span class="criteria-text">Within 25% of 52-Week High</span>
        <span class="criteria-value" id="crit1val"></span>
      </div>
      <div class="criteria-item" id="crit2">
        <div class="check-icon">‚Äî</div>
        <span class="criteria-text">30% Above 52-Week Low</span>
        <span class="criteria-value" id="crit2val"></span>
      </div>
      <div class="criteria-item" id="crit3">
        <div class="check-icon">‚Äî</div>
        <span class="criteria-text">Above 50-Day SMA</span>
        <span class="criteria-value" id="crit3val"></span>
      </div>
      <div class="criteria-item" id="crit4">
        <div class="check-icon">‚Äî</div>
        <span class="criteria-text">Above 150-Day SMA</span>
        <span class="criteria-value" id="crit4val"></span>
      </div>
      <div class="criteria-item" id="crit5">
        <div class="check-icon">‚Äî</div>
        <span class="criteria-text">Above 200-Day SMA</span>
        <span class="criteria-value" id="crit5val"></span>
      </div>
      <div class="criteria-item" id="crit6">
        <div class="check-icon">‚Äî</div>
        <span class="criteria-text">SMA Alignment (50 &gt; 150 &gt; 200)</span>
        <span class="criteria-value" id="crit6val"></span>
      </div>
      <div class="criteria-item" id="crit7">
        <div class="check-icon">‚Äî</div>
        <span class="criteria-text">Relative Strength &gt; 1.0</span>
        <span class="criteria-value" id="crit7val"></span>
      </div>
    </div>
  </div>

  <!-- Analyst Commentary -->
  <div class="card commentary-card" id="commentaryCard">
    <div class="commentary-header">
      <div class="card-title" style="margin-bottom:0">
        <div class="icon icon-purple">üéôÔ∏è</div>
        Analyst Commentary
      </div>
      <div class="commentary-timestamp" id="commentaryTimestamp"></div>
    </div>
    <div class="commentary-body" id="commentaryBody">
    </div>
  </div>

  <!-- ‚ïê‚ïê Weinstein & Zweig Framework Analysis ‚ïê‚ïê -->
  <div class="framework-grid" id="frameworkGrid" style="display:none;">

    <!-- Stan Weinstein Stage Analysis -->
    <div class="card" id="weinsteinCard">
      <div class="card-title">
        <div class="icon" style="background:rgba(139,92,246,0.15); color:#8b5cf6;">üîÑ</div>
        Weinstein Stage Analysis
      </div>
      <div id="weinsteinBody">
        <div class="stage-diagram" id="stageDiagram">
          <div class="stage-box s1" id="stageBox1"><div class="stage-num">1</div><div class="stage-name">Basing</div></div>
          <div class="stage-box s2" id="stageBox2"><div class="stage-num">2</div><div class="stage-name">Advancing</div></div>
          <div class="stage-box s3" id="stageBox3"><div class="stage-num">3</div><div class="stage-name">Topping</div></div>
          <div class="stage-box s4" id="stageBox4"><div class="stage-num">4</div><div class="stage-name">Declining</div></div>
        </div>
        <div class="stage-detail-grid" id="weinsteinMetrics">
          <div class="stage-metric"><div class="metric-label">30-Week MA</div><div class="metric-value" id="wMA">‚Äî</div></div>
          <div class="stage-metric"><div class="metric-label">Price vs 30wk</div><div class="metric-value" id="wPriceVsMA">‚Äî</div></div>
          <div class="stage-metric"><div class="metric-label">MA Slope (4wk)</div><div class="metric-value" id="wSlope4">‚Äî</div></div>
          <div class="stage-metric"><div class="metric-label">MA Slope (12wk)</div><div class="metric-value" id="wSlope12">‚Äî</div></div>
          <div class="stage-metric"><div class="metric-label">Volume Trend</div><div class="metric-value" id="wVolume">‚Äî</div></div>
          <div class="stage-metric"><div class="metric-label">RS vs SPY</div><div class="metric-value" id="wRS">‚Äî</div></div>
        </div>
        <div class="framework-verdict neutral" id="weinsteinVerdict">
          <div class="fv-title">‚è≥ Fetch data to analyze</div>
        </div>
      </div>
    </div>

    <!-- Zweig Parameters -->
    <div class="card" id="zweigCard">
      <div class="card-title">
        <div class="icon" style="background:rgba(6,182,212,0.15); color:#06b6d4;">‚ö°</div>
        Zweig Breadth & Momentum
      </div>
      <div id="zweigBody">
        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Composite Score</div>
        <div class="zweig-gauge">
          <span style="font-size:12px; color:var(--accent-red); font-weight:600;">BEAR</span>
          <div class="zweig-gauge-bar">
            <div class="zweig-gauge-needle" id="zweigNeedle" style="left:50%;"></div>
          </div>
          <span style="font-size:12px; color:var(--accent-green); font-weight:600;">BULL</span>
        </div>
        <div class="zweig-gauge-labels"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div>

        <div class="zweig-params" id="zweigParams">
          <div class="zweig-param">
            <span class="zp-label">Breadth Thrust (NYSE)</span>
            <span class="zp-value" id="zBreadth">‚Äî</span>
            <span class="zp-signal zp-neutral" id="zBreadthSig">‚Äî</span>
          </div>
          <div class="zweig-param">
            <span class="zp-label">Price vs 50-Day MA</span>
            <span class="zp-value" id="zP50">‚Äî</span>
            <span class="zp-signal zp-neutral" id="zP50Sig">‚Äî</span>
          </div>
          <div class="zweig-param">
            <span class="zp-label">Price vs 200-Day MA</span>
            <span class="zp-value" id="zP200">‚Äî</span>
            <span class="zp-signal zp-neutral" id="zP200Sig">‚Äî</span>
          </div>
          <div class="zweig-param">
            <span class="zp-label">50/200 MA Cross</span>
            <span class="zp-value" id="zGolden">‚Äî</span>
            <span class="zp-signal zp-neutral" id="zGoldenSig">‚Äî</span>
          </div>
          <div class="zweig-param">
            <span class="zp-label">4-Week Momentum</span>
            <span class="zp-value" id="zMom4">‚Äî</span>
            <span class="zp-signal zp-neutral" id="zMom4Sig">‚Äî</span>
          </div>
          <div class="zweig-param">
            <span class="zp-label">12-Week Momentum</span>
            <span class="zp-value" id="zMom12">‚Äî</span>
            <span class="zp-signal zp-neutral" id="zMom12Sig">‚Äî</span>
          </div>
        </div>
        <div class="framework-verdict neutral" id="zweigVerdict">
          <div class="fv-title">‚è≥ Fetch data to analyze</div>
        </div>
      </div>
    </div>

  </div> <!-- end framework-grid -->

  <!-- ‚ïê‚ïê Gann Analysis ‚ïê‚ïê -->
  <div class="card commentary-card" id="gannCard" style="display:none;">
    <div class="card-title">
      <div class="icon" style="background:rgba(245,158,11,0.15); color:#fbbf24;">üìê</div>
      Gann Analysis <span style="font-size:12px; color:var(--text-muted); font-weight:400; margin-left:8px;">Square of 9 ¬∑ Angles ¬∑ Retracements ¬∑ Seasonal Dates</span>
    </div>

    <div class="gann-grid">

      <!-- Left: Square of 9 + Levels Table -->
      <div>
        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Square of 9 ‚Äî Price Levels</div>
        <div class="sq9-wheel" id="sq9Wheel"></div>
        <table class="gann-levels-table" id="sq9Table">
          <thead><tr><th>Level</th><th>Price</th><th>Type</th><th>Distance</th></tr></thead>
          <tbody id="sq9Body"></tbody>
        </table>
      </div>

      <!-- Right: Angles + Retracements -->
      <div>
        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Gann Angles from 52-Week Low</div>
        <div id="gannAnglesContainer"></div>

        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin:18px 0 8px;">Gann 1/8th Retracements</div>
        <div id="gannRetraceContainer"></div>
      </div>

    </div>

    <!-- Gann Seasonal Dates -->
    <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin:20px 0 8px;">Gann Seasonal Turn Dates <span style="text-transform:none; letter-spacing:0;">(next occurrence)</span></div>
    <div class="gann-seasonal" id="gannSeasonalGrid"></div>

    <!-- Gann Time Cycles -->
    <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin:18px 0 8px;">Gann Time Cycles from Major Pivots</div>
    <div style="height:180px; position:relative;"><canvas id="gannTimeCycleChart"></canvas></div>

    <div class="framework-verdict neutral" id="gannVerdict">
      <div class="fv-title">‚è≥ Analyzing Gann geometry‚Ä¶</div>
    </div>
  </div>

  <!-- Price Chart -->
  <div class="card">
    <div class="card-title">
      <div class="icon icon-blue">üìà</div>
      Price Chart <span id="priceChartRangeLabel" style="font-size:12px; color:var(--text-muted); font-weight:400; margin-left:8px;">(3-Year)</span>
    </div>
    <div class="chart-container" id="chartContainer">
      <div class="chart-placeholder" id="chartPlaceholder">
        <div class="ph-icon">üìâ</div>
        <div>Fetch data to render price chart with SMA overlays</div>
      </div>
      <canvas id="priceChart" style="display:none"></canvas>
    </div>
  </div>

  <!-- Historical OMOINV Score Chart -->
  <div class="card commentary-card" id="histChartCard">
    <div class="card-title">
      <div class="icon icon-amber">üìä</div>
      Historical OMOINV Score <span id="histChartRangeLabel" style="font-size:12px; color:var(--text-muted); font-weight:400; margin-left:8px;">(Monthly)</span>
    </div>
    <div class="chart-container" style="height:280px;">
      <canvas id="histChart"></canvas>
    </div>
    <div class="hist-legend" id="histLegend" style="margin-top:12px;"></div>
  </div>

  <!-- Historical Commentary -->
  <div class="card commentary-card" id="histCommentaryCard">
    <div class="commentary-header">
      <div class="card-title" style="margin-bottom:0">
        <div class="icon icon-cyan">üìú</div>
        <span id="histAnalysisTitle">Historical Analysis</span>
      </div>
    </div>
    <div class="commentary-body" id="histCommentaryBody">
    </div>
  </div>

  <!-- ‚ïê‚ïê Cycle Analysis ‚ïê‚ïê -->
  <div class="card commentary-card" id="cycleCard" style="display:none;">
    <div class="card-title">
      <div class="icon" style="background:rgba(139,92,246,0.15); color:#a78bfa;">üåÄ</div>
      Cycle Arrays <span style="font-size:12px; color:var(--text-muted); font-weight:400; margin-left:8px;">Armstrong œÄ Harmonics ¬∑ Fibonacci Time Sequences</span>
    </div>

    <div class="cycle-summary-grid" id="cycleSummary"></div>

    <!-- Array Selector Tabs -->
    <div style="display:flex; gap:6px; margin:16px 0 8px;">
      <button class="array-tab active" onclick="switchArrayTab('weekly')" id="arrTabWeekly">Weekly</button>
      <button class="array-tab" onclick="switchArrayTab('monthly')" id="arrTabMonthly">Monthly</button>
      <button class="array-tab" onclick="switchArrayTab('quarterly')" id="arrTabQuarterly">Quarterly</button>
    </div>

    <!-- Weekly Array -->
    <div class="array-panel active" id="arrWeekly">
      <div class="array-header">
        <div class="array-label">WEEKLY TURNING POINT ARRAY</div>
        <div class="array-sub">Each bar = cycle convergence intensity for that week ¬∑ Higher = more cycles turning</div>
      </div>
      <div style="height:200px; position:relative;"><canvas id="arrayWeeklyChart"></canvas></div>
      <div class="array-legend">
        <span><span class="al-swatch" style="background:#a78bfa;"></span>Armstrong œÄ</span>
        <span><span class="al-swatch" style="background:#fbbf24;"></span>Fibonacci</span>
        <span><span class="al-swatch" style="background:#f87171;"></span>Convergence (both)</span>
      </div>
    </div>

    <!-- Monthly Array -->
    <div class="array-panel" id="arrMonthly">
      <div class="array-header">
        <div class="array-label">MONTHLY TURNING POINT ARRAY</div>
        <div class="array-sub">Each bar = aggregate cycle energy for that month ¬∑ Red markers = potential panic cycles</div>
      </div>
      <div style="height:200px; position:relative;"><canvas id="arrayMonthlyChart"></canvas></div>
      <div class="array-legend">
        <span><span class="al-swatch" style="background:#a78bfa;"></span>Armstrong œÄ</span>
        <span><span class="al-swatch" style="background:#fbbf24;"></span>Fibonacci</span>
        <span><span class="al-swatch" style="background:#f87171;"></span>Convergence (both)</span>
      </div>
    </div>

    <!-- Quarterly Array -->
    <div class="array-panel" id="arrQuarterly">
      <div class="array-header">
        <div class="array-label">QUARTERLY TURNING POINT ARRAY</div>
        <div class="array-sub">Longer-term cycle energy per quarter ¬∑ Highest bars mark major ECM inflection windows</div>
      </div>
      <div style="height:200px; position:relative;"><canvas id="arrayQuarterlyChart"></canvas></div>
      <div class="array-legend">
        <span><span class="al-swatch" style="background:#a78bfa;"></span>Armstrong œÄ</span>
        <span><span class="al-swatch" style="background:#fbbf24;"></span>Fibonacci</span>
        <span><span class="al-swatch" style="background:#f87171;"></span>Convergence (both)</span>
      </div>
    </div>

    <!-- Directional Array -->
    <div style="margin-top:18px;">
      <div class="array-header">
        <div class="array-label">DIRECTIONAL ARRAY</div>
        <div class="array-sub">Green = cycles projecting from lows (expect rally) ¬∑ Red = from highs (expect decline) ¬∑ Monthly view</div>
      </div>
      <div style="height:160px; position:relative;"><canvas id="arrayDirectionalChart"></canvas></div>
    </div>

    <!-- Volatility Array -->
    <div style="margin-top:18px;">
      <div class="array-header">
        <div class="array-label">VOLATILITY ARRAY</div>
        <div class="array-sub">Projected volatility intensity by month ¬∑ Multiple converging cycles = amplified moves</div>
      </div>
      <div style="height:140px; position:relative;"><canvas id="arrayVolatilityChart"></canvas></div>
    </div>

    <hr style="border-color:var(--border); margin:20px 0;">

    <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin:0 0 6px;">Detected Pivots</div>
    <div id="cyclePivots"></div>

    <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin:20px 0 6px;">Upcoming Cycle Dates <span style="text-transform:none; letter-spacing:0;">(next 12 months)</span></div>
    <div class="cycle-timeline" id="cycleTimeline"></div>

    <div class="framework-verdict neutral" id="cycleVerdict">
      <div class="fv-title">‚è≥ Analyzing cycles‚Ä¶</div>
    </div>
  </div>

  </div> <!-- end tab-analyzer -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 2: BACKTEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-backtest">
    <div class="card">
      <div class="card-title">
        <div class="icon icon-green">üí∞</div>
        OMOINV Backtest Engine
      </div>
      <p style="font-size:13px; color:var(--text-secondary); margin-bottom:16px;">Transition-based buy/sell signals: buys when OMOINV score <strong>rises from weakness to strength</strong>, sells when it <strong>drops from strength back to weakness</strong>. Default: buy on ‚â§4‚Üí7 transition, sell on 7‚Üí‚â§4 drop. Fetch a symbol on the Analyzer tab first.</p>

      <div class="backtest-config">
        <div class="form-group">
          <label>Starting Capital ($)</label>
          <input type="number" id="btCapital" value="10000" step="1000">
        </div>
        <div class="form-group">
          <label>BUY when score rises to ‚â•</label>
          <select id="btBuyTarget">
            <option value="7" selected>7/7 (Full Template)</option>
            <option value="6">6/7 (Near Template)</option>
            <option value="5">5/7 (Aggressive)</option>
          </select>
        </div>
        <div class="form-group">
          <label>‚Ä¶from prior score ‚â§</label>
          <select id="btBuyFrom">
            <option value="4" selected>4/7 (Standard)</option>
            <option value="5">5/7 (Moderate)</option>
            <option value="6">6/7 (Sensitive)</option>
          </select>
        </div>
        <div class="form-group">
          <label>SELL when score drops to ‚â§</label>
          <select id="btSellTarget">
            <option value="4" selected>4/7 (Standard)</option>
            <option value="5">5/7 (Tight)</option>
            <option value="3">3/7 (Loose)</option>
          </select>
        </div>
        <div class="form-group">
          <label>‚Ä¶from prior score ‚â•</label>
          <select id="btSellFrom">
            <option value="7" selected>7/7 (Full Template)</option>
            <option value="6">6/7 (Near Template)</option>
            <option value="5">5/7 (Any Uptrend)</option>
          </select>
        </div>
        <div class="form-group" style="flex:0">
          <label>&nbsp;</label>
          <button class="btn btn-green" style="white-space:nowrap" onclick="runBacktest()">‚ñ∂ Run Backtest</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="backtest-stats" id="btStats" style="display:none">
        <div class="stat-box">
          <div class="stat-label">Total Return</div>
          <div class="stat-value" id="btTotalReturn">‚Äî</div>
          <div class="stat-sub" id="btTotalDollar">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Buy &amp; Hold Return</div>
          <div class="stat-value" id="btBuyHold">‚Äî</div>
          <div class="stat-sub" id="btBuyHoldDollar">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Alpha vs B&amp;H</div>
          <div class="stat-value" id="btAlpha">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Trades</div>
          <div class="stat-value" id="btTradeCount">‚Äî</div>
          <div class="stat-sub" id="btWinRate">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Best Trade</div>
          <div class="stat-value" id="btBestTrade">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Worst Trade</div>
          <div class="stat-value" id="btWorstTrade">‚Äî</div>
        </div>
      </div>

      <!-- Equity Curve Chart -->
      <div style="height:260px; margin-bottom:20px;">
        <canvas id="equityChart"></canvas>
      </div>

      <!-- Trade Log -->
      <div class="trade-table-wrap" id="btTableWrap" style="display:none">
        <table class="trade-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Signal</th>
              <th>Date</th>
              <th>Price</th>
              <th>Transition</th>
              <th>Shares</th>
              <th>P&amp;L ($)</th>
              <th>P&amp;L (%)</th>
              <th>Equity</th>
            </tr>
          </thead>
          <tbody id="btTableBody"></tbody>
        </table>
      </div>

      <div id="btEmpty" style="text-align:center; padding:40px 0; color:var(--text-muted); font-size:14px;">
        Fetch data on the Analyzer tab first, then run backtest here
      </div>
    </div>

    <!-- Backtest Commentary -->
    <div class="card" id="btCommentaryCard" style="display:none">
      <div class="card-title">
        <div class="icon icon-purple">üéôÔ∏è</div>
        Backtest Analysis
      </div>
      <div class="commentary-body" id="btCommentary"></div>
    </div>
  </div> <!-- end tab-backtest -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 3: SCREENER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-screener">
    <div class="card">
      <div class="card-title">
        <div class="icon icon-cyan">üîç</div>
        OMOINV Stock Screener
      </div>
      <p style="font-size:13px; color:var(--text-secondary); margin-bottom:16px;">Scan multiple symbols against OMOINV's 7 trend criteria. Symbols ranked by OMOINV score.</p>

      <label style="font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.8px; display:block; margin-bottom:8px;">Quick Lists</label>
      <div class="screener-presets">
        <button class="screener-preset" onclick="setScreenerList('dow30')" style="border-color:rgba(59,130,246,0.3); color:var(--accent-blue)">üèõÔ∏è Dow 30</button>
        <button class="screener-preset" onclick="setScreenerList('ndx100')" style="border-color:rgba(6,182,212,0.3); color:var(--accent-cyan)">üíª Nasdaq 100</button>
        <button class="screener-preset" onclick="setScreenerList('sp500')" style="border-color:rgba(139,92,246,0.3); color:var(--accent-purple)">üìä S&amp;P 500</button>
        <button class="screener-preset" onclick="setScreenerList('tech')">Tech Leaders</button>
        <button class="screener-preset" onclick="setScreenerList('energy')">Energy</button>
        <button class="screener-preset" onclick="setScreenerList('finance')">Financials</button>
        <button class="screener-preset" onclick="setScreenerList('health')">Healthcare</button>
        <button class="screener-preset" onclick="setScreenerList('etf')">Major ETFs</button>
      </div>
      <div id="screenerEstimate" style="font-size:11px; color:var(--text-muted); margin-bottom:12px; font-family:'JetBrains Mono',monospace;"></div>

      <div class="screener-input-area">
        <div class="form-group">
          <label>Symbols (comma-separated)</label>
          <input type="text" id="screenerSymbols" placeholder="AAPL, MSFT, NVDA, TSLA, AMZN‚Ä¶" style="text-transform:uppercase" spellcheck="false">
        </div>
        <div class="form-group" style="flex:0">
          <label>&nbsp;</label>
          <button class="btn btn-primary" style="white-space:nowrap" onclick="runScreener()">
            <span class="spinner" id="screenerSpinner"></span>
            <span class="btn-text">üîç Scan Symbols</span>
          </button>
        </div>
      </div>

      <div class="screener-progress" id="screenerProgress">
        <div class="screener-progress-text" id="screenerProgressText">Scanning‚Ä¶</div>
        <div class="screener-progress-bar">
          <div class="screener-progress-fill" id="screenerProgressFill"></div>
        </div>
      </div>

      <!-- Results -->
      <div class="screener-table-wrap" id="screenerResults" style="display:none">
        <table class="screener-table" id="screenerTable">
          <thead>
            <tr>
              <th onclick="sortScreener('rank')">#</th>
              <th onclick="sortScreener('symbol')">Symbol</th>
              <th onclick="sortScreener('name')">Name</th>
              <th onclick="sortScreener('score')">OMOINV Score ‚ñæ</th>
              <th onclick="sortScreener('price')">Price</th>
              <th onclick="sortScreener('fromHigh')">From 52w High</th>
              <th onclick="sortScreener('aboveLow')">Above 52w Low</th>
              <th onclick="sortScreener('smaAlign')">SMA Aligned</th>
              <th onclick="sortScreener('rs')">Rel. Strength</th>
              <th onclick="sortScreener('verdict')">Verdict</th>
            </tr>
          </thead>
          <tbody id="screenerBody"></tbody>
        </table>
      </div>

      <div id="screenerEmpty" style="text-align:center; padding:40px 0; color:var(--text-muted); font-size:14px;">
        Enter symbols above and click Scan to screen stocks
      </div>
    </div>
  </div> <!-- end tab-screener -->

  <div class="footer">OMOINV Calculator ¬∑ Data via Yahoo Finance</div>
</div>

<script>
  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  let chartInstance = null;
  let histChartInstance = null;
  let activeSymbol = '';
  let priceHistory = [];
  let spyHistory = [];
  let historicalOMO = [];
  // ‚îÄ‚îÄ Symbol chips ‚îÄ‚îÄ
  document.querySelectorAll('.symbol-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('.symbol-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      document.getElementById('customSymbol').value = chip.dataset.sym;
      activeSymbol = chip.dataset.sym;
    });
  });

  document.getElementById('customSymbol').addEventListener('input', e => {
    e.target.value = e.target.value.toUpperCase();
    document.querySelectorAll('.symbol-chip').forEach(c => c.classList.remove('active'));
    const match = document.querySelector(`.symbol-chip[data-sym="${e.target.value}"]`);
    if (match) match.classList.add('active');
    activeSymbol = e.target.value;
  });

  function getSymbol() {
    return document.getElementById('customSymbol').value.trim().toUpperCase() || activeSymbol;
  }

  function showStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className = 'status-bar visible ' + (type || '');
  }

  // ‚îÄ‚îÄ Debug logger ‚îÄ‚îÄ
  function debugLog(msg) {
    const el = document.getElementById('debugLog');
    if (el) {
      const ts = new Date().toLocaleTimeString();
      el.textContent += `[${ts}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }
    console.log(msg);
  }

  // ‚îÄ‚îÄ CORS proxy helpers ‚îÄ‚îÄ
  // Note: Cannot use AbortController in iframe-sandboxed environments
  // (AbortSignal fails postMessage cloning), so we use a race-based timeout.
  function fetchWithTimeout(url, ms = 15000) {
    return Promise.race([
      fetch(url, { headers: { 'Accept': 'application/json' } }),
      new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))
    ]);
  }

  async function fetchWithProxy(rawUrl) {
    const attempts = [
      { name: 'corsproxy.io', url: `https://corsproxy.io/?url=${encodeURIComponent(rawUrl)}` },
      { name: 'allorigins (raw)', url: `https://api.allorigins.win/raw?url=${encodeURIComponent(rawUrl)}` },
      { name: 'allorigins (get)', url: `https://api.allorigins.win/get?url=${encodeURIComponent(rawUrl)}`, wrapped: true },
      { name: 'direct', url: rawUrl },
    ];

    const errors = [];
    for (const attempt of attempts) {
      try {
        debugLog(`Trying ${attempt.name}‚Ä¶`);
        const res = await fetchWithTimeout(attempt.url, 15000);
        if (!res.ok) {
          debugLog(`  ‚úó ${attempt.name}: HTTP ${res.status} ${res.statusText}`);
          errors.push(`${attempt.name}: HTTP ${res.status}`);
          continue;
        }
        const text = await res.text();
        let data;
        if (attempt.wrapped) {
          const wrapper = JSON.parse(text);
          data = JSON.parse(wrapper.contents);
        } else {
          data = JSON.parse(text);
        }
        debugLog(`  ‚úì ${attempt.name}: success (${text.length} bytes)`);
        return data;
      } catch (e) {
        debugLog(`  ‚úó ${attempt.name}: ${e.message}`);
        errors.push(`${attempt.name}: ${e.message}`);
        continue;
      }
    }
    throw new Error(`All proxies failed. Open "Show connection log" for details.`);
  }

  // ‚îÄ‚îÄ Yahoo Finance URL builder ‚îÄ‚îÄ
  function getDataRangeDays() {
    const val = document.getElementById('dataRange').value;
    if (val === 'max') return 'max';
    return parseInt(val);
  }

  function yahooChartUrl(symbol, daysOverride) {
    const period2 = Math.floor(Date.now() / 1000);
    const days = daysOverride !== undefined ? daysOverride : getDataRangeDays();
    const period1 = days === 'max' ? 0 : period2 - 86400 * days;
    return `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?period1=${period1}&period2=${period2}&interval=1d&includePrePost=false`;
  }

  // ‚îÄ‚îÄ Fetch from Yahoo Finance ‚îÄ‚îÄ
  async function fetchMarketData() {
    const symbol = getSymbol();
    if (!symbol) { showStatus('fetchStatus', '‚úó Please select or enter a symbol', 'error'); return; }

    const btn = document.getElementById('fetchBtn');
    btn.classList.add('loading');
    btn.disabled = true;
    showStatus('fetchStatus', `‚è≥ Fetching ${symbol} ‚Äî trying multiple data sources‚Ä¶`, '');
    document.getElementById('debugLog').textContent = '';

    try {
      const json = await fetchWithProxy(yahooChartUrl(symbol));
      const result = json.chart?.result?.[0];
      if (!result || !result.timestamp) throw new Error('Invalid data ‚Äî check the ticker symbol');

      const timestamps = result.timestamp;
      const quote = result.indicators.quote[0];
      const closes = quote.close;
      const volumes = quote.volume;

      priceHistory = [];
      for (let i = 0; i < timestamps.length; i++) {
        if (closes[i] != null) {
          priceHistory.push({ date: new Date(timestamps[i] * 1000), close: closes[i], volume: volumes[i] || 0 });
        }
      }

      if (priceHistory.length < 50) {
        throw new Error(`Only ${priceHistory.length} data points ‚Äî need at least 50 for analysis`);
      }

      const current = priceHistory[priceHistory.length - 1].close;
      // Use last 252 trading days (~1 year) for current 52-week stats
      const oneYearSlice = priceHistory.slice(-252);
      const high52 = Math.max(...oneYearSlice.map(p => p.close));
      const low52 = Math.min(...oneYearSlice.map(p => p.close));

      const sma = (n) => {
        const slice = priceHistory.slice(-n);
        return slice.reduce((s, p) => s + p.close, 0) / slice.length;
      };

      setField('currentPrice', current);
      setField('high52', high52);
      setField('low52', low52);
      if (priceHistory.length >= 50) setField('sma50', sma(50));
      if (priceHistory.length >= 150) setField('sma150', sma(150));
      if (priceHistory.length >= 200) setField('sma200', sma(200));

      // Relative strength vs SPY (also stores spyHistory globally)
      showStatus('fetchStatus', `‚è≥ Fetching SPY data for relative strength & historical analysis‚Ä¶`, '');
      await fetchRelativeStrength(symbol);

      // Market breadth
      showStatus('fetchStatus', `‚è≥ Fetching market breadth‚Ä¶`, '');
      await fetchBreadth();

      // Compute historical OMOINV scores
      const rangeLabel = document.getElementById('dataRange').selectedOptions[0].text;
      showStatus('fetchStatus', `‚è≥ Computing ${rangeLabel} historical OMOINV scores‚Ä¶`, '');
      document.getElementById('histChartRangeLabel').textContent = `(${rangeLabel} Monthly)`;
      document.getElementById('histAnalysisTitle').textContent = `${rangeLabel} Historical Analysis`;
      document.getElementById('priceChartRangeLabel').textContent = `(${rangeLabel})`;
      computeHistoricalOMO();

      // Framework analysis
      analyzeWeinstein(symbol);
      analyzeZweig(symbol);
      analyzeGann(symbol);
      document.getElementById('frameworkGrid').style.display = 'grid';

      // Cycle analysis
      analyzeCycles(symbol);

      // Charts
      renderChart(symbol);
      renderHistoricalChart(symbol);

      const warn = priceHistory.length < 200 ? ` (‚ö† ${priceHistory.length} days ‚Äî 200 needed for full SMA set)` : '';
      showStatus('fetchStatus', `‚úì ${symbol} loaded ‚Äî ${priceHistory.length} trading days (${(priceHistory.length / 252).toFixed(1)} yrs)${warn}`, 'success');

    } catch (err) {
      showStatus('fetchStatus', `‚úó ${err.message}`, 'error');
      console.error(err);
    } finally {
      btn.classList.remove('loading');
      btn.disabled = false;
    }
  }

  async function fetchRelativeStrength(symbol) {
    try {
      if (symbol.toUpperCase() === 'SPY') {
        setField('relStrength', 1.0);
        spyHistory = priceHistory.map(p => ({ date: p.date, close: p.close }));
        return;
      }
      const json = await fetchWithProxy(yahooChartUrl('SPY'));
      const spyResult = json.chart.result[0];
      const spyTs = spyResult.timestamp;
      const spyCloses = spyResult.indicators.quote[0].close;
      spyHistory = [];
      for (let i = 0; i < spyTs.length; i++) {
        if (spyCloses[i] != null) {
          spyHistory.push({ date: new Date(spyTs[i] * 1000), close: spyCloses[i] });
        }
      }
      const halfLen = Math.min(Math.floor(spyHistory.length / 2), Math.floor(priceHistory.length / 2));
      if (halfLen < 10) return;
      const stockRet = priceHistory[priceHistory.length - 1].close / priceHistory[priceHistory.length - 1 - halfLen].close;
      const spyRet = spyHistory[spyHistory.length - 1].close / spyHistory[spyHistory.length - 1 - halfLen].close;
      setField('relStrength', stockRet / spyRet);
    } catch (e) { console.warn('RS calc failed:', e); }
  }

  async function fetchBreadth() {
    try {
      const json = await fetchWithProxy(yahooChartUrl('^NYA', 10));
      const closes = json.chart.result[0].indicators.quote[0].close.filter(c => c != null);
      if (closes.length < 2) { updateBreadth(null); return; }
      let ups = 0;
      for (let i = 1; i < closes.length; i++) { if (closes[i] > closes[i - 1]) ups++; }
      updateBreadth(Math.round((ups / (closes.length - 1)) * 100));
    } catch (e) { updateBreadth(null); }
  }

  function updateBreadth(pct) {
    const valEl = document.getElementById('breadthValue');
    const fillEl = document.getElementById('breadthFill');
    const statusEl = document.getElementById('breadthStatus');

    if (pct == null) {
      valEl.textContent = '‚Äî %';
      fillEl.style.width = '0%';
      statusEl.textContent = 'Breadth data unavailable';
      return;
    }

    valEl.textContent = pct + '%';
    valEl.style.color = pct >= 60 ? 'var(--accent-green)' : pct <= 40 ? 'var(--accent-red)' : 'var(--accent-amber)';
    fillEl.style.width = pct + '%';
    fillEl.style.background = pct >= 60
      ? 'linear-gradient(90deg, #10b981, #34d399)'
      : pct <= 40
        ? 'linear-gradient(90deg, #ef4444, #f87171)'
        : 'linear-gradient(90deg, #f59e0b, #fbbf24)';

    if (pct >= 60) statusEl.innerHTML = 'üü¢ <strong>Favorable</strong> ‚Äî Broad market participation';
    else if (pct <= 40) statusEl.innerHTML = 'üî¥ <strong>Caution</strong> ‚Äî Narrow market breadth';
    else statusEl.innerHTML = 'üü° <strong>Neutral</strong> ‚Äî Mixed breadth signals';
  }

  function setField(id, val) {
    const el = document.getElementById(id);
    el.value = parseFloat(val).toFixed(2);
    el.classList.add('populated');
  }

  // ‚îÄ‚îÄ Calculate OMOINV ‚îÄ‚îÄ
  function calculateOMO() {
    const price = parseFloat(document.getElementById('currentPrice').value);
    const h52 = parseFloat(document.getElementById('high52').value);
    const l52 = parseFloat(document.getElementById('low52').value);
    const s50 = parseFloat(document.getElementById('sma50').value);
    const s150 = parseFloat(document.getElementById('sma150').value);
    const s200 = parseFloat(document.getElementById('sma200').value);
    const rs = parseFloat(document.getElementById('relStrength').value);

    if ([price, h52, l52, s50, s150, s200].some(isNaN)) {
      showStatus('fetchStatus', '‚úó Please fill in all technical data fields', 'error');
      return;
    }

    let score = 0;

    const pctFromHigh = ((h52 - price) / h52) * 100;
    const c1 = pctFromHigh <= 25;
    setCriteria(1, c1, `${pctFromHigh.toFixed(1)}% from high`);
    if (c1) score++;

    const pctAboveLow = ((price - l52) / l52) * 100;
    const c2 = pctAboveLow >= 30;
    setCriteria(2, c2, `${pctAboveLow.toFixed(1)}% above low`);
    if (c2) score++;

    const c3 = price > s50;
    setCriteria(3, c3, `${((price / s50 - 1) * 100).toFixed(1)}%`);
    if (c3) score++;

    const c4 = price > s150;
    setCriteria(4, c4, `${((price / s150 - 1) * 100).toFixed(1)}%`);
    if (c4) score++;

    const c5 = price > s200;
    setCriteria(5, c5, `${((price / s200 - 1) * 100).toFixed(1)}%`);
    if (c5) score++;

    const c6 = s50 > s150 && s150 > s200;
    setCriteria(6, c6, c6 ? 'Aligned' : 'Misaligned');
    if (c6) score++;

    const c7 = !isNaN(rs) && rs > 1.0;
    setCriteria(7, c7, isNaN(rs) ? 'N/A' : rs.toFixed(2));
    if (c7) score++;

    displayScore(score, {
      symbol: getSymbol(),
      price, h52, l52, s50, s150, s200, rs,
      pctFromHigh, pctAboveLow,
      c1, c2, c3, c4, c5, c6, c7,
      pctAbove50: ((price / s50 - 1) * 100),
      pctAbove150: ((price / s150 - 1) * 100),
      pctAbove200: ((price / s200 - 1) * 100),
    });
  }

  function setCriteria(n, pass, val) {
    const item = document.getElementById(`crit${n}`);
    const valEl = document.getElementById(`crit${n}val`);
    item.className = `criteria-item ${pass ? 'pass' : 'fail'}`;
    item.querySelector('.check-icon').textContent = pass ? '‚úì' : '‚úó';
    valEl.textContent = val;
  }

  function displayScore(score, data) {
    document.getElementById('scoreEmpty').style.display = 'none';
    const display = document.getElementById('scoreDisplay');
    display.classList.add('visible');

    document.getElementById('scoreValue').textContent = `${score}/7`;

    const ring = document.getElementById('scoreRingFill');
    const circumference = 2 * Math.PI * 65;
    const offset = circumference - (score / 7) * circumference;
    ring.style.strokeDasharray = circumference;
    ring.style.strokeDashoffset = circumference;
    requestAnimationFrame(() => {
      ring.style.strokeDashoffset = offset;
    });

    let color, verdict, subtitle;
    if (score === 7) {
      color = 'var(--accent-green)';
      verdict = 'üü¢ STRONG BUY CANDIDATE';
      subtitle = 'All OMOINV criteria satisfied ‚Äî stock is in a confirmed Stage 2 uptrend';
    } else if (score >= 5) {
      color = 'var(--accent-cyan)';
      verdict = 'üîµ WATCHLIST CANDIDATE';
      subtitle = `${score}/7 criteria met ‚Äî nearing trend template qualification`;
    } else if (score >= 3) {
      color = 'var(--accent-amber)';
      verdict = 'üü° NEUTRAL';
      subtitle = `${score}/7 criteria met ‚Äî not yet in a confirmed uptrend`;
    } else {
      color = 'var(--accent-red)';
      verdict = 'üî¥ AVOID';
      subtitle = `Only ${score}/7 criteria met ‚Äî does not pass the trend template`;
    }

    ring.style.stroke = color;
    document.getElementById('scoreValue').style.color = color;
    document.getElementById('scoreVerdict').textContent = verdict;
    document.getElementById('scoreVerdict').style.color = color;
    document.getElementById('scoreSubtitle').textContent = subtitle;

    // Generate commentary
    generateCommentary(score, data);
    generateHistoricalCommentary(data.symbol);
  }

  // ‚îÄ‚îÄ Analyst Commentary Generator ‚îÄ‚îÄ
  function generateCommentary(score, d) {
    const card = document.getElementById('commentaryCard');
    const body = document.getElementById('commentaryBody');
    const tsEl = document.getElementById('commentaryTimestamp');

    const sym = d.symbol || '‚Äî';
    const now = new Date();
    tsEl.textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) + ' ¬∑ ' + now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

    let html = '';

    // ‚îÄ‚îÄ VERDICT ‚îÄ‚îÄ
    html += `<div class="section-label verdict-label">Overall Verdict</div>`;
    if (score === 7) {
      html += `<p><strong>${sym}</strong> passes all seven OMOINV criteria with a perfect <span class="highlight-green">7/7 score</span>. This stock is exhibiting textbook Stage 2 uptrend characteristics ‚Äî the kind of setup the methodology identifies as having the highest probability of producing outsized gains. Price is trading well above all key moving averages, the moving average stack is properly aligned in bullish order, and relative strength confirms institutional sponsorship. This is the profile of a leading stock.</p>`;
    } else if (score >= 5) {
      html += `<p><strong>${sym}</strong> scores <span class="highlight-blue">${score}/7</span> on the Trend Template ‚Äî close to full qualification but not there yet. The stock is showing emerging trend strength and warrants a place on the watchlist. Monitor for the failing criteria to flip positive, which could signal a breakout entry opportunity.</p>`;
    } else if (score >= 3) {
      html += `<p><strong>${sym}</strong> scores a mediocre <span class="highlight-amber">${score}/7</span> on the Trend Template. The stock shows some positive characteristics but is not in a confirmed uptrend. The risk/reward is unfavorable for trend-following entries. Wait for the trend to develop further.</p>`;
    } else {
      html += `<p><strong>${sym}</strong> scores a weak <span class="highlight-red">${score}/7</span> on the Trend Template. This stock does not exhibit leading uptrend characteristics and should be avoided for long-side trend-following strategies. The structure suggests Stage 3 distribution or Stage 4 decline.</p>`;
    }

    // ‚îÄ‚îÄ PRICE POSITION ‚îÄ‚îÄ
    html += `<hr class="commentary-divider">`;
    html += `<div class="section-label trend-label">Price Position Analysis</div>`;

    const fromHighStr = d.pctFromHigh.toFixed(1);
    const aboveLowStr = d.pctAboveLow.toFixed(1);

    // 52-week high proximity
    if (d.c1) {
      if (d.pctFromHigh <= 5) {
        html += `<p>The stock is trading just <span class="highlight-green">${fromHighStr}%</span> below its 52-week high of $${d.h52.toFixed(2)} ‚Äî effectively at highs. Stocks making new highs tend to make more new highs. This tight proximity signals strong demand and institutional accumulation. A breakout above $${d.h52.toFixed(2)} on volume would be particularly constructive.</p>`;
      } else if (d.pctFromHigh <= 15) {
        html += `<p>At <span class="highlight-green">${fromHighStr}%</span> below the 52-week high of $${d.h52.toFixed(2)}, the stock is within striking distance of new highs. This positioning is favorable ‚Äî it suggests the stock has been consolidating gains rather than giving them back. Watch for a tightening pattern near the highs as a potential launchpad.</p>`;
      } else {
        html += `<p>The stock sits <span class="highlight-blue">${fromHighStr}%</span> below its 52-week high of $${d.h52.toFixed(2)}. While it technically passes the 25% threshold, it still has meaningful ground to recover. The further from highs, the more overhead supply (trapped buyers) the stock will need to absorb on any rally attempt.</p>`;
      }
    } else {
      html += `<p>At <span class="highlight-red">${fromHighStr}%</span> below the 52-week high of $${d.h52.toFixed(2)}, the stock fails the proximity-to-highs criterion. The template requires stocks to be within 25% of their annual peak. This distance suggests significant distribution has occurred and the stock is no longer in a leadership position. Considerable overhead resistance exists above current levels.</p>`;
    }

    // 52-week low distance
    if (d.c2) {
      if (d.pctAboveLow >= 100) {
        html += `<p>Price is a substantial <span class="highlight-green">${aboveLowStr}%</span> above the 52-week low of $${d.l52.toFixed(2)} ‚Äî well exceeding the 30% minimum. This magnitude of advance from the lows indicates powerful underlying demand and confirms a meaningful trend reversal has occurred. The stock has clearly separated from its base.</p>`;
      } else {
        html += `<p>Price trades <span class="highlight-green">${aboveLowStr}%</span> above the 52-week low of $${d.l52.toFixed(2)}, clearing the 30% threshold. This confirms the stock has made a decisive move off the lows and is not simply bouncing within a downtrend. The further above the low, the stronger the underlying demand conviction.</p>`;
      }
    } else {
      html += `<p>The stock is only <span class="highlight-red">${aboveLowStr}%</span> above its 52-week low of $${d.l52.toFixed(2)}, falling short of the required 30% minimum. This lack of upside separation from the lows is a red flag ‚Äî the stock has not yet demonstrated the kind of power move that characterizes institutional accumulation. It may still be base-building or, worse, in a downtrend with temporary relief rallies.</p>`;
    }

    // ‚îÄ‚îÄ MOVING AVERAGE ANALYSIS ‚îÄ‚îÄ
    html += `<hr class="commentary-divider">`;
    html += `<div class="section-label strength-label">Moving Average Structure</div>`;

    const above50 = d.pctAbove50.toFixed(1);
    const above150 = d.pctAbove150.toFixed(1);
    const above200 = d.pctAbove200.toFixed(1);

    // Individual MA commentary
    let maPassCount = [d.c3, d.c4, d.c5].filter(Boolean).length;

    if (maPassCount === 3 && d.c6) {
      html += `<p>The moving average structure is <span class="highlight-green">fully bullish</span>. Price at $${d.price.toFixed(2)} trades above all three key moving averages ‚Äî the 50-day SMA ($${d.s50.toFixed(2)}, +${above50}%), the 150-day SMA ($${d.s150.toFixed(2)}, +${above150}%), and the 200-day SMA ($${d.s200.toFixed(2)}, +${above200}%). Furthermore, the SMAs are stacked in proper ascending order (50 > 150 > 200), confirming that the short-, medium-, and long-term trends are all aligned bullishly. This is the optimal configuration ‚Äî The methodology emphasizes that the best breakouts occur when this alignment is firmly in place.</p>`;
    } else if (maPassCount === 3 && !d.c6) {
      html += `<p>Price trades above all three key moving averages, which is positive. However, the SMA stack is <span class="highlight-amber">not properly aligned</span> ‚Äî the ideal order is 50-day > 150-day > 200-day, reflecting accelerating momentum at each time frame. Currently: 50-day at $${d.s50.toFixed(2)}, 150-day at $${d.s150.toFixed(2)}, 200-day at $${d.s200.toFixed(2)}. This misalignment often occurs during the early stages of a trend reversal when the shorter moving averages haven't yet crossed above the longer ones. It may resolve with continued price strength ‚Äî a bullish crossover of the 50 above the 150 (a "golden cross" setup) would be a constructive development to monitor.</p>`;
    } else if (maPassCount >= 1) {
      let aboveList = [];
      let belowList = [];
      if (d.c3) aboveList.push(`50-day ($${d.s50.toFixed(2)})`); else belowList.push(`50-day ($${d.s50.toFixed(2)})`);
      if (d.c4) aboveList.push(`150-day ($${d.s150.toFixed(2)})`); else belowList.push(`150-day ($${d.s150.toFixed(2)})`);
      if (d.c5) aboveList.push(`200-day ($${d.s200.toFixed(2)})`); else belowList.push(`200-day ($${d.s200.toFixed(2)})`);
      html += `<p>The moving average picture is <span class="highlight-amber">mixed</span>. Price at $${d.price.toFixed(2)} trades above the ${aboveList.join(' and ')} but remains below the ${belowList.join(' and ')}. `;
      if (!d.c3) {
        html += `Trading below the 50-day SMA is particularly concerning for short-term momentum ‚Äî it means the stock has been underperforming its own recent average price, suggesting sellers have been in control of the near-term action. `;
      }
      if (!d.c5) {
        html += `Being below the 200-day SMA is a classic indicator that the long-term trend remains bearish. Institutional investors widely watch the 200-day as a line of demarcation between bullish and bearish conditions. `;
      }
      html += `The SMA alignment criterion also ${d.c6 ? 'passes' : 'fails'}, further ${d.c6 ? 'supporting' : 'weakening'} the trend profile.</p>`;
    } else {
      html += `<p>The moving average structure is <span class="highlight-red">completely bearish</span>. Price at $${d.price.toFixed(2)} trades below all three key moving averages ‚Äî the 50-day ($${d.s50.toFixed(2)}), 150-day ($${d.s150.toFixed(2)}), and 200-day ($${d.s200.toFixed(2)}). This means the stock is underperforming at every time frame. Each of these moving averages now acts as potential overhead resistance. Until the stock can reclaim at least the 50-day SMA on strong volume, there is no technical basis for a trend-following long entry. The stock is likely in Stage 4 decline or Stage 1 bottoming.</p>`;
    }

    // ‚îÄ‚îÄ RELATIVE STRENGTH ‚îÄ‚îÄ
    html += `<hr class="commentary-divider">`;
    html += `<div class="section-label strength-label">Relative Strength</div>`;

    if (isNaN(d.rs)) {
      html += `<p>Relative strength data is unavailable. This metric compares the stock's performance against the S&P 500 over a trailing period. Without it, one dimension of the OMOINV analysis is incomplete. You can manually input an RS value if you have one from another source.</p>`;
    } else if (d.c7) {
      if (d.rs >= 1.5) {
        html += `<p>Relative strength versus the S&P 500 stands at a robust <span class="highlight-green">${d.rs.toFixed(2)}</span> ‚Äî significantly outperforming the broad market. This level of outperformance is a hallmark of institutional accumulation. When a stock substantially outperforms the index, it signals that large money is rotating in. The methodology stresses that relative strength is one of the most reliable indicators of future price performance ‚Äî strong stocks tend to get stronger.</p>`;
      } else {
        html += `<p>Relative strength versus the S&P 500 is <span class="highlight-green">${d.rs.toFixed(2)}</span>, clearing the 1.0 threshold. The stock is outperforming the broad market, which is constructive. Look for RS to be trending higher for the most conviction ‚Äî a stock that is accelerating its outperformance has the strongest odds of continuing its run.</p>`;
      }
    } else {
      html += `<p>Relative strength stands at <span class="highlight-red">${d.rs.toFixed(2)}</span> ‚Äî below 1.0, meaning the stock is <em>underperforming</em> the S&P 500. The template explicitly requires market outperformance as a qualification criterion. A stock lagging the index suggests institutional money is flowing elsewhere. Even if other technical criteria look acceptable, weak relative strength is often a leading indicator that the trend is exhausting or that the stock will continue to lag.</p>`;
    }

    // ‚îÄ‚îÄ RISK & ACTIONABLE ‚îÄ‚îÄ
    html += `<hr class="commentary-divider">`;
    html += `<div class="section-label action-label">Risk Assessment & Actionable Takeaway</div>`;

    if (score === 7) {
      html += `<p>With a perfect template score, the primary risk is <strong>buying extended</strong> ‚Äî entering too far above a proper pivot or base. Ideal entries occur on constructive pullbacks to the rising 10-day or 21-day EMA, or on a breakout from a volatility contraction pattern (VCP) near the 52-week high. Set a stop-loss below the most recent swing low or the 50-day SMA (whichever is tighter) to define risk. Position size should be calibrated so that a stop-out represents no more than 1-2% portfolio risk per OMOINV money management rules.</p>`;
      html += `<p><strong>Bottom line:</strong> <span class="highlight-green">${sym} is a qualified Stage 2 leader.</span> Look for a proper low-risk entry point ‚Äî a tight flag, high-tight flag, or VCP setup ‚Äî rather than chasing price. The trend template confirms the stock is in the right position; now wait for the right price action to trigger an entry.</p>`;
    } else if (score >= 5) {
      html += `<p>The stock is close to full qualification. The key question is whether the failing criteria are <em>improving</em> or <em>deteriorating</em>. `;
      const failing = [];
      if (!d.c1) failing.push('proximity to 52-week high');
      if (!d.c2) failing.push('distance from 52-week low');
      if (!d.c3) failing.push('price vs. 50-day SMA');
      if (!d.c4) failing.push('price vs. 150-day SMA');
      if (!d.c5) failing.push('price vs. 200-day SMA');
      if (!d.c6) failing.push('SMA alignment');
      if (!d.c7 || isNaN(d.rs)) failing.push('relative strength');
      html += `Specifically, watch for improvement in: <strong>${failing.join(', ')}</strong>. If these begin trending toward passing, the stock could become a full-template candidate on the next constructive move.</p>`;
      html += `<p><strong>Bottom line:</strong> <span class="highlight-blue">Add ${sym} to a focused watchlist.</span> Set alerts at key levels that would trigger the remaining criteria to pass. Do not initiate a full position until the template is complete ‚Äî partial compliance introduces unnecessary risk.</p>`;
    } else if (score >= 3) {
      html += `<p>At ${score}/7, the stock has too many structural weaknesses for a high-conviction trend-following entry. The risk of a false start or failed breakout is elevated when multiple criteria are unmet. Capital deployed here has a lower expected return compared to stocks scoring 6/7 or 7/7. Opportunity cost matters ‚Äî there are likely better-positioned names elsewhere in the market.</p>`;
      html += `<p><strong>Bottom line:</strong> <span class="highlight-amber">${sym} is not actionable at this time.</span> Check back periodically ‚Äî market conditions and trend structure can evolve. If the stock is building a multi-month base, it may eventually meet all criteria as it emerges. Patience is a form of edge in the OMOINV methodology.</p>`;
    } else {
      html += `<p>The stock is far from meeting OMOINV criteria and represents a high-risk proposition for trend followers. The overwhelming majority of big stock market winners emerge from Stage 2 uptrends ‚Äî not from stocks that fail the trend template this decisively. Attempting to bottom-fish or catch a reversal here violates the core principles of the methodology.</p>`;
      html += `<p><strong>Bottom line:</strong> <span class="highlight-red">${sym} should be avoided for trend-following strategies.</span> If you have an existing long position, consider whether your original thesis remains intact and whether the deteriorating trend template warrants reducing exposure or tightening stop-losses.</p>`;
    }

    // ‚îÄ‚îÄ DISCLAIMER ‚îÄ‚îÄ
    html += `<hr class="commentary-divider">`;
    html += `<p style="font-size:11px; color:var(--text-muted); font-style:italic;">This commentary is generated algorithmically based on OMOINV methodology and is intended for educational and research purposes only. It does not constitute financial advice. Always conduct your own due diligence and consult a qualified financial advisor before making investment decisions.</p>`;

    body.innerHTML = html;
    card.classList.add('visible');
    card.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ Stan Weinstein Stage Analysis ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function analyzeWeinstein(symbol) {
    const n = priceHistory.length;
    if (n < 200) return;

    const price = priceHistory[n - 1].close;

    // 30-week MA ‚âà 150 trading days
    const ma150 = (offset = 0) => {
      const end = n - offset;
      const start = end - 150;
      if (start < 0) return null;
      let sum = 0;
      for (let i = start; i < end; i++) sum += priceHistory[i].close;
      return sum / 150;
    };

    const currentMA = ma150(0);
    const ma4wAgo = ma150(20);   // 4 weeks ago
    const ma12wAgo = ma150(60);  // 12 weeks ago
    const ma26wAgo = ma150(130); // 26 weeks ago

    // Slopes
    const slope4w = ma4wAgo ? ((currentMA - ma4wAgo) / ma4wAgo) * 100 : 0;
    const slope12w = ma12wAgo ? ((currentMA - ma12wAgo) / ma12wAgo) * 100 : 0;
    const slope26w = ma26wAgo ? ((currentMA - ma26wAgo) / ma26wAgo) * 100 : 0;

    // Price position relative to MA
    const pricePctAboveMA = ((price - currentMA) / currentMA) * 100;

    // Volume analysis: recent 20 days vs prior 50 days
    const recentVol = priceHistory.slice(-20).reduce((s, p) => s + p.volume, 0) / 20;
    const priorVol = priceHistory.slice(-70, -20).reduce((s, p) => s + p.volume, 0) / 50;
    const volRatio = priorVol > 0 ? recentVol / priorVol : 1;

    // RS vs SPY
    const rs = parseFloat(document.getElementById('relStrength').value) || null;

    // ‚îÄ‚îÄ Stage Determination ‚îÄ‚îÄ
    let stage, subPhase, confidence;
    const aboveMA = price > currentMA;
    const maRising = slope4w > 0.3;
    const maFalling = slope4w < -0.3;
    const maFlat = !maRising && !maFalling;
    const maTrendUp = slope12w > 0.5;
    const maTrendDown = slope12w < -0.5;

    if (aboveMA && maRising && maTrendUp) {
      stage = 2;
      if (pricePctAboveMA > 15 && slope4w < slope12w) {
        subPhase = 'Late Stage 2 ‚Äî extended above MA, momentum fading';
        confidence = 'Moderate';
      } else if (pricePctAboveMA > 5) {
        subPhase = 'Mid Stage 2 ‚Äî confirmed uptrend, strong momentum';
        confidence = 'High';
      } else {
        subPhase = 'Early Stage 2 ‚Äî breakout above rising 30-week MA';
        confidence = 'High';
      }
    } else if (aboveMA && maFlat) {
      // Could be late Stage 1 or early Stage 3
      if (slope26w < -0.5) {
        stage = 1;
        subPhase = 'Late Stage 1 ‚Äî basing above flattening MA after decline';
        confidence = 'Moderate';
      } else if (slope26w > 1) {
        stage = 3;
        subPhase = 'Early Stage 3 ‚Äî MA flattening after prolonged advance';
        confidence = 'Moderate';
      } else {
        stage = 1;
        subPhase = 'Stage 1 ‚Äî consolidation with flat MA, waiting for direction';
        confidence = 'Low';
      }
    } else if (aboveMA && maFalling) {
      stage = 4;
      subPhase = 'Counter-trend rally ‚Äî price above declining MA (likely temporary)';
      confidence = 'Low';
    } else if (!aboveMA && maRising) {
      stage = 2;
      subPhase = 'Stage 2 pullback ‚Äî price dipped below still-rising MA';
      confidence = 'Moderate';
    } else if (!aboveMA && maFlat) {
      if (slope26w > 0.5) {
        stage = 3;
        subPhase = 'Stage 3 distribution ‚Äî price below flattening MA after uptrend';
        confidence = 'Moderate';
      } else {
        stage = 1;
        subPhase = 'Stage 1 basing ‚Äî price near flat MA, building a base';
        confidence = 'Moderate';
      }
    } else if (!aboveMA && maFalling) {
      stage = 4;
      if (slope12w < -2) {
        subPhase = 'Stage 4 accelerating decline ‚Äî strong downtrend';
        confidence = 'High';
      } else {
        subPhase = 'Stage 4 decline ‚Äî price below falling 30-week MA';
        confidence = 'High';
      }
    } else {
      stage = 1;
      subPhase = 'Indeterminate ‚Äî mixed signals, likely transitioning';
      confidence = 'Low';
    }

    // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
    // Stage diagram
    for (let i = 1; i <= 4; i++) {
      document.getElementById(`stageBox${i}`).classList.toggle('active', i === stage);
    }

    // Metrics
    document.getElementById('wMA').textContent = `$${currentMA.toFixed(2)}`;
    document.getElementById('wMA').style.color = 'var(--text-primary)';

    const pvEl = document.getElementById('wPriceVsMA');
    pvEl.textContent = `${pricePctAboveMA >= 0 ? '+' : ''}${pricePctAboveMA.toFixed(1)}%`;
    pvEl.style.color = pricePctAboveMA >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

    const s4El = document.getElementById('wSlope4');
    s4El.textContent = `${slope4w >= 0 ? '+' : ''}${slope4w.toFixed(2)}%`;
    s4El.style.color = slope4w > 0.3 ? 'var(--accent-green)' : slope4w < -0.3 ? 'var(--accent-red)' : 'var(--accent-amber)';

    const s12El = document.getElementById('wSlope12');
    s12El.textContent = `${slope12w >= 0 ? '+' : ''}${slope12w.toFixed(2)}%`;
    s12El.style.color = slope12w > 0.5 ? 'var(--accent-green)' : slope12w < -0.5 ? 'var(--accent-red)' : 'var(--accent-amber)';

    const volEl = document.getElementById('wVolume');
    if (volRatio > 1.2) { volEl.textContent = `‚Üë ${((volRatio - 1) * 100).toFixed(0)}% above avg`; volEl.style.color = 'var(--accent-cyan)'; }
    else if (volRatio < 0.8) { volEl.textContent = `‚Üì ${((1 - volRatio) * 100).toFixed(0)}% below avg`; volEl.style.color = 'var(--accent-amber)'; }
    else { volEl.textContent = 'Normal'; volEl.style.color = 'var(--text-secondary)'; }

    const rsEl = document.getElementById('wRS');
    if (rs) { rsEl.textContent = rs.toFixed(2); rsEl.style.color = rs > 1 ? 'var(--accent-green)' : 'var(--accent-red)'; }
    else { rsEl.textContent = '‚Äî'; rsEl.style.color = 'var(--text-muted)'; }

    // Verdict
    const vEl = document.getElementById('weinsteinVerdict');
    const stageColors = { 1: 'neutral', 2: 'bullish', 3: 'neutral', 4: 'bearish' };
    const stageEmoji = { 1: '‚è∏Ô∏è', 2: 'üöÄ', 3: '‚ö†Ô∏è', 4: 'üìâ' };
    const stageAction = {
      1: `<strong>${symbol}</strong> is in <strong>Stage 1 (Basing/Accumulation)</strong>. Weinstein advises patience ‚Äî do not buy yet. Watch for the stock to break above the flattening 30-week MA on expanding volume. That breakout signals the transition to Stage 2 and the optimal entry point.`,
      2: `<strong>${symbol}</strong> is in <strong>Stage 2 (Advancing)</strong>. This is the <em>only stage</em> Weinstein recommends buying. The stock is above a rising 30-week MA ‚Äî the trend is your friend. ${subPhase.includes('pullback') ? 'The current pullback to the MA may offer a buying opportunity if the MA continues rising.' : subPhase.includes('Late') ? 'However, the advance is extended ‚Äî tighten stops and reduce new buying. Watch for the MA to start flattening, which signals Stage 3 transition.' : 'Look for constructive pullbacks to the rising MA as entry opportunities. Trail stops below the 30-week MA.'}`,
      3: `<strong>${symbol}</strong> is in <strong>Stage 3 (Topping/Distribution)</strong>. Weinstein warns this is the most dangerous stage for longs. The 30-week MA is flattening after a prior advance. Smart money is distributing shares. Do not initiate new long positions. If holding, tighten stops aggressively ‚Äî a break below the flattening MA confirms Stage 4 transition.`,
      4: `<strong>${symbol}</strong> is in <strong>Stage 4 (Declining)</strong>. Weinstein says never buy a Stage 4 stock regardless of how "cheap" it looks. The stock is below a falling 30-week MA ‚Äî the trend is down. ${subPhase.includes('accelerating') ? 'The decline is accelerating ‚Äî stay completely away.' : subPhase.includes('Counter') ? 'The bounce above the MA is likely temporary ‚Äî rallies in Stage 4 are selling opportunities, not buying opportunities.' : 'Wait for the MA to flatten and the stock to base (Stage 1) before re-evaluating.'}`
    };

    vEl.className = `framework-verdict ${stageColors[stage]}`;
    vEl.innerHTML = `<div class="fv-title">${stageEmoji[stage]} Stage ${stage} ‚Äî ${subPhase}</div>
      <div style="font-size:11px; color:var(--text-muted); margin-bottom:6px;">Confidence: <strong>${confidence}</strong></div>
      <div style="font-size:13px; line-height:1.6;">${stageAction[stage]}</div>`;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ Zweig Breadth & Momentum Parameters ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function analyzeZweig(symbol) {
    const n = priceHistory.length;
    if (n < 200) return;

    const price = priceHistory[n - 1].close;
    let totalScore = 0;
    let maxScore = 0;

    // Helper: SMA at offset from end
    const smaAt = (len, offset = 0) => {
      const end = n - offset;
      const start = end - len;
      if (start < 0) return null;
      let sum = 0;
      for (let i = start; i < end; i++) sum += priceHistory[i].close;
      return sum / len;
    };

    // ‚îÄ‚îÄ 1. Breadth Thrust (NYSE approximation) ‚îÄ‚îÄ
    // Use existing breadth data from the breadth widget
    const breadthText = document.getElementById('breadthValue')?.textContent;
    const breadthPct = breadthText ? parseInt(breadthText) : null;
    let breadthSignal, breadthVal;
    if (breadthPct !== null && !isNaN(breadthPct)) {
      breadthVal = breadthPct + '%';
      if (breadthPct >= 61.5) { breadthSignal = 'BULLISH'; totalScore += 2; }
      else if (breadthPct >= 50) { breadthSignal = 'NEUTRAL'; totalScore += 1; }
      else { breadthSignal = 'BEARISH'; }
      maxScore += 2;
    } else {
      breadthVal = '‚Äî';
      breadthSignal = 'N/A';
    }

    // ‚îÄ‚îÄ 2. Price vs 50-Day MA ‚îÄ‚îÄ
    const sma50 = smaAt(50);
    let p50Signal, p50Val;
    maxScore += 2;
    if (sma50) {
      const pct50 = ((price - sma50) / sma50) * 100;
      p50Val = `${pct50 >= 0 ? '+' : ''}${pct50.toFixed(1)}%`;
      if (pct50 > 2) { p50Signal = 'BULLISH'; totalScore += 2; }
      else if (pct50 > -2) { p50Signal = 'NEUTRAL'; totalScore += 1; }
      else { p50Signal = 'BEARISH'; }
    } else { p50Val = '‚Äî'; p50Signal = 'N/A'; maxScore -= 2; }

    // ‚îÄ‚îÄ 3. Price vs 200-Day MA ‚îÄ‚îÄ
    const sma200 = smaAt(200);
    let p200Signal, p200Val;
    maxScore += 2;
    if (sma200) {
      const pct200 = ((price - sma200) / sma200) * 100;
      p200Val = `${pct200 >= 0 ? '+' : ''}${pct200.toFixed(1)}%`;
      if (pct200 > 0) { p200Signal = 'BULLISH'; totalScore += 2; }
      else if (pct200 > -5) { p200Signal = 'NEUTRAL'; totalScore += 1; }
      else { p200Signal = 'BEARISH'; }
    } else { p200Val = '‚Äî'; p200Signal = 'N/A'; maxScore -= 2; }

    // ‚îÄ‚îÄ 4. 50/200 MA Cross (Golden/Death Cross) ‚îÄ‚îÄ
    let goldenSignal, goldenVal;
    maxScore += 2;
    if (sma50 && sma200) {
      const sma50prev = smaAt(50, 20);
      const sma200prev = smaAt(200, 20);
      if (sma50 > sma200) {
        goldenVal = 'Golden ‚úì';
        totalScore += 2;
        goldenSignal = 'BULLISH';
      } else if (sma50prev && sma50prev > sma200prev && sma50 < sma200) {
        goldenVal = 'Death ‚úó (recent)';
        goldenSignal = 'BEARISH';
      } else {
        goldenVal = 'Death ‚úó';
        goldenSignal = 'BEARISH';
      }
    } else { goldenVal = '‚Äî'; goldenSignal = 'N/A'; maxScore -= 2; }

    // ‚îÄ‚îÄ 5. 4-Week Momentum (ROC) ‚îÄ‚îÄ
    let mom4Signal, mom4Val;
    maxScore += 2;
    if (n >= 20) {
      const roc4 = ((price - priceHistory[n - 21].close) / priceHistory[n - 21].close) * 100;
      mom4Val = `${roc4 >= 0 ? '+' : ''}${roc4.toFixed(1)}%`;
      if (roc4 > 3) { mom4Signal = 'BULLISH'; totalScore += 2; }
      else if (roc4 > -3) { mom4Signal = 'NEUTRAL'; totalScore += 1; }
      else { mom4Signal = 'BEARISH'; }
    } else { mom4Val = '‚Äî'; mom4Signal = 'N/A'; maxScore -= 2; }

    // ‚îÄ‚îÄ 6. 12-Week Momentum (ROC) ‚îÄ‚îÄ
    let mom12Signal, mom12Val;
    maxScore += 2;
    if (n >= 60) {
      const roc12 = ((price - priceHistory[n - 61].close) / priceHistory[n - 61].close) * 100;
      mom12Val = `${roc12 >= 0 ? '+' : ''}${roc12.toFixed(1)}%`;
      if (roc12 > 5) { mom12Signal = 'BULLISH'; totalScore += 2; }
      else if (roc12 > -5) { mom12Signal = 'NEUTRAL'; totalScore += 1; }
      else { mom12Signal = 'BEARISH'; }
    } else { mom12Val = '‚Äî'; mom12Signal = 'N/A'; maxScore -= 2; }

    // ‚îÄ‚îÄ Composite ‚îÄ‚îÄ
    const composite = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 50;

    // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
    const sigClass = (s) => s === 'BULLISH' ? 'zp-bull' : s === 'BEARISH' ? 'zp-bear' : 'zp-neutral';

    const setParam = (id, val, sig) => {
      document.getElementById(id).textContent = val;
      document.getElementById(id).style.color = sig === 'BULLISH' ? 'var(--accent-green)' : sig === 'BEARISH' ? 'var(--accent-red)' : 'var(--text-secondary)';
      const sigEl = document.getElementById(id + 'Sig');
      sigEl.textContent = sig;
      sigEl.className = `zp-signal ${sigClass(sig)}`;
    };

    setParam('zBreadth', breadthVal, breadthSignal);
    setParam('zP50', p50Val, p50Signal);
    setParam('zP200', p200Val, p200Signal);
    setParam('zGolden', goldenVal, goldenSignal);
    setParam('zMom4', mom4Val, mom4Signal);
    setParam('zMom12', mom12Val, mom12Signal);

    // Gauge needle
    document.getElementById('zweigNeedle').style.left = `${Math.max(2, Math.min(98, composite))}%`;

    // Verdict
    const vEl = document.getElementById('zweigVerdict');
    let verdictClass, verdictEmoji, verdictTitle, verdictBody;

    const bullCount = [breadthSignal, p50Signal, p200Signal, goldenSignal, mom4Signal, mom12Signal].filter(s => s === 'BULLISH').length;
    const bearCount = [breadthSignal, p50Signal, p200Signal, goldenSignal, mom4Signal, mom12Signal].filter(s => s === 'BEARISH').length;

    if (composite >= 75) {
      verdictClass = 'bullish';
      verdictEmoji = 'üü¢';
      verdictTitle = `Zweig Composite: ${composite}/100 ‚Äî Strongly Bullish`;
      verdictBody = `<strong>${symbol}</strong> shows ${bullCount} of 6 Zweig parameters bullish. Zweig's philosophy ‚Äî "Don't fight the tape" ‚Äî strongly favors the long side here. The stock has positive momentum across multiple timeframes, trades above key moving averages, and market breadth supports risk-on positioning. This environment has historically produced the best returns for trend followers. The Zweig model aligns with the OMOINV approach: <strong>this is a buy-side setup</strong>.`;
    } else if (composite >= 55) {
      verdictClass = 'bullish';
      verdictEmoji = 'üîµ';
      verdictTitle = `Zweig Composite: ${composite}/100 ‚Äî Moderately Bullish`;
      verdictBody = `<strong>${symbol}</strong> shows ${bullCount} bullish and ${bearCount} bearish Zweig parameters. The weight of evidence tilts positive but isn't overwhelming. Zweig would say the tape is "okay but not great." Selective buying is warranted, but position sizes should be moderate and stops tight. Watch for the lagging parameters to improve ‚Äî if they do, conviction can increase.`;
    } else if (composite >= 40) {
      verdictClass = 'neutral';
      verdictEmoji = 'üü°';
      verdictTitle = `Zweig Composite: ${composite}/100 ‚Äî Neutral / Mixed`;
      verdictBody = `<strong>${symbol}</strong> shows conflicting signals across Zweig's parameters: ${bullCount} bullish, ${bearCount} bearish. Zweig's rule ‚Äî "When in doubt, stay out" ‚Äî applies here. The momentum picture is ambiguous, which typically produces choppy price action and false signals. Reduce exposure and wait for the parameters to align more clearly before committing capital.`;
    } else if (composite >= 25) {
      verdictClass = 'bearish';
      verdictEmoji = 'üü†';
      verdictTitle = `Zweig Composite: ${composite}/100 ‚Äî Moderately Bearish`;
      verdictBody = `<strong>${symbol}</strong> shows ${bearCount} of 6 parameters bearish. Zweig's "Don't fight the tape" principle warns against buying into deteriorating momentum. The stock is likely in a downtrend or losing its uptrend structure. Avoid new long positions. If holding, tighten stops significantly. This environment favors capital preservation over capital appreciation.`;
    } else {
      verdictClass = 'bearish';
      verdictEmoji = 'üî¥';
      verdictTitle = `Zweig Composite: ${composite}/100 ‚Äî Strongly Bearish`;
      verdictBody = `<strong>${symbol}</strong> shows ${bearCount} of 6 Zweig parameters bearish. The tape is decisively negative. Zweig would be fully defensive ‚Äî cash or short. The stock trades below major moving averages, momentum is negative across all timeframes, and the MA structure is bearish. Do not buy. This is a <strong>risk-off environment</strong> where preservation of capital takes absolute priority.`;
    }

    vEl.className = `framework-verdict ${verdictClass}`;
    vEl.innerHTML = `<div class="fv-title">${verdictEmoji} ${verdictTitle}</div>
      <div style="font-size:13px; line-height:1.6; margin-top:6px;">${verdictBody}</div>`;
  }


  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ Gann Analysis ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  let gannTimeCycleChart = null;

  function analyzeGann(symbol) {
    const n = priceHistory.length;
    if (n < 100) return;

    document.getElementById('gannCard').style.display = 'block';

    const price = priceHistory[n - 1].close;
    const yearSlice = priceHistory.slice(-252);
    const h52 = Math.max(...yearSlice.map(p => p.close));
    const l52 = Math.min(...yearSlice.map(p => p.close));
    const today = new Date();
    const MS_DAY = 86400000;

    // ‚ïê‚ïê 1. SQUARE OF 9 ‚ïê‚ïê
    // Calculate price levels using ‚àö price rotation
    function sq9Levels(basePrice, rotations) {
      const levels = [];
      const sqrtBase = Math.sqrt(basePrice);
      for (let i = -rotations; i <= rotations; i++) {
        if (i === 0) continue;
        // Each rotation = 2 on the ‚àö scale (360¬∞), cardinal = 0.5 (90¬∞)
        for (const frac of [0.25, 0.5, 0.75, 1.0]) {
          const sqrtLevel = sqrtBase + i * 2 * frac;
          if (sqrtLevel <= 0) continue;
          const lvl = sqrtLevel * sqrtLevel;
          const isCardinal = frac === 0.5 || frac === 1.0;
          const degrees = i * 360 * frac;
          const pctDist = ((lvl - price) / price) * 100;
          if (Math.abs(pctDist) <= 30) {
            levels.push({
              price: lvl,
              degrees: Math.abs(degrees),
              cardinal: isCardinal,
              type: lvl > price ? 'resistance' : 'support',
              pctDist,
              rotation: i,
              angle: frac * 360,
            });
          }
        }
      }
      levels.sort((a, b) => a.price - b.price);
      return levels;
    }

    const sq9 = sq9Levels(price, 3);

    // Render Square of 9 visual
    const wheelEl = document.getElementById('sq9Wheel');
    const centerX = 130, centerY = 130;
    let wheelHtml = '';

    // Draw concentric rings
    [120, 90, 60, 30].forEach(r => {
      wheelHtml += `<div class="sq9-ring" style="width:${r*2}px; height:${r*2}px; top:${centerY-r}px; left:${centerX-r}px;"></div>`;
    });

    // Center price
    wheelHtml += `<div class="sq9-center">$${price.toFixed(2)}</div>`;

    // Place levels around the wheel
    const nearestLevels = sq9.slice(0, 16);
    nearestLevels.forEach((lvl, idx) => {
      const dist = Math.abs(lvl.pctDist);
      const r = 30 + (dist / 30) * 90;
      // Spread levels around the circle based on angle
      const angle = (idx / nearestLevels.length) * 2 * Math.PI - Math.PI / 2;
      const x = centerX + r * Math.cos(angle) - 22;
      const y = centerY + r * Math.sin(angle) - 8;
      const cls = `sq9-level ${lvl.type}${lvl.cardinal ? ' cardinal' : ''}`;
      wheelHtml += `<div class="${cls}" style="left:${x}px; top:${y}px;">$${lvl.price.toFixed(2)}</div>`;
    });

    wheelEl.innerHTML = wheelHtml;

    // Levels table
    const tbody = document.getElementById('sq9Body');
    tbody.innerHTML = '';
    // Show nearest support levels (below price) and resistance levels (above)
    const supports = sq9.filter(l => l.type === 'support').sort((a, b) => b.price - a.price).slice(0, 5);
    const resistances = sq9.filter(l => l.type === 'resistance').sort((a, b) => a.price - b.price).slice(0, 5);
    const combined = [...supports.reverse(), ...resistances];

    combined.forEach(lvl => {
      const cls = lvl.type === 'support' ? 'pivot-high' : 'pivot-low';
      const typeLabel = lvl.type === 'support' ? 'üü¢ Support' : 'üî¥ Resistance';
      const cardLabel = lvl.cardinal ? ' ‚òÖ' : '';
      tbody.innerHTML += `<tr>
        <td>${lvl.degrees.toFixed(0)}¬∞${cardLabel}</td>
        <td class="${lvl.type === 'support' ? 'pivot-high' : 'pivot-low'}">$${lvl.price.toFixed(2)}</td>
        <td>${typeLabel}</td>
        <td>${lvl.pctDist >= 0 ? '+' : ''}${lvl.pctDist.toFixed(1)}%</td>
      </tr>`;
    });

    // ‚ïê‚ïê 2. GANN ANGLES ‚ïê‚ïê
    // From 52-week low, project angles: price/time ratios
    const lowIdx = yearSlice.reduce((mi, p, i) => p.close < yearSlice[mi].close ? i : mi, 0);
    const lowDate = yearSlice[lowIdx].date;
    const daysFromLow = Math.round((today - lowDate) / MS_DAY);

    const angles = [
      { name: '4√ó1', ratio: 4, desc: 'Steepest bull', color: '#10b981' },
      { name: '3√ó1', ratio: 3, desc: 'Strong bull', color: '#34d399' },
      { name: '2√ó1', ratio: 2, desc: 'Bull angle', color: '#6ee7b7' },
      { name: '1√ó1', ratio: 1, desc: '45¬∞ ‚Äî key angle', color: '#fbbf24' },
      { name: '1√ó2', ratio: 0.5, desc: 'Mild bull', color: '#f59e0b' },
      { name: '1√ó3', ratio: 1/3, desc: 'Weak', color: '#fb923c' },
      { name: '1√ó4', ratio: 0.25, desc: 'Very weak', color: '#ef4444' },
    ];

    // Calculate angle price targets
    // Gann angle: from low point, price should rise by (ratio √ó time_units)
    // Using cents per day as the unit scale based on price magnitude
    const priceScale = l52 < 10 ? 0.01 : l52 < 50 ? 0.05 : l52 < 200 ? 0.1 : l52 < 1000 ? 0.5 : 1.0;

    let anglesHtml = '';
    const maxAnglePrice = l52 + angles[0].ratio * daysFromLow * priceScale;
    const minAnglePrice = l52;
    const priceRange = maxAnglePrice - minAnglePrice || 1;

    angles.forEach(ang => {
      const anglePrice = l52 + ang.ratio * daysFromLow * priceScale;
      const pctFill = Math.max(0, Math.min(100, ((anglePrice - minAnglePrice) / priceRange) * 100));
      const currentPctFill = Math.max(0, Math.min(100, ((price - minAnglePrice) / priceRange) * 100));
      const aboveAngle = price > anglePrice;
      const priceColor = aboveAngle ? 'var(--accent-green)' : 'var(--accent-red)';

      anglesHtml += `<div class="gann-angle-row">
        <div class="gann-angle-name" style="color:${ang.color};">${ang.name}</div>
        <div style="flex:1;">
          <div class="gann-angle-bar">
            <div class="gann-angle-fill" style="width:${pctFill}%; background:${ang.color}; opacity:0.4;"></div>
            <div class="gann-angle-marker" style="left:${currentPctFill}%;"></div>
          </div>
          <div style="font-size:9px; color:var(--text-muted); margin-top:2px;">${ang.desc}</div>
        </div>
        <div class="gann-angle-price" style="color:${priceColor};">$${anglePrice.toFixed(2)}</div>
      </div>`;
    });

    document.getElementById('gannAnglesContainer').innerHTML = anglesHtml;

    // ‚ïê‚ïê 3. GANN RETRACEMENTS (1/8th divisions) ‚ïê‚ïê
    const range = h52 - l52;
    const retraces = [
      { frac: 0.875, label: '7/8', pct: '87.5%' },
      { frac: 0.75, label: '3/4', pct: '75.0%' },
      { frac: 0.625, label: '5/8', pct: '62.5%' },
      { frac: 0.5, label: '1/2', pct: '50.0%' },
      { frac: 0.375, label: '3/8', pct: '37.5%' },
      { frac: 0.25, label: '1/4', pct: '25.0%' },
      { frac: 0.125, label: '1/8', pct: '12.5%' },
    ];

    const currentFill = range > 0 ? ((price - l52) / range) * 100 : 50;
    let retraceHtml = '';

    // 52-week high label
    retraceHtml += `<div class="gann-retrace-bar"><div class="gann-retrace-label" style="color:var(--accent-red);">HIGH</div><div class="gann-retrace-track"><div class="gann-retrace-fill" style="width:100%; background:rgba(239,68,68,0.15);"></div><div class="gann-retrace-current" style="left:${Math.min(99, currentFill)}%;"></div></div><div class="gann-retrace-price" style="color:var(--accent-red);">$${h52.toFixed(2)}</div></div>`;

    retraces.forEach(r => {
      const lvl = l52 + range * r.frac;
      const isPriceNear = Math.abs(price - lvl) / price < 0.02;
      const fillPct = r.frac * 100;
      const barColor = r.frac === 0.5 ? 'rgba(251,191,36,0.5)' : r.frac === 0.25 || r.frac === 0.75 ? 'rgba(139,92,246,0.3)' : 'rgba(100,116,139,0.2)';
      const priceColor = price > lvl ? 'var(--accent-green)' : 'var(--accent-red)';

      retraceHtml += `<div class="gann-retrace-bar">
        <div class="gann-retrace-label">${r.pct}</div>
        <div class="gann-retrace-track">
          <div class="gann-retrace-fill" style="width:${fillPct}%; background:${barColor};"></div>
          <div class="gann-retrace-current" style="left:${Math.min(99, currentFill)}%;"></div>
        </div>
        <div class="gann-retrace-price" style="color:${priceColor}; ${isPriceNear ? 'font-weight:700; text-decoration:underline;' : ''}">$${lvl.toFixed(2)}</div>
      </div>`;
    });

    // 52-week low label
    retraceHtml += `<div class="gann-retrace-bar"><div class="gann-retrace-label" style="color:var(--accent-green);">LOW</div><div class="gann-retrace-track"><div class="gann-retrace-fill" style="width:0%; background:rgba(16,185,129,0.15);"></div><div class="gann-retrace-current" style="left:${Math.min(99, currentFill)}%;"></div></div><div class="gann-retrace-price" style="color:var(--accent-green);">$${l52.toFixed(2)}</div></div>`;

    document.getElementById('gannRetraceContainer').innerHTML = retraceHtml;

    // ‚ïê‚ïê 4. GANN SEASONAL DATES ‚ïê‚ïê
    const year = today.getFullYear();
    const nextYear = year + 1;
    const seasonalDates = [
      { date: new Date(year, 0, 7), name: 'Jan 7 ‚Äî First rally top' },
      { date: new Date(year, 1, 4), name: 'Feb 4 ‚Äî Seasonal low' },
      { date: new Date(year, 2, 20), name: 'Mar 20 ‚Äî Spring equinox' },
      { date: new Date(year, 3, 6), name: 'Apr 6 ‚Äî Easter cycle' },
      { date: new Date(year, 4, 3), name: 'May 3 ‚Äî Secondary high' },
      { date: new Date(year, 5, 9), name: 'Jun 9 ‚Äî Mid-year pivot' },
      { date: new Date(year, 5, 21), name: 'Jun 21 ‚Äî Summer solstice' },
      { date: new Date(year, 6, 7), name: 'Jul 7 ‚Äî Mid-summer turn' },
      { date: new Date(year, 7, 8), name: 'Aug 8 ‚Äî Late summer low' },
      { date: new Date(year, 8, 22), name: 'Sep 22 ‚Äî Fall equinox' },
      { date: new Date(year, 9, 7), name: 'Oct 7 ‚Äî Panic zone' },
      { date: new Date(year, 10, 5), name: 'Nov 5 ‚Äî Election cycle' },
      { date: new Date(year, 11, 21), name: 'Dec 21 ‚Äî Winter solstice' },
      { date: new Date(year, 11, 24), name: 'Dec 24 ‚Äî Year-end pivot' },
      // Next year
      { date: new Date(nextYear, 0, 7), name: 'Jan 7 ‚Äî First rally top' },
      { date: new Date(nextYear, 1, 4), name: 'Feb 4 ‚Äî Seasonal low' },
      { date: new Date(nextYear, 2, 20), name: 'Mar 20 ‚Äî Spring equinox' },
      { date: new Date(nextYear, 3, 6), name: 'Apr 6 ‚Äî Easter cycle' },
      { date: new Date(nextYear, 4, 3), name: 'May 3 ‚Äî Secondary high' },
      { date: new Date(nextYear, 5, 9), name: 'Jun 9 ‚Äî Mid-year pivot' },
    ];

    // Filter to upcoming dates
    const upcoming = seasonalDates.filter(s => s.date >= today).slice(0, 8);
    let seasonHtml = '';
    upcoming.forEach(s => {
      const days = Math.round((s.date - today) / MS_DAY);
      const cls = days <= 7 ? 'imminent' : days <= 30 ? 'near' : '';
      const daysStr = days === 0 ? 'TODAY' : days === 1 ? 'Tomorrow' : `${days}d away`;
      const daysColor = days <= 7 ? 'color:var(--accent-red); font-weight:700;' : days <= 30 ? 'color:var(--accent-amber);' : 'color:var(--text-muted);';
      seasonHtml += `<div class="gann-season-item ${cls}">
        <div class="gann-season-date">${s.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
        <div class="gann-season-name">${s.name.split('‚Äî')[1]?.trim() || s.name}</div>
        <div class="gann-season-days" style="${daysColor}">${daysStr}</div>
      </div>`;
    });
    document.getElementById('gannSeasonalGrid').innerHTML = seasonHtml;

    // ‚ïê‚ïê 5. GANN TIME CYCLES CHART ‚ïê‚ïê
    // Key Gann time intervals from major pivots
    const GANN_TIME = [30, 45, 60, 90, 120, 144, 180, 270, 360];

    // Detect pivots (reuse from priceHistory)
    const windowSize = n > 1000 ? 90 : n > 500 ? 60 : 40;
    const pivots = [];
    for (let i = windowSize; i < n - Math.min(windowSize, 5); i++) {
      const wL = priceHistory.slice(Math.max(0, i - windowSize), i);
      const wR = priceHistory.slice(i + 1, Math.min(n, i + windowSize + 1));
      const lMax = Math.max(...wL.map(p => p.close));
      const lMin = Math.min(...wL.map(p => p.close));
      const rMax = wR.length > 0 ? Math.max(...wR.map(p => p.close)) : priceHistory[i].close;
      const rMin = wR.length > 0 ? Math.min(...wR.map(p => p.close)) : priceHistory[i].close;
      if (priceHistory[i].close >= lMax && priceHistory[i].close >= rMax) pivots.push({ date: priceHistory[i].date, type: 'high' });
      if (priceHistory[i].close <= lMin && priceHistory[i].close <= rMin) pivots.push({ date: priceHistory[i].date, type: 'low' });
    }

    // Dedupe
    const dedupedPivots = [];
    for (const p of pivots) {
      if (!dedupedPivots.find(d => Math.abs(d.date - p.date) < 30 * MS_DAY && d.type === p.type)) dedupedPivots.push(p);
    }
    const topPivots = dedupedPivots.slice(-12);

    // Build monthly buckets for next 24 months
    const gannMonthly = [];
    for (let m = 0; m < 24; m++) {
      const mStart = new Date(today.getFullYear(), today.getMonth() + m, 1);
      const mEnd = new Date(today.getFullYear(), today.getMonth() + m + 1, 1);
      let totalWeight = 0;
      let count = 0;
      for (const pivot of topPivots) {
        for (const days of GANN_TIME) {
          const projDate = new Date(pivot.date.getTime() + days * MS_DAY);
          if (projDate >= mStart && projDate < mEnd) {
            totalWeight += days >= 180 ? 3 : days >= 90 ? 2 : 1;
            count++;
          }
          // Also project from multiples of key numbers
          if (days >= 90) {
            const proj2 = new Date(pivot.date.getTime() + days * 2 * MS_DAY);
            if (proj2 >= mStart && proj2 < mEnd) { totalWeight += 1; count++; }
          }
        }
      }
      gannMonthly.push({
        label: mStart.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
        weight: totalWeight, count,
      });
    }

    // Render time cycle chart
    if (gannTimeCycleChart) gannTimeCycleChart.destroy();
    const tcCtx = document.getElementById('gannTimeCycleChart').getContext('2d');
    const maxGW = Math.max(...gannMonthly.map(b => b.weight), 1);
    gannTimeCycleChart = new Chart(tcCtx, {
      type: 'bar',
      data: {
        labels: gannMonthly.map(b => b.label),
        datasets: [{
          label: 'Gann Time Cycles',
          data: gannMonthly.map(b => b.weight),
          backgroundColor: gannMonthly.map(b => {
            const pct = b.weight / maxGW;
            if (pct > 0.7) return 'rgba(245,158,11,0.8)';
            if (pct > 0.4) return 'rgba(139,92,246,0.6)';
            return 'rgba(100,116,139,0.3)';
          }),
          borderRadius: 3,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#64748b', font: { size: 9, family: 'JetBrains Mono' } }, grid: { color: 'rgba(42,53,80,0.3)' } },
          y: { ticks: { color: '#64748b', font: { size: 10, family: 'JetBrains Mono' } }, grid: { color: 'rgba(42,53,80,0.3)' },
            title: { display: true, text: 'GANN CYCLE ENERGY', color: '#64748b', font: { size: 9, family: 'JetBrains Mono', weight: '700' } } },
        }
      }
    });

    // ‚ïê‚ïê 6. VERDICT ‚ïê‚ïê
    const vEl = document.getElementById('gannVerdict');

    // Find nearest Sq9 support and resistance
    const nearestSupport = sq9.filter(l => l.type === 'support').sort((a, b) => b.price - a.price)[0];
    const nearestResistance = sq9.filter(l => l.type === 'resistance').sort((a, b) => a.price - b.price)[0];

    // Which Gann angle is price nearest?
    let nearestAngle = null;
    let minAngleDist = Infinity;
    angles.forEach(ang => {
      const anglePrice = l52 + ang.ratio * daysFromLow * priceScale;
      const dist = Math.abs(price - anglePrice);
      if (dist < minAngleDist) { minAngleDist = dist; nearestAngle = ang; }
    });

    // Retracement position
    const retracePct = range > 0 ? ((price - l52) / range) * 100 : 50;
    let retraceZone = '';
    if (retracePct >= 87.5) retraceZone = 'above the 7/8 retracement ‚Äî extreme strength';
    else if (retracePct >= 62.5) retraceZone = 'between the 5/8 and 7/8 levels ‚Äî bullish territory';
    else if (retracePct >= 37.5) retraceZone = 'near the critical 50% (1/2) Gann level ‚Äî key decision zone';
    else if (retracePct >= 12.5) retraceZone = 'between the 1/8 and 3/8 levels ‚Äî weak position';
    else retraceZone = 'below the 1/8 retracement ‚Äî extreme weakness';

    // Peak Gann time month
    const peakGann = gannMonthly.reduce((max, b) => b.weight > max.weight ? b : max, gannMonthly[0]);

    // Next seasonal date
    const nextSeasonal = upcoming[0];
    const daysSeasonal = nextSeasonal ? Math.round((nextSeasonal.date - today) / MS_DAY) : null;

    // Bullish/bearish bias
    const angleVal = l52 + (nearestAngle ? nearestAngle.ratio : 1) * daysFromLow * priceScale;
    const aboveKeyAngle = price > angleVal;
    const above50Pct = retracePct > 50;

    let vClass, vTitle, vBody;
    if (aboveKeyAngle && above50Pct) {
      vClass = 'bullish';
      vTitle = 'üìê Gann Geometry ‚Äî Bullish Configuration';
      vBody = `<strong>${symbol}</strong> at $${price.toFixed(2)} trades above the key ${nearestAngle.name} Gann angle ($${angleVal.toFixed(2)}) and sits ${retraceZone}. `;
    } else if (!aboveKeyAngle && !above50Pct) {
      vClass = 'bearish';
      vTitle = 'üìê Gann Geometry ‚Äî Bearish Configuration';
      vBody = `<strong>${symbol}</strong> at $${price.toFixed(2)} trades below the ${nearestAngle.name} Gann angle ($${angleVal.toFixed(2)}) and sits ${retraceZone}. `;
    } else {
      vClass = 'neutral';
      vTitle = 'üìê Gann Geometry ‚Äî Mixed Configuration';
      vBody = `<strong>${symbol}</strong> at $${price.toFixed(2)} shows mixed Gann signals ‚Äî ${aboveKeyAngle ? 'above' : 'below'} the ${nearestAngle.name} angle ($${angleVal.toFixed(2)}) and ${retraceZone}. `;
    }

    vBody += `Square of 9 defines nearest support at <span style="color:var(--accent-green);">$${nearestSupport ? nearestSupport.price.toFixed(2) : '‚Äî'}</span> and resistance at <span style="color:var(--accent-red);">$${nearestResistance ? nearestResistance.price.toFixed(2) : '‚Äî'}</span>. `;
    vBody += `Gann time cycles peak in <strong>${peakGann.label}</strong> ‚Äî this month has the highest concentration of time-based projections (${GANN_TIME.join(', ')}-day cycles from major pivots). `;
    if (nextSeasonal && daysSeasonal <= 30) {
      vBody += `<strong>Gann seasonal alert:</strong> ${nextSeasonal.name} is ${daysSeasonal}d away ‚Äî historically a turn window. `;
    }
    vBody += `Gann's principle: "When price and time square, a change in trend is imminent." Monitor these levels and dates for confirmation.`;

    vEl.className = `framework-verdict ${vClass}`;
    vEl.innerHTML = `<div class="fv-title">${vTitle}</div><div style="font-size:13px; line-height:1.6; margin-top:6px;">${vBody}</div>
      <div style="font-size:11px; color:var(--text-muted); margin-top:10px; font-style:italic;">
        Square of 9: ‚àöprice rotations yielding support/resistance at 90¬∞/180¬∞/270¬∞/360¬∞ intervals. Angles: price/time ratios from 52-week low (1√ó1 = 45¬∞ = 1 unit price per 1 unit time). Retracements: 1/8th divisions of the 52-week range. Time cycles: 30, 45, 60, 90, 120, 144, 180, 270, 360 calendar days from detected pivots.
      </div>`;
  }



  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ Cycle Analysis: Armstrong œÄ Arrays + Fibonacci ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  let cycleArrayCharts = {};

  function switchArrayTab(tab) {
    document.querySelectorAll('.array-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.array-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('arrTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
    document.getElementById('arr' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  }

  function analyzeCycles(symbol) {
    const n = priceHistory.length;
    if (n < 100) return;

    document.getElementById('cycleCard').style.display = 'block';

    // ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
    const PI_DAYS = 3141.588;
    const ARMSTRONG_CYCLES = [
      { name: '8.6yr', days: PI_DAYS, weight: 5 },
      { name: '4.3yr', days: PI_DAYS / 2, weight: 4 },
      { name: '2.15yr', days: PI_DAYS / 4, weight: 3 },
      { name: '1.43yr', days: PI_DAYS / 6, weight: 2 },
      { name: '1.075yr', days: PI_DAYS / 8, weight: 2 },
      { name: '262d', days: PI_DAYS / 12, weight: 1 },
      { name: '131d', days: PI_DAYS / 24, weight: 1 },
    ];

    const FIB_NUMBERS = [21, 34, 55, 89, 144, 233, 377, 610, 987];

    const today = new Date();
    const todayMs = today.getTime();
    const MS_DAY = 86400000;

    // ‚îÄ‚îÄ Detect Major Pivots ‚îÄ‚îÄ
    function detectPivots(data, windowSize = 60) {
      const pivots = [];
      for (let i = windowSize; i < data.length - Math.min(windowSize, 5); i++) {
        const wL = data.slice(Math.max(0, i - windowSize), i);
        const wR = data.slice(i + 1, Math.min(data.length, i + windowSize + 1));
        const lMax = Math.max(...wL.map(p => p.close));
        const lMin = Math.min(...wL.map(p => p.close));
        const rMax = wR.length > 0 ? Math.max(...wR.map(p => p.close)) : data[i].close;
        const rMin = wR.length > 0 ? Math.min(...wR.map(p => p.close)) : data[i].close;
        if (data[i].close >= lMax && data[i].close >= rMax) pivots.push({ date: data[i].date, price: data[i].close, type: 'high', idx: i });
        if (data[i].close <= lMin && data[i].close <= rMin) pivots.push({ date: data[i].date, price: data[i].close, type: 'low', idx: i });
      }
      const deduped = [];
      for (const p of pivots) {
        const nearby = deduped.find(d => Math.abs(d.date - p.date) < 30 * MS_DAY && d.type === p.type);
        if (nearby) {
          if ((p.type === 'high' && p.price > nearby.price) || (p.type === 'low' && p.price < nearby.price)) {
            deduped.splice(deduped.indexOf(nearby), 1); deduped.push(p);
          }
        } else deduped.push(p);
      }
      return deduped.sort((a, b) => a.date - b.date);
    }

    const windowSize = n > 1000 ? 90 : n > 500 ? 60 : 40;
    const pivots = detectPivots(priceHistory, windowSize);
    const median = priceHistory.map(p => p.close).sort((a, b) => a - b)[Math.floor(n / 2)];
    const ranked = [...pivots].sort((a, b) => Math.abs(b.price - median) - Math.abs(a.price - median));
    const topPivots = ranked.slice(0, Math.min(16, ranked.length)).sort((a, b) => a.date - b.date);

    // ‚îÄ‚îÄ Project ALL Cycles Forward ‚îÄ‚îÄ
    const allProjections = [];

    for (const pivot of topPivots) {
      for (const cycle of ARMSTRONG_CYCLES) {
        for (let mult = 1; mult <= 4; mult++) {
          const projDate = new Date(pivot.date.getTime() + cycle.days * mult * MS_DAY);
          if (projDate > today) {
            allProjections.push({
              date: projDate, source: 'armstrong', cycle: cycle.name,
              fromPivot: pivot, weight: cycle.weight / mult, mult,
            });
          }
        }
      }
      for (const fibDays of FIB_NUMBERS) {
        const projDate = new Date(pivot.date.getTime() + fibDays * MS_DAY);
        if (projDate > today) {
          allProjections.push({
            date: projDate, source: 'fibonacci', cycle: `F${fibDays}`,
            fromPivot: pivot, weight: fibDays >= 233 ? 3 : fibDays >= 89 ? 2 : 1,
          });
        }
        const projDateT = new Date(pivot.date.getTime() + fibDays * 1.4 * MS_DAY);
        if (projDateT > today) {
          allProjections.push({
            date: projDateT, source: 'fibonacci', cycle: `F${fibDays}t`,
            fromPivot: pivot, weight: fibDays >= 233 ? 2 : 1,
          });
        }
      }
    }

    // ‚îÄ‚îÄ Build Array Buckets ‚îÄ‚îÄ
    function buildBuckets(bucketCount, bucketMs, startDate) {
      const buckets = [];
      for (let i = 0; i < bucketCount; i++) {
        const bStart = new Date(startDate.getTime() + i * bucketMs);
        const bEnd = new Date(bStart.getTime() + bucketMs);
        const inBucket = allProjections.filter(p => p.date >= bStart && p.date < bEnd);
        const armWeight = inBucket.filter(p => p.source === 'armstrong').reduce((s, p) => s + p.weight, 0);
        const fibWeight = inBucket.filter(p => p.source === 'fibonacci').reduce((s, p) => s + p.weight, 0);
        const hasArm = armWeight > 0;
        const hasFib = fibWeight > 0;
        const fromHighs = inBucket.filter(p => p.fromPivot.type === 'high').reduce((s, p) => s + p.weight, 0);
        const fromLows = inBucket.filter(p => p.fromPivot.type === 'low').reduce((s, p) => s + p.weight, 0);
        buckets.push({
          start: bStart, end: bEnd, armWeight, fibWeight,
          total: armWeight + fibWeight, count: inBucket.length,
          convergence: hasArm && hasFib,
          fromHighs, fromLows,
        });
      }
      return buckets;
    }

    // Weekly: 52 weeks
    const weekMs = 7 * MS_DAY;
    const weekStart = new Date(today); weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1); // Monday
    const weeklyBuckets = buildBuckets(52, weekMs, weekStart);

    // Monthly: 24 months
    const monthlyBuckets = [];
    for (let i = 0; i < 24; i++) {
      const mStart = new Date(today.getFullYear(), today.getMonth() + i, 1);
      const mEnd = new Date(today.getFullYear(), today.getMonth() + i + 1, 1);
      const inBucket = allProjections.filter(p => p.date >= mStart && p.date < mEnd);
      const armWeight = inBucket.filter(p => p.source === 'armstrong').reduce((s, p) => s + p.weight, 0);
      const fibWeight = inBucket.filter(p => p.source === 'fibonacci').reduce((s, p) => s + p.weight, 0);
      const fromHighs = inBucket.filter(p => p.fromPivot.type === 'high').reduce((s, p) => s + p.weight, 0);
      const fromLows = inBucket.filter(p => p.fromPivot.type === 'low').reduce((s, p) => s + p.weight, 0);
      monthlyBuckets.push({
        start: mStart, end: mEnd, armWeight, fibWeight,
        total: armWeight + fibWeight, count: inBucket.length,
        convergence: armWeight > 0 && fibWeight > 0, fromHighs, fromLows,
        label: mStart.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
      });
    }

    // Quarterly: 12 quarters
    const quarterlyBuckets = [];
    const qStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
    for (let i = 0; i < 12; i++) {
      const qS = new Date(qStart.getFullYear(), qStart.getMonth() + i * 3, 1);
      const qE = new Date(qStart.getFullYear(), qStart.getMonth() + i * 3 + 3, 1);
      const inBucket = allProjections.filter(p => p.date >= qS && p.date < qE);
      const armWeight = inBucket.filter(p => p.source === 'armstrong').reduce((s, p) => s + p.weight, 0);
      const fibWeight = inBucket.filter(p => p.source === 'fibonacci').reduce((s, p) => s + p.weight, 0);
      const fromHighs = inBucket.filter(p => p.fromPivot.type === 'high').reduce((s, p) => s + p.weight, 0);
      const fromLows = inBucket.filter(p => p.fromPivot.type === 'low').reduce((s, p) => s + p.weight, 0);
      const qNum = Math.floor(qS.getMonth() / 3) + 1;
      quarterlyBuckets.push({
        start: qS, end: qE, armWeight, fibWeight,
        total: armWeight + fibWeight, count: inBucket.length,
        convergence: armWeight > 0 && fibWeight > 0, fromHighs, fromLows,
        label: `Q${qNum}'${String(qS.getFullYear()).slice(2)}`,
      });
    }

    // ‚îÄ‚îÄ Render Array Charts ‚îÄ‚îÄ
    function renderArrayChart(canvasId, buckets, labelFn) {
      if (cycleArrayCharts[canvasId]) cycleArrayCharts[canvasId].destroy();

      const labels = buckets.map((b, i) => labelFn ? labelFn(b, i) : (b.label || i));
      const maxTotal = Math.max(...buckets.map(b => b.total), 1);

      // Stacked: Armstrong bottom, Fibonacci middle, extra glow for convergence
      const armData = buckets.map(b => b.armWeight);
      const fibData = buckets.map(b => b.fibWeight);

      // Color each bar: convergence = red, armstrong-only = purple, fib-only = gold
      const armColors = buckets.map(b => b.convergence ? 'rgba(248,113,113,0.8)' : 'rgba(167,139,250,0.7)');
      const fibColors = buckets.map(b => b.convergence ? 'rgba(248,113,113,0.6)' : 'rgba(251,191,36,0.7)');
      const armBorders = buckets.map(b => b.convergence ? '#f87171' : '#a78bfa');
      const fibBorders = buckets.map(b => b.convergence ? '#f87171' : '#fbbf24');

      const ctx = document.getElementById(canvasId).getContext('2d');
      cycleArrayCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Armstrong œÄ', data: armData, backgroundColor: armColors, borderColor: armBorders, borderWidth: 1, borderRadius: 2 },
            { label: 'Fibonacci', data: fibData, backgroundColor: fibColors, borderColor: fibBorders, borderWidth: 1, borderRadius: 2 },
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterBody: (ctx) => {
                  const i = ctx[0].dataIndex;
                  const b = buckets[i];
                  const lines = [`Total weight: ${b.total.toFixed(1)}`, `Projections: ${b.count}`];
                  if (b.convergence) lines.push('‚ö° CONVERGENCE (œÄ + Fib)');
                  return lines;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: { color: '#64748b', font: { size: 9, family: 'JetBrains Mono' }, maxRotation: 45 },
              grid: { color: 'rgba(42,53,80,0.3)' },
            },
            y: {
              stacked: true,
              ticks: { color: '#64748b', font: { size: 10, family: 'JetBrains Mono' } },
              grid: { color: 'rgba(42,53,80,0.3)' },
              title: { display: true, text: 'CYCLE ENERGY', color: '#64748b', font: { size: 9, family: 'JetBrains Mono', weight: '700' } },
            }
          }
        }
      });
    }

    // Weekly labels
    renderArrayChart('arrayWeeklyChart', weeklyBuckets, (b, i) => {
      const d = b.start;
      return i % 4 === 0 ? d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    });

    // Monthly
    renderArrayChart('arrayMonthlyChart', monthlyBuckets);

    // Quarterly
    renderArrayChart('arrayQuarterlyChart', quarterlyBuckets);

    // ‚îÄ‚îÄ Directional Array (monthly) ‚îÄ‚îÄ
    if (cycleArrayCharts['arrayDirectionalChart']) cycleArrayCharts['arrayDirectionalChart'].destroy();
    const dirCtx = document.getElementById('arrayDirectionalChart').getContext('2d');
    cycleArrayCharts['arrayDirectionalChart'] = new Chart(dirCtx, {
      type: 'bar',
      data: {
        labels: monthlyBuckets.map(b => b.label),
        datasets: [
          { label: 'From Lows (Bullish)', data: monthlyBuckets.map(b => b.fromLows), backgroundColor: 'rgba(16,185,129,0.7)', borderColor: '#10b981', borderWidth: 1, borderRadius: 2 },
          { label: 'From Highs (Bearish)', data: monthlyBuckets.map(b => -b.fromHighs), backgroundColor: 'rgba(239,68,68,0.7)', borderColor: '#ef4444', borderWidth: 1, borderRadius: 2 },
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: true, labels: { color: '#94a3b8', font: { size: 10 }, boxWidth: 12 } } },
        scales: {
          x: { stacked: true, ticks: { color: '#64748b', font: { size: 9, family: 'JetBrains Mono' } }, grid: { color: 'rgba(42,53,80,0.3)' } },
          y: {
            stacked: true,
            ticks: { color: '#64748b', font: { size: 10, family: 'JetBrains Mono' }, callback: v => Math.abs(v).toFixed(0) },
            grid: { color: 'rgba(42,53,80,0.3)' },
            title: { display: true, text: 'DIRECTIONAL BIAS', color: '#64748b', font: { size: 9, family: 'JetBrains Mono', weight: '700' } },
          }
        }
      }
    });

    // ‚îÄ‚îÄ Volatility Array (monthly) ‚îÄ‚îÄ
    if (cycleArrayCharts['arrayVolatilityChart']) cycleArrayCharts['arrayVolatilityChart'].destroy();
    const volCtx = document.getElementById('arrayVolatilityChart').getContext('2d');
    const volData = monthlyBuckets.map(b => b.total * (b.convergence ? 1.5 : 1));
    const maxVol = Math.max(...volData, 1);
    const volColors = volData.map((v, i) => {
      const pct = v / maxVol;
      if (monthlyBuckets[i].convergence) return `rgba(248,113,113,${0.4 + pct * 0.5})`;
      if (pct > 0.7) return `rgba(245,158,11,${0.4 + pct * 0.4})`;
      return `rgba(139,92,246,${0.3 + pct * 0.4})`;
    });
    cycleArrayCharts['arrayVolatilityChart'] = new Chart(volCtx, {
      type: 'bar',
      data: {
        labels: monthlyBuckets.map(b => b.label),
        datasets: [{ label: 'Volatility', data: volData, backgroundColor: volColors, borderRadius: 3 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#64748b', font: { size: 9, family: 'JetBrains Mono' } }, grid: { color: 'rgba(42,53,80,0.3)' } },
          y: {
            ticks: { color: '#64748b', font: { size: 10, family: 'JetBrains Mono' } },
            grid: { color: 'rgba(42,53,80,0.3)' },
            title: { display: true, text: 'VOL INTENSITY', color: '#64748b', font: { size: 9, family: 'JetBrains Mono', weight: '700' } },
          }
        }
      }
    });

    // ‚îÄ‚îÄ Convergence Detection for timeline ‚îÄ‚îÄ
    const futureLimit = new Date(today); futureLimit.setFullYear(futureLimit.getFullYear() + 1);
    const nearProjections = allProjections.filter(p => p.date < futureLimit);
    nearProjections.sort((a, b) => a.date - b.date);
    const clusters = [];
    let currentCluster = [];
    for (const proj of nearProjections) {
      if (currentCluster.length === 0 || proj.date - currentCluster[0].date < 7 * MS_DAY) {
        currentCluster.push(proj);
      } else {
        if (currentCluster.length >= 2) clusters.push([...currentCluster]);
        currentCluster = [proj];
      }
    }
    if (currentCluster.length >= 2) clusters.push(currentCluster);

    const scoredClusters = clusters.map(cl => {
      const totalWeight = cl.reduce((s, p) => s + p.weight, 0);
      const hasArm = cl.some(p => p.source === 'armstrong');
      const hasFib = cl.some(p => p.source === 'fibonacci');
      const midDate = new Date(cl.reduce((s, p) => s + p.date.getTime(), 0) / cl.length);
      return { date: midDate, projections: cl, count: cl.length, weight: totalWeight, bothSources: hasArm && hasFib, significance: (hasArm && hasFib) ? 'major' : cl.length >= 3 ? 'convergence' : 'upcoming' };
    }).sort((a, b) => b.weight - a.weight);

    // ‚îÄ‚îÄ Summary Stats ‚îÄ‚îÄ
    const majorCount = scoredClusters.filter(c => c.significance === 'major').length;
    const convCount = scoredClusters.filter(c => c.significance === 'convergence').length;
    const nextMajor = scoredClusters.find(c => c.significance === 'major');
    const nextDate = nextMajor ? nextMajor.date : (scoredClusters[0] ? scoredClusters[0].date : null);
    const daysToNext = nextDate ? Math.round((nextDate - today) / MS_DAY) : null;

    // Peak monthly energy
    const peakMonth = monthlyBuckets.reduce((max, b) => b.total > max.total ? b : max, monthlyBuckets[0]);

    document.getElementById('cycleSummary').innerHTML = `
      <div class="cycle-stat-box"><div class="csb-value" style="color:var(--accent-red);">${majorCount}</div><div class="csb-label">Major Convergences</div></div>
      <div class="cycle-stat-box"><div class="csb-value" style="color:var(--accent-amber);">${convCount}</div><div class="csb-label">Cycle Clusters</div></div>
      <div class="cycle-stat-box"><div class="csb-value" style="color:var(--accent-cyan);">${daysToNext != null ? daysToNext + 'd' : '‚Äî'}</div><div class="csb-label">Next Major Turn</div></div>
      <div class="cycle-stat-box"><div class="csb-value" style="color:#a78bfa;">${peakMonth.label}</div><div class="csb-label">Peak Energy Month</div></div>
      <div class="cycle-stat-box"><div class="csb-value" style="color:var(--text-primary);">${topPivots.length}</div><div class="csb-label">Pivots Detected</div></div>
      <div class="cycle-stat-box"><div class="csb-value" style="color:var(--text-primary);">${allProjections.length}</div><div class="csb-label">Total Projections</div></div>`;

    // ‚îÄ‚îÄ Pivots Table ‚îÄ‚îÄ
    let pivotHtml = `<table class="pivot-table"><thead><tr><th>Date</th><th>Type</th><th>Price</th><th>Significance</th></tr></thead><tbody>`;
    for (const p of topPivots.slice(-10)) {
      const fmtD = p.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      const cls = p.type === 'high' ? 'pivot-high' : 'pivot-low';
      const dist = Math.abs(p.price - median) / median * 100;
      const sig = dist > 20 ? '‚òÖ‚òÖ‚òÖ' : dist > 10 ? '‚òÖ‚òÖ' : '‚òÖ';
      pivotHtml += `<tr><td>${fmtD}</td><td class="${cls}">${p.type === 'high' ? '‚ñ≤ HIGH' : '‚ñº LOW'}</td><td class="${cls}">$${p.price.toFixed(2)}</td><td>${sig} (${dist.toFixed(0)}% from median)</td></tr>`;
    }
    pivotHtml += `</tbody></table>`;
    document.getElementById('cyclePivots').innerHTML = pivotHtml;

    // ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ
    const timelineEvents = [];
    for (const proj of nearProjections) {
      const inCluster = scoredClusters.some(c => c.projections.includes(proj));
      if (!inCluster) timelineEvents.push({ date: proj.date, type: 'upcoming', items: [proj] });
    }
    for (const cl of scoredClusters) timelineEvents.push({ date: cl.date, type: cl.significance, items: cl.projections, weight: cl.weight, count: cl.count });
    timelineEvents.sort((a, b) => a.date - b.date);

    const fmtDate = d => d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    const daysAway = d => Math.round((d - today) / MS_DAY);
    let timelineHtml = '';
    for (const ev of timelineEvents.slice(0, 20)) {
      const days = daysAway(ev.date);
      const daysStr = days <= 7 ? `<span style="color:var(--accent-red); font-weight:700;">in ${days}d!</span>` : days <= 30 ? `<span style="color:var(--accent-amber);">in ${days}d</span>` : `in ${days}d`;
      let tagsHtml = '';
      for (const item of ev.items.slice(0, 5)) {
        tagsHtml += `<span class="cycle-tag ${item.source === 'armstrong' ? 'armstrong' : 'fib'}">${item.cycle}</span>`;
      }
      if (ev.items.length > 5) tagsHtml += `<span class="cycle-tag" style="background:rgba(100,116,139,0.15); color:#94a3b8;">+${ev.items.length - 5} more</span>`;
      if (ev.type === 'major') tagsHtml += `<span class="cycle-tag convergence-tag">üî• MAJOR CONVERGENCE</span>`;
      else if (ev.type === 'convergence') tagsHtml += `<span class="cycle-tag convergence-tag">‚ö° CLUSTER (${ev.count})</span>`;
      const fp = ev.items[0].fromPivot;
      const fromStr = `From ${fp.type === 'high' ? '‚ñ≤' : '‚ñº'} $${fp.price.toFixed(2)} (${fp.date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })})`;
      timelineHtml += `<div class="cycle-event ${ev.type}"><div class="cycle-date" style="color:${ev.type === 'major' ? 'var(--accent-red)' : ev.type === 'convergence' ? 'var(--accent-amber)' : 'var(--accent-cyan)'};">${fmtDate(ev.date)} <span style="font-size:11px; font-weight:400; color:var(--text-muted); margin-left:6px;">${daysStr}</span></div><div class="cycle-tags">${tagsHtml}</div><div class="cycle-from">${fromStr}</div></div>`;
    }
    if (!timelineHtml) timelineHtml = '<div style="color:var(--text-muted); font-size:13px; padding:12px 0;">No cycle projections within the next 12 months. Try a longer data range.</div>';
    document.getElementById('cycleTimeline').innerHTML = timelineHtml;

    // ‚îÄ‚îÄ Verdict ‚îÄ‚îÄ
    const vEl = document.getElementById('cycleVerdict');
    let vClass, vTitle, vBody;
    if (majorCount >= 2) {
      vClass = 'bearish'; vTitle = `üî¥ High Cycle Activity ‚Äî ${majorCount} major convergences ahead`;
      vBody = `<strong>${symbol}</strong> has ${majorCount} major convergence zones where Armstrong œÄ-cycle harmonics and Fibonacci time sequences align within the next 12 months. The arrays show elevated energy in <strong>${peakMonth.label}</strong>. Multiple convergences signal elevated probability of significant trend changes or volatility events. Armstrong's ECM principle: when cycles from different mathematical origins converge, the resulting turning point tends to be more powerful. <strong>Mark these dates and monitor price action closely for reversal signals.</strong>`;
    } else if (majorCount === 1) {
      vClass = 'neutral'; vTitle = `üü° Key Cycle Window ‚Äî Major convergence ~${fmtDate(nextMajor.date)} (${daysAway(nextMajor.date)}d)`;
      vBody = `<strong>${symbol}</strong> has one major convergence zone where both Armstrong œÄ-harmonics and Fibonacci time sequences cluster. Peak array energy is in <strong>${peakMonth.label}</strong>. The directional array ${monthlyBuckets.find(b => b.label === peakMonth.label)?.fromLows > monthlyBuckets.find(b => b.label === peakMonth.label)?.fromHighs ? 'leans bullish (more cycles projecting from lows)' : 'leans bearish (more cycles projecting from highs)'}. Use the Weinstein Stage and OMOINV score to confirm directionality.`;
    } else if (convCount > 0) {
      vClass = 'neutral'; vTitle = `üîµ Moderate Cycle Activity ‚Äî ${convCount} cluster zones detected`;
      vBody = `<strong>${symbol}</strong> shows ${convCount} cycle clusters but no major Armstrong+Fibonacci convergences. The arrays indicate moderate turning-point probability. Watch for confirming price action near cluster dates. Peak energy month: <strong>${peakMonth.label}</strong>.`;
    } else {
      vClass = 'bullish'; vTitle = `üü¢ Low Cycle Pressure ‚Äî No significant convergences`;
      vBody = `<strong>${symbol}</strong> has no major cycle convergence zones in the next 12 months. Current trend has low probability of a cycle-driven reversal. The path of least resistance is continuation.`;
    }
    vEl.className = `framework-verdict ${vClass}`;
    vEl.innerHTML = `<div class="fv-title">${vTitle}</div><div style="font-size:13px; line-height:1.6; margin-top:6px;">${vBody}</div><div style="font-size:11px; color:var(--text-muted); margin-top:10px; font-style:italic;">Armstrong arrays derived from œÄ √ó 1000 = 3,141.588 days (8.6yr) and harmonic subdivisions (√∑2, √∑4, √∑6, √∑8, √∑12, √∑24). Fibonacci: 21, 34, 55, 89, 144, 233, 377, 610, 987 calendar & trading days. Convergence = both œÄ + Fib in same window. Directional bias = net weight from high pivots (bearish) vs low pivots (bullish).</div>`;
  }


  // ‚îÄ‚îÄ Chart ‚îÄ‚îÄ
  function renderChart(symbol) {
    if (priceHistory.length < 10) return;

    document.getElementById('chartPlaceholder').style.display = 'none';
    const canvas = document.getElementById('priceChart');
    canvas.style.display = 'block';

    if (chartInstance) chartInstance.destroy();

    const labels = priceHistory.map(p => p.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    const closes = priceHistory.map(p => p.close);

    // Compute SMAs
    const computeSMA = (data, period) => {
      const result = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) { result.push(null); continue; }
        let sum = 0;
        for (let j = i - period + 1; j <= i; j++) sum += data[j];
        result.push(sum / period);
      }
      return result;
    };

    const sma50Data = computeSMA(closes, 50);
    const sma150Data = computeSMA(closes, 150);
    const sma200Data = computeSMA(closes, 200);

    chartInstance = new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: symbol,
            data: closes,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.06)',
            fill: true,
            borderWidth: 2,
            pointRadius: 0,
            pointHitRadius: 6,
            tension: 0.1,
            order: 1,
          },
          {
            label: 'SMA 50',
            data: sma50Data,
            borderColor: '#f59e0b',
            borderWidth: 1.5,
            borderDash: [4, 2],
            pointRadius: 0,
            tension: 0.3,
            order: 2,
          },
          {
            label: 'SMA 150',
            data: sma150Data,
            borderColor: '#8b5cf6',
            borderWidth: 1.5,
            borderDash: [6, 3],
            pointRadius: 0,
            tension: 0.3,
            order: 3,
          },
          {
            label: 'SMA 200',
            data: sma200Data,
            borderColor: '#ef4444',
            borderWidth: 1.5,
            borderDash: [8, 4],
            pointRadius: 0,
            tension: 0.3,
            order: 4,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            labels: {
              color: '#94a3b8',
              font: { family: 'DM Sans', size: 12 },
              usePointStyle: true,
              pointStyleWidth: 20,
              padding: 16,
            },
          },
          tooltip: {
            backgroundColor: '#1a2236',
            titleColor: '#e2e8f0',
            bodyColor: '#94a3b8',
            borderColor: '#2a3550',
            borderWidth: 1,
            cornerRadius: 8,
            titleFont: { family: 'JetBrains Mono', size: 12 },
            bodyFont: { family: 'JetBrains Mono', size: 11 },
            callbacks: {
              label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y?.toFixed(2) ?? '‚Äî'}`,
            },
          },
        },
        scales: {
          x: {
            ticks: {
              color: '#64748b',
              font: { family: 'DM Sans', size: 10 },
              maxTicksLimit: 12,
            },
            grid: { color: 'rgba(42,53,80,0.4)' },
          },
          y: {
            ticks: {
              color: '#64748b',
              font: { family: 'JetBrains Mono', size: 11 },
              callback: v => '$' + v.toFixed(0),
            },
            grid: { color: 'rgba(42,53,80,0.4)' },
          },
        },
      },
    });
  }

  // ‚îÄ‚îÄ Historical OMOINV Computation ‚îÄ‚îÄ
  function computeHistoricalOMO() {
    historicalOMO = [];
    if (priceHistory.length < 252) return;
    const stepSize = 21;
    const startIdx = Math.max(252, 200);
    for (let i = startIdx; i < priceHistory.length; i += stepSize) {
      const slice = priceHistory.slice(0, i + 1);
      const price = slice[slice.length - 1].close;
      const date = slice[slice.length - 1].date;
      const yearSlice = slice.slice(-252);
      const h52 = Math.max(...yearSlice.map(p => p.close));
      const l52 = Math.min(...yearSlice.map(p => p.close));
      const smaCalc = (n) => { const s = slice.slice(-n); return s.reduce((sum, p) => sum + p.close, 0) / s.length; };
      const s50 = slice.length >= 50 ? smaCalc(50) : null;
      const s150 = slice.length >= 150 ? smaCalc(150) : null;
      const s200 = slice.length >= 200 ? smaCalc(200) : null;
      if (!s50 || !s150 || !s200) continue;
      let rs = null;
      if (spyHistory.length > 0) {
        const dateMs = date.getTime();
        let spyIdx = spyHistory.length - 1;
        for (let j = 0; j < spyHistory.length; j++) { if (spyHistory[j].date.getTime() >= dateMs) { spyIdx = j; break; } }
        const lookback = Math.min(126, Math.floor(spyIdx / 2), Math.floor(i / 2));
        if (lookback >= 20) {
          const stockRet = price / slice[slice.length - 1 - lookback].close;
          const spyRet = spyHistory[spyIdx].close / spyHistory[Math.max(0, spyIdx - lookback)].close;
          if (spyRet > 0) rs = stockRet / spyRet;
        }
      }
      const pctFromHigh = ((h52 - price) / h52) * 100;
      const pctAboveLow = ((price - l52) / l52) * 100;
      const c1 = pctFromHigh <= 25, c2 = pctAboveLow >= 30;
      const c3 = price > s50, c4 = price > s150, c5 = price > s200;
      const c6 = s50 > s150 && s150 > s200, c7 = rs !== null && rs > 1.0;
      const score = [c1, c2, c3, c4, c5, c6, c7].filter(Boolean).length;
      historicalOMO.push({ date, price, score, h52, l52, s50, s150, s200, rs, pctFromHigh, pctAboveLow, c1, c2, c3, c4, c5, c6, c7 });
    }
    // Ensure latest point included
    if (historicalOMO.length > 0) {
      const lastH = historicalOMO[historicalOMO.length - 1].date.getTime();
      const lastD = priceHistory[priceHistory.length - 1].date.getTime();
      if (lastD - lastH > 86400000 * 5) {
        const slice = priceHistory, idx = slice.length - 1, price = slice[idx].close;
        const yearSlice = slice.slice(-252);
        const h52 = Math.max(...yearSlice.map(p => p.close)), l52 = Math.min(...yearSlice.map(p => p.close));
        const smaCalc = (n) => slice.slice(-n).reduce((s, p) => s + p.close, 0) / n;
        const s50 = smaCalc(50), s150 = smaCalc(150), s200 = smaCalc(200);
        let rs = null;
        if (spyHistory.length > 126) { rs = (price / slice[idx - 126].close) / (spyHistory[spyHistory.length - 1].close / spyHistory[spyHistory.length - 127].close); }
        const pctFromHigh = ((h52 - price) / h52) * 100, pctAboveLow = ((price - l52) / l52) * 100;
        const c1 = pctFromHigh <= 25, c2 = pctAboveLow >= 30, c3 = price > s50, c4 = price > s150, c5 = price > s200;
        const c6 = s50 > s150 && s150 > s200, c7 = rs !== null && rs > 1.0;
        historicalOMO.push({ date: slice[idx].date, price, score: [c1,c2,c3,c4,c5,c6,c7].filter(Boolean).length, h52, l52, s50, s150, s200, rs, pctFromHigh, pctAboveLow, c1, c2, c3, c4, c5, c6, c7 });
      }
    }
  }

  // ‚îÄ‚îÄ Historical OMOINV Chart ‚îÄ‚îÄ
  function renderHistoricalChart(symbol) {
    if (historicalOMO.length < 3) { document.getElementById('histChartCard').classList.remove('visible'); return; }
    document.getElementById('histChartCard').classList.add('visible');
    const canvas = document.getElementById('histChart');
    if (histChartInstance) histChartInstance.destroy();
    const labels = historicalOMO.map(p => p.date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
    const scores = historicalOMO.map(p => p.score);
    const prices = historicalOMO.map(p => p.price);
    const barColors = scores.map(s => s === 7 ? 'rgba(16,185,129,0.8)' : s >= 5 ? 'rgba(6,182,212,0.7)' : s >= 3 ? 'rgba(245,158,11,0.7)' : 'rgba(239,68,68,0.7)');
    const barBorders = scores.map(s => s === 7 ? '#10b981' : s >= 5 ? '#06b6d4' : s >= 3 ? '#f59e0b' : '#ef4444');
    histChartInstance = new Chart(canvas, {
      type: 'bar',
      data: { labels, datasets: [
        { label: 'OMOINV Score', data: scores, backgroundColor: barColors, borderColor: barBorders, borderWidth: 1, borderRadius: 4, yAxisID: 'y', order: 2 },
        { label: `${symbol} Price`, data: prices, type: 'line', borderColor: 'rgba(59,130,246,0.7)', backgroundColor: 'rgba(59,130,246,0.05)', borderWidth: 2, pointRadius: 2, pointBackgroundColor: '#3b82f6', fill: true, tension: 0.3, yAxisID: 'y1', order: 1 },
      ]},
      options: {
        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { labels: { color: '#94a3b8', font: { family: 'DM Sans', size: 12 }, usePointStyle: true, padding: 16 } },
          tooltip: { backgroundColor: '#1a2236', titleColor: '#e2e8f0', bodyColor: '#94a3b8', borderColor: '#2a3550', borderWidth: 1, cornerRadius: 8,
            titleFont: { family: 'JetBrains Mono', size: 12 }, bodyFont: { family: 'JetBrains Mono', size: 11 },
            callbacks: { label: ctx => ctx.dataset.label === 'OMOINV Score' ? `OMOINV: ${ctx.parsed.y}/7` : `Price: $${ctx.parsed.y?.toFixed(2)}` } },
        },
        scales: {
          x: { ticks: { color: '#64748b', font: { family: 'DM Sans', size: 10 }, maxTicksLimit: 18 }, grid: { color: 'rgba(42,53,80,0.3)' } },
          y: { position: 'left', min: 0, max: 7, ticks: { stepSize: 1, color: '#64748b', font: { family: 'JetBrains Mono', size: 11 }, callback: v => v + '/7' },
            grid: { color: 'rgba(42,53,80,0.3)' }, title: { display: true, text: 'OMOINV Score', color: '#64748b', font: { family: 'DM Sans', size: 11 } } },
          y1: { position: 'right', ticks: { color: '#64748b', font: { family: 'JetBrains Mono', size: 11 }, callback: v => '$' + v.toFixed(0) },
            grid: { drawOnChartArea: false }, title: { display: true, text: 'Price', color: '#64748b', font: { family: 'DM Sans', size: 11 } } },
        },
      },
    });
    document.getElementById('histLegend').innerHTML = `
      <span class="hist-legend-item"><span class="hist-legend-dot" style="background:#10b981"></span>7/7 Full Template</span>
      <span class="hist-legend-item"><span class="hist-legend-dot" style="background:#06b6d4"></span>5-6/7 Watchlist</span>
      <span class="hist-legend-item"><span class="hist-legend-dot" style="background:#f59e0b"></span>3-4/7 Neutral</span>
      <span class="hist-legend-item"><span class="hist-legend-dot" style="background:#ef4444"></span>0-2/7 Avoid</span>`;
  }

  // ‚îÄ‚îÄ Historical Commentary ‚îÄ‚îÄ
  function generateHistoricalCommentary(symbol) {
    if (historicalOMO.length < 3) { document.getElementById('histCommentaryCard').classList.remove('visible'); return; }
    document.getElementById('histCommentaryCard').classList.add('visible');
    const body = document.getElementById('histCommentaryBody');
    let html = '';
    const fmtD = d => d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

    // Build phases
    const phases = []; let cur = null;
    for (const pt of historicalOMO) {
      const tier = pt.score === 7 ? 'strong' : pt.score >= 5 ? 'moderate' : pt.score >= 3 ? 'weak' : 'bearish';
      if (!cur || cur.tier !== tier) {
        cur = { tier, startDate: pt.date, endDate: pt.date, points: [pt], minScore: pt.score, maxScore: pt.score, startPrice: pt.price, endPrice: pt.price };
        phases.push(cur);
      } else { cur.points.push(pt); cur.endDate = pt.date; cur.endPrice = pt.price; cur.minScore = Math.min(cur.minScore, pt.score); cur.maxScore = Math.max(cur.maxScore, pt.score); }
    }
    const totalPts = historicalOMO.length;
    const avgScore = (historicalOMO.reduce((s, p) => s + p.score, 0) / totalPts).toFixed(1);
    const perfectCount = historicalOMO.filter(p => p.score === 7).length;
    const perfectPct = ((perfectCount / totalPts) * 100).toFixed(0);
    const avoidCount = historicalOMO.filter(p => p.score <= 2).length;
    const avoidPct = ((avoidCount / totalPts) * 100).toFixed(0);
    const firstPrice = historicalOMO[0].price, lastPrice = historicalOMO[historicalOMO.length - 1].price;
    const totalReturn = ((lastPrice / firstPrice - 1) * 100).toFixed(1);

    // Preamble
    html += `<div class="section-label verdict-label">3-Year Trend Evolution</div>`;
    html += `<p>Over <strong>${fmtD(historicalOMO[0].date)}</strong> to <strong>${fmtD(historicalOMO[historicalOMO.length-1].date)}</strong> (${totalPts} monthly checkpoints), <strong>${symbol}</strong> exhibited <strong>${phases.length} distinct trend phases</strong>. Average OMOINV: <strong>${avgScore}/7</strong>. Perfect 7/7: <span class="${perfectPct >= 30 ? 'highlight-green' : perfectPct > 0 ? 'highlight-blue' : 'highlight-red'}">${perfectPct}%</span> of periods. Avoid territory: <span class="${avoidPct <= 10 ? 'highlight-green' : avoidPct <= 30 ? 'highlight-amber' : 'highlight-red'}">${avoidPct}%</span>. Total return: $${firstPrice.toFixed(2)} ‚Üí $${lastPrice.toFixed(2)} (<span class="${parseFloat(totalReturn) >= 0 ? 'highlight-green' : 'highlight-red'}">${totalReturn > 0 ? '+' : ''}${totalReturn}%</span>).</p>`;

    // Phase breakdown
    html += `<hr class="commentary-divider"><div class="section-label trend-label">Phase-by-Phase Breakdown</div>`;
    const tm = { strong: { label: 'STAGE 2 LEADER', badge: 'badge-green', cls: 'strong' }, moderate: { label: 'EMERGING / WATCHLIST', badge: 'badge-cyan', cls: 'moderate' }, weak: { label: 'NEUTRAL / BASING', badge: 'badge-amber', cls: 'weak' }, bearish: { label: 'STAGE 4 / AVOID', badge: 'badge-red', cls: 'bearish' } };
    for (let pi = 0; pi < phases.length; pi++) {
      const ph = phases[pi], t = tm[ph.tier];
      const dur = Math.round((ph.endDate - ph.startDate) / (1000 * 86400 * 30)) + 1;
      const durL = dur <= 1 ? '~1 month' : `~${dur} months`;
      const pChg = ((ph.endPrice / ph.startPrice - 1) * 100).toFixed(1);
      const pC = parseFloat(pChg) >= 0 ? 'highlight-green' : 'highlight-red';
      const prev = pi > 0 ? phases[pi - 1].tier : null;
      html += `<div class="hist-period ${t.cls}"><div class="hist-period-header"><span class="hist-period-date">${fmtD(ph.startDate)} ‚Äî ${fmtD(ph.endDate)} (${durL})</span><span class="hist-period-badge ${t.badge}">${t.label}</span></div><div class="hist-period-text">`;
      if (ph.tier === 'strong') {
        html += `<strong>${symbol}</strong> held ${ph.minScore}‚Äì${ph.maxScore}/7 ‚Äî confirmed <strong>Stage 2 uptrend</strong>. Price: $${ph.startPrice.toFixed(2)} ‚Üí $${ph.endPrice.toFixed(2)} (<span class="${pC}">${pChg > 0 ? '+' : ''}${pChg}%</span>). Full MA alignment, near highs, outperforming SPY. `;
        if (dur >= 6) html += `Sustained ${durL} run ‚Äî deep institutional conviction; extended Stage 2 phases produce the largest gains. `;
        html += `Best entries: pullbacks to 10/21-EMA or VCP setups.`;
      } else if (ph.tier === 'moderate') {
        html += `<strong>${symbol}</strong> scored 5‚Äì6/7 ‚Äî approaching qualification. Price: $${ph.startPrice.toFixed(2)} ‚Üí $${ph.endPrice.toFixed(2)} (<span class="${pC}">${pChg > 0 ? '+' : ''}${pChg}%</span>). `;
        if (prev === 'strong') html += `Post-strength consolidation ‚Äî either healthy digestion or early momentum fade. Critical to monitor if remaining criteria improve or erode.`;
        else if (prev === 'weak' || prev === 'bearish') html += `Recovering from weakness ‚Äî potential <strong>Stage 1‚Üí2 transition</strong>. The setup before the setup.`;
        else html += `Watchlist territory ‚Äî awaiting the final criteria flip.`;
      } else if (ph.tier === 'weak') {
        html += `At ${ph.minScore}‚Äì${ph.maxScore}/7, <strong>${symbol}</strong> lacked trend structure. Price: $${ph.startPrice.toFixed(2)} ‚Üí $${ph.endPrice.toFixed(2)} (<span class="${pC}">${pChg > 0 ? '+' : ''}${pChg}%</span>). `;
        if (prev === 'strong') html += `<strong>Significant deterioration</strong> ‚Äî Stage 2 breaking down, MAs losing alignment.`;
        else if (prev === 'bearish') html += `Marginal improvement ‚Äî possibly <strong>basing</strong> for eventual breakout.`;
        else html += `Sideways drift with no clear trend direction.`;
      } else {
        html += `<strong>${symbol}</strong> in <strong>downtrend</strong> at ${ph.minScore}‚Äì${ph.maxScore}/7. Price: $${ph.startPrice.toFixed(2)} ‚Üí $${ph.endPrice.toFixed(2)} (<span class="${pC}">${pChg > 0 ? '+' : ''}${pChg}%</span>). `;
        if (prev === 'strong' || prev === 'moderate') html += `Definitive <strong>Stage 3/4 transition</strong> ‚Äî distribution then markdown. Underscores importance of stop-losses and OMOINV as ongoing monitor.`;
        else html += `Sustained Stage 4 decline. Bottom-fishing here = catching falling knives.`;
      }
      html += `</div></div>`;
    }

    // Trajectory
    html += `<hr class="commentary-divider"><div class="section-label strength-label">Trend Trajectory & Momentum</div>`;
    const rScores = historicalOMO.slice(-6).map(p => p.score);
    const rAvg = (rScores.reduce((s, v) => s + v, 0) / rScores.length).toFixed(1);
    const oPts = historicalOMO.slice(0, -6);
    const oAvg = oPts.length > 0 ? (oPts.reduce((s, p) => s + p.score, 0) / oPts.length).toFixed(1) : rAvg;
    const imp = parseFloat(rAvg) > parseFloat(oAvg) + 0.5, det = parseFloat(rAvg) < parseFloat(oAvg) - 0.5;
    if (imp) html += `<p>Trajectory: <span class="highlight-green">improving</span>. Recent 6-mo avg: <strong>${rAvg}</strong> vs longer-term <strong>${oAvg}</strong>. Trend strengthening ‚Äî could achieve full compliance soon.</p>`;
    else if (det) html += `<p>Trajectory: <span class="highlight-red">deteriorating</span>. Recent 6-mo avg: <strong>${rAvg}</strong> vs longer-term <strong>${oAvg}</strong>. Structural erosion ‚Äî tighten stops, defer new entries.</p>`;
    else html += `<p>Trajectory: <span class="highlight-blue">stable</span>. Recent 6-mo avg: <strong>${rAvg}</strong> ‚âà longer-term <strong>${oAvg}</strong>. Consistent character ‚Äî watch for shifting catalysts.</p>`;

    // Best/worst
    let bestPh = phases[0], worstPh = phases[0];
    for (const ph of phases) {
      const a = ph.points.reduce((s, p) => s + p.score, 0) / ph.points.length;
      if (a > bestPh.points.reduce((s, p) => s + p.score, 0) / bestPh.points.length) bestPh = ph;
      if (a < worstPh.points.reduce((s, p) => s + p.score, 0) / worstPh.points.length) worstPh = ph;
    }
    const bR = ((bestPh.endPrice / bestPh.startPrice - 1) * 100).toFixed(1);
    const wR = ((worstPh.endPrice / worstPh.startPrice - 1) * 100).toFixed(1);
    html += `<p><strong>Strongest:</strong> <span class="highlight-green">${fmtD(bestPh.startDate)} ‚Äì ${fmtD(bestPh.endDate)}</span> (${bestPh.minScore}‚Äì${bestPh.maxScore}/7, ${bR > 0 ? '+' : ''}${bR}%). <strong>Weakest:</strong> <span class="highlight-red">${fmtD(worstPh.startDate)} ‚Äì ${fmtD(worstPh.endDate)}</span> (${worstPh.minScore}‚Äì${worstPh.maxScore}/7, ${wR > 0 ? '+' : ''}${wR}%).</p>`;

    // Summary box
    const summaryRangeLabel = document.getElementById('dataRange').selectedOptions[0].text;
    html += `<div class="hist-summary-box"><div class="summary-title">üìä ${summaryRangeLabel} Historical Summary</div><p>`;
    const tp = {}; for (const ph of phases) { tp[ph.tier] = (tp[ph.tier] || 0) + ph.points.length; }
    const tl = { strong: 'Stage 2 leadership', moderate: 'watchlist/emerging', weak: 'neutral/basing', bearish: 'avoid/decline' };
    const tcc = { strong: 'highlight-green', moderate: 'highlight-blue', weak: 'highlight-amber', bearish: 'highlight-red' };
    const pts = []; for (const t of ['strong', 'moderate', 'weak', 'bearish']) { if (tp[t]) pts.push(`<span class="${tcc[t]}">${((tp[t] / totalPts) * 100).toFixed(0)}%</span> in ${tl[t]}`); }
    html += `<strong>${symbol}</strong> spent ` + pts.join(', ') + '. ';
    if (parseFloat(perfectPct) >= 40) html += `<strong>Consistently strong</strong> trend stock ‚Äî reliable institutional leadership. `;
    else if (parseFloat(perfectPct) >= 15) html += `<strong>Periodic trend strength</strong> ‚Äî time entries to compliance windows. `;
    else if (parseFloat(perfectPct) > 0) html += `Full compliance <strong>rare</strong> ‚Äî brief opportunity windows. `;
    else html += `<strong>Never hit 7/7</strong> ‚Äî may not suit this methodology or still awaiting first Stage 2 breakout. `;
    html += `Trajectory: ${imp ? '<span class="highlight-green">improving</span>' : det ? '<span class="highlight-red">deteriorating</span>' : '<span class="highlight-blue">stable</span>'}.`;
    html += `</p></div>`;
    body.innerHTML = html;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TAB SWITCHING
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    event.target.classList.add('active');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BACKTEST ENGINE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let equityChartInstance = null;

  function runBacktest() {
    if (historicalOMO.length < 4) {
      alert('Please fetch data on the Analyzer tab first (need at least 1 year of data).');
      return;
    }

    const capital = parseFloat(document.getElementById('btCapital').value) || 10000;
    const buyTarget = parseInt(document.getElementById('btBuyTarget').value);
    const buyFrom = parseInt(document.getElementById('btBuyFrom').value);
    const sellTarget = parseInt(document.getElementById('btSellTarget').value);
    const sellFrom = parseInt(document.getElementById('btSellFrom').value);
    const sym = getSymbol();

    // Transition-based signal engine:
    // BUY  = not holding AND score rises to ‚â• buyTarget from a prior score ‚â§ buyFrom
    // SELL = holding AND score drops to ‚â§ sellTarget from a prior score ‚â• sellFrom
    let cash = capital;
    let shares = 0;
    let entryPrice = 0;
    let entryDate = null;
    let prevScore = historicalOMO[0].score;
    let peakScoreWhileHolding = 0;
    const trades = [];
    const equityCurve = [{ date: historicalOMO[0].date, equity: capital, label: 'Start' }];
    const buyHoldCurve = [];
    const bh0 = historicalOMO[0].price;

    for (let i = 0; i < historicalOMO.length; i++) {
      const pt = historicalOMO[i];
      const currentEquity = shares > 0 ? cash + shares * pt.price : cash;
      equityCurve.push({ date: pt.date, equity: currentEquity });
      buyHoldCurve.push({ date: pt.date, equity: capital * (pt.price / bh0) });

      if (i === 0) { prevScore = pt.score; continue; }

      if (shares === 0) {
        // CHECK BUY: previous score was ‚â§ buyFrom, current score ‚â• buyTarget
        if (prevScore <= buyFrom && pt.score >= buyTarget) {
          shares = Math.floor(cash / pt.price);
          if (shares > 0) {
            entryPrice = pt.price;
            entryDate = pt.date;
            peakScoreWhileHolding = pt.score;
            cash -= shares * pt.price;
            trades.push({ type: 'BUY', date: pt.date, price: pt.price, score: pt.score, prevScore, shares, pnl: null, pnlPct: null, equity: cash + shares * pt.price });
          }
        }
      } else {
        // Track peak score while holding
        if (pt.score > peakScoreWhileHolding) peakScoreWhileHolding = pt.score;

        // CHECK SELL: had reached ‚â• sellFrom at some point, now drops to ‚â§ sellTarget
        if (peakScoreWhileHolding >= sellFrom && pt.score <= sellTarget) {
          const proceeds = shares * pt.price;
          const pnl = (pt.price - entryPrice) * shares;
          const pnlPct = ((pt.price / entryPrice) - 1) * 100;
          cash += proceeds;
          trades.push({ type: 'SELL', date: pt.date, price: pt.price, score: pt.score, prevScore, shares, pnl, pnlPct, equity: cash });
          shares = 0;
          peakScoreWhileHolding = 0;
        }
      }

      prevScore = pt.score;
    }

    // Close any open position at last price
    const lastPt = historicalOMO[historicalOMO.length - 1];
    if (shares > 0) {
      const pnl = (lastPt.price - entryPrice) * shares;
      const pnlPct = ((lastPt.price / entryPrice) - 1) * 100;
      cash += shares * lastPt.price;
      trades.push({ type: 'HOLD', date: lastPt.date, price: lastPt.price, score: lastPt.score, shares, pnl, pnlPct, equity: cash });
      shares = 0;
    }

    const finalEquity = cash;
    const totalReturn = ((finalEquity / capital) - 1) * 100;
    const buyHoldReturn = ((lastPt.price / bh0) - 1) * 100;
    const buyHoldFinal = capital * (lastPt.price / bh0);
    const alpha = totalReturn - buyHoldReturn;

    // Count wins/losses
    const closedTrades = trades.filter(t => t.type === 'SELL' || t.type === 'HOLD');
    const wins = closedTrades.filter(t => t.pnl >= 0).length;
    const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(0) : '‚Äî';
    const bestTrade = closedTrades.length > 0 ? Math.max(...closedTrades.map(t => t.pnlPct)) : 0;
    const worstTrade = closedTrades.length > 0 ? Math.min(...closedTrades.map(t => t.pnlPct)) : 0;

    // Update stats
    document.getElementById('btStats').style.display = 'grid';
    document.getElementById('btEmpty').style.display = 'none';
    document.getElementById('btTableWrap').style.display = 'block';

    const rC = totalReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    const bhC = buyHoldReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    const aC = alpha >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

    document.getElementById('btTotalReturn').innerHTML = `<span style="color:${rC}">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(1)}%</span>`;
    document.getElementById('btTotalDollar').textContent = `$${capital.toLocaleString()} ‚Üí $${finalEquity.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
    document.getElementById('btBuyHold').innerHTML = `<span style="color:${bhC}">${buyHoldReturn >= 0 ? '+' : ''}${buyHoldReturn.toFixed(1)}%</span>`;
    document.getElementById('btBuyHoldDollar').textContent = `$${capital.toLocaleString()} ‚Üí $${buyHoldFinal.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
    document.getElementById('btAlpha').innerHTML = `<span style="color:${aC}">${alpha >= 0 ? '+' : ''}${alpha.toFixed(1)}%</span>`;
    document.getElementById('btTradeCount').textContent = closedTrades.length;
    document.getElementById('btWinRate').textContent = `Win rate: ${winRate}%`;
    document.getElementById('btBestTrade').innerHTML = `<span style="color:var(--accent-green)">${bestTrade >= 0 ? '+' : ''}${bestTrade.toFixed(1)}%</span>`;
    document.getElementById('btWorstTrade').innerHTML = `<span style="color:var(--accent-red)">${worstTrade >= 0 ? '+' : ''}${worstTrade.toFixed(1)}%</span>`;

    // Trade log table
    const tbody = document.getElementById('btTableBody');
    tbody.innerHTML = '';
    let tradeNum = 0;
    for (const t of trades) {
      if (t.type === 'SELL' || t.type === 'HOLD') tradeNum++;
      const isBuy = t.type === 'BUY';
      const badge = t.type === 'BUY' ? 'badge-buy' : t.type === 'HOLD' ? 'badge-hold' : 'badge-sell';
      const pnlStr = t.pnl !== null ? `<span style="color:${t.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${t.pnl >= 0 ? '+' : ''}$${t.pnl.toFixed(0)}</span>` : '‚Äî';
      const pctStr = t.pnlPct !== null ? `<span style="color:${t.pnlPct >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${t.pnlPct >= 0 ? '+' : ''}${t.pnlPct.toFixed(1)}%</span>` : '‚Äî';
      const dateStr = t.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
      const transColor = isBuy ? 'var(--accent-green)' : t.type === 'HOLD' ? 'var(--accent-blue)' : 'var(--accent-red)';
      const transStr = t.prevScore !== undefined ? `<span style="color:var(--text-muted)">${t.prevScore}/7</span> <span style="color:${transColor}">‚Üí</span> <span style="color:${transColor};font-weight:700">${t.score}/7</span>` : `${t.score}/7`;

      tbody.innerHTML += `<tr>
        <td>${isBuy ? '' : tradeNum}</td>
        <td><span class="${badge}">${t.type}</span></td>
        <td>${dateStr}</td>
        <td>$${t.price.toFixed(2)}</td>
        <td>${transStr}</td>
        <td>${t.shares}</td>
        <td>${pnlStr}</td>
        <td>${pctStr}</td>
        <td>$${t.equity.toFixed(0)}</td>
      </tr>`;
    }

    // Equity curve chart
    renderEquityChart(equityCurve, buyHoldCurve, sym, capital);

    // Commentary
    generateBacktestCommentary(sym, capital, finalEquity, totalReturn, buyHoldReturn, alpha, closedTrades, trades, bestTrade, worstTrade, winRate, buyTarget, buyFrom, sellTarget, sellFrom);
  }

  function renderEquityChart(eqCurve, bhCurve, symbol, capital) {
    const canvas = document.getElementById('equityChart');
    if (equityChartInstance) equityChartInstance.destroy();
    const labels = eqCurve.slice(1).map(p => p.date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
    equityChartInstance = new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'MTT Strategy', data: eqCurve.slice(1).map(p => p.equity), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.06)', fill: true, borderWidth: 2, pointRadius: 0, tension: 0.3 },
          { label: 'Buy & Hold', data: bhCurve.map(p => p.equity), borderColor: '#64748b', borderDash: [5, 3], borderWidth: 1.5, pointRadius: 0, tension: 0.3 },
        ],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: '#94a3b8', font: { family: 'DM Sans', size: 12 }, usePointStyle: true, padding: 16 } },
          tooltip: { backgroundColor: '#1a2236', titleColor: '#e2e8f0', bodyColor: '#94a3b8', borderColor: '#2a3550', borderWidth: 1, cornerRadius: 8,
            callbacks: { label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y?.toFixed(0)}` } },
        },
        scales: {
          x: { ticks: { color: '#64748b', font: { size: 10 }, maxTicksLimit: 12 }, grid: { color: 'rgba(42,53,80,0.3)' } },
          y: { ticks: { color: '#64748b', font: { family: 'JetBrains Mono', size: 11 }, callback: v => '$' + (v/1000).toFixed(1) + 'k' }, grid: { color: 'rgba(42,53,80,0.3)' } },
        },
      },
    });
  }

  function generateBacktestCommentary(sym, capital, finalEq, totalRet, bhRet, alpha, closed, allTrades, best, worst, winRate, buyTarget, buyFrom, sellTarget, sellFrom) {
    const card = document.getElementById('btCommentaryCard');
    card.style.display = 'block';
    const body = document.getElementById('btCommentary');
    let html = '';

    html += `<div class="section-label verdict-label">Strategy Performance</div>`;
    html += `<p>The OMOINV transition strategy for <strong>${sym}</strong> ‚Äî buy when score rises from ‚â§${buyFrom} to ‚â•${buyTarget}/7, sell when score drops from ‚â•${sellFrom} to ‚â§${sellTarget}/7 ‚Äî generated a total return of <span class="${totalRet >= 0 ? 'highlight-green' : 'highlight-red'}">${totalRet >= 0 ? '+' : ''}${totalRet.toFixed(1)}%</span>, turning $${capital.toLocaleString()} into <strong>$${finalEq.toLocaleString(undefined,{maximumFractionDigits:0})}</strong>. `;
    html += `Compared to a simple buy-and-hold approach (${bhRet >= 0 ? '+' : ''}${bhRet.toFixed(1)}%), the transition strategy generated <span class="${alpha >= 0 ? 'highlight-green' : 'highlight-red'}">${alpha >= 0 ? '+' : ''}${alpha.toFixed(1)}% alpha</span>.</p>`;

    html += `<hr class="commentary-divider"><div class="section-label trend-label">Signal Logic</div>`;
    html += `<p>This system uses <strong>transition-based signals</strong> rather than simple thresholds. A buy signal only fires when the OMOINV score <em>crosses upward</em> from a weak reading (‚â§${buyFrom}/7) to a strong one (‚â•${buyTarget}/7) ‚Äî confirming a genuine Stage 2 breakout rather than just catching a stock already mid-trend. `;
    html += `Similarly, sells only trigger when the score <em>collapses</em> from strength (‚â•${sellFrom}/7) down to weakness (‚â§${sellTarget}/7) ‚Äî filtering out minor score fluctuations that would otherwise cause whipsaw exits.</p>`;

    html += `<hr class="commentary-divider"><div class="section-label trend-label">Trade Analysis</div>`;
    html += `<p>Over the 3-year period, the system executed <strong>${closed.length} round-trip trade${closed.length !== 1 ? 's' : ''}</strong> with a <strong>${winRate}% win rate</strong>. `;
    if (closed.length === 0) {
      html += `No transition signals were generated ‚Äî the stock either never made the full ‚â§${buyFrom}‚Üí‚â•${buyTarget} transition, or remained in a steady trend throughout. This can happen with consistently strong or consistently weak stocks. Consider widening the buy/sell transition bands to capture more signals.</p>`;
    } else {
      if (parseInt(winRate) >= 60) html += `This strong hit rate validates the transition approach ‚Äî waiting for a confirmed move from weakness to full template strength significantly improves signal quality versus simple threshold triggers. `;
      else if (parseInt(winRate) >= 40) html += `The moderate win rate is typical of trend-following systems ‚Äî profitability depends on winners being larger than losers, not on winning frequency. The transition filter helps by requiring a decisive move before committing capital. `;
      else html += `The below-average win rate suggests the stock made several ‚â§${buyFrom}‚Üí‚â•${buyTarget} transitions that quickly reversed ‚Äî possible Stage 2 false starts. Consider requiring the score to hold at ‚â•${buyTarget} for two consecutive months before entering. `;
      html += `The best trade returned <span class="highlight-green">+${best.toFixed(1)}%</span> while the worst gave back <span class="highlight-red">${worst.toFixed(1)}%</span>.</p>`;
    }

    if (alpha >= 5) {
      html += `<hr class="commentary-divider"><div class="section-label action-label">Key Takeaway</div>`;
      html += `<p>The transition-based MTT system <span class="highlight-green">outperformed buy-and-hold</span> by a meaningful margin. By requiring a full ‚â§${buyFrom}‚Üí‚â•${buyTarget} score transition before buying, the strategy avoided premature entries and captured the most explosive portion of Stage 2 advances ‚Äî while the ‚â•${sellFrom}‚Üí‚â§${sellTarget} sell trigger exited before major drawdowns materialized. This is the OMOINV methodology working exactly as designed.</p>`;
    } else if (alpha >= -5) {
      html += `<hr class="commentary-divider"><div class="section-label action-label">Key Takeaway</div>`;
      html += `<p>The transition strategy performed <span class="highlight-blue">roughly in line with buy-and-hold</span>. While timing didn't add significant alpha here, the strategy reduced exposure during the weakest phases ‚Äî providing a smoother equity curve and lower drawdowns, which matters for capital preservation and psychology.</p>`;
    } else {
      html += `<hr class="commentary-divider"><div class="section-label action-label">Key Takeaway</div>`;
      html += `<p>On this stock, the transition strategy <span class="highlight-red">underperformed buy-and-hold</span>. The ‚â§${buyFrom}‚Üí‚â•${buyTarget} entry requirement may have been too strict, causing late entries after much of the move was already underway. Consider lowering the buy target to 6/7 or widening the "from" threshold to ‚â§5 to capture breakouts earlier.</p>`;
    }

    html += `<hr class="commentary-divider"><p style="font-size:11px; color:var(--text-muted); font-style:italic;">Backtest results are hypothetical and do not account for slippage, commissions, taxes, or market impact. Past performance does not guarantee future results.</p>`;
    body.innerHTML = html;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // STOCK SCREENER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const SCREENER_LISTS = {
    dow30: 'AAPL,AMGN,AMZN,AXP,BA,CAT,CRM,CSCO,CVX,DIS,DOW,GS,HD,HON,IBM,JNJ,JPM,KO,MCD,MMM,MRK,MSFT,NKE,NVDA,PG,SHW,TRV,UNH,V,WMT',
    ndx100: 'AAPL,ABNB,ADBE,ADI,ADP,ADSK,AEP,AMAT,AMD,AMGN,AMZN,ANSS,ARM,ASML,AVGO,AZN,BIIB,BKNG,BKR,CCEP,CDNS,CDW,CEG,CHTR,CMCSA,COST,CPRT,CRWD,CSGP,CSCO,CTAS,CTSH,DASH,DDOG,DLTR,DXCM,EA,EXC,FANG,FAST,FTNT,GEHC,GFS,GILD,GOOG,GOOGL,HON,IDXX,ILMN,INTC,INTU,ISRG,KDP,KHC,KLAC,LIN,LRCX,LULU,MAR,MCHP,MDB,MDLZ,MELI,META,MNST,MRNA,MRVL,MSFT,MU,NFLX,NVDA,NXPI,ODFL,ON,ORLY,PANW,PAYX,PCAR,PDD,PEP,PYPL,QCOM,REGN,ROST,SBUX,SMCI,SNPS,TEAM,TMUS,TSLA,TTD,TTWO,TXN,VRSK,VRTX,WBD,WDAY,XEL,ZS',
    sp500: 'AAPL,ABBV,ABT,ACN,ADBE,ADI,ADM,ADP,ADSK,AEE,AEP,AES,AFL,AIG,AIZ,AJG,AKAM,ALB,ALGN,ALL,ALLE,AMAT,AMCR,AMD,AME,AMGN,AMP,AMT,AMZN,ANET,ANSS,AON,AOS,APA,APD,APH,APTV,ARE,ATO,ATVI,AVGO,AVY,AWK,AXP,AZO,BA,BAC,BAX,BBWI,BBY,BDX,BEN,BF-B,BG,BIIB,BIO,BK,BKNG,BKR,BLK,BMY,BR,BRK-B,BRO,BSX,BWA,BXP,C,CAG,CAH,CARR,CAT,CB,CBOE,CBRE,CCI,CCL,CDAY,CDNS,CDW,CE,CEG,CF,CFG,CHD,CHRW,CHTR,CI,CINF,CL,CLX,CMA,CMCSA,CME,CMG,CMI,CMS,CNC,CNP,COF,COO,COP,COST,CPAY,CPB,CPRT,CPT,CRL,CRM,CSCO,CSGP,CSX,CTAS,CTLT,CTRA,CTSH,CTVA,CVS,CVX,CZR,D,DAL,DD,DE,DFS,DG,DGX,DHI,DHR,DIS,DISH,DLR,DLTR,DOV,DOW,DPZ,DRI,DTE,DUK,DVA,DVN,DXC,DXCM,EA,EBAY,ECL,ED,EFX,EIX,EL,EMN,EMR,ENPH,EOG,EPAM,EQIX,EQR,EQT,ES,ESS,ETN,ETR,ETSY,EVRG,EW,EXC,EXPD,EXPE,EXR,F,FANG,FAST,FBHS,FCX,FDS,FDX,FE,FFIV,FIS,FISV,FITB,FLT,FMC,FOX,FOXA,FRC,FRT,FTNT,FTV,GD,GE,GEHC,GEN,GILD,GIS,GL,GLW,GM,GNRC,GOOG,GOOGL,GPC,GPN,GRMN,GS,GWW,HAL,HAS,HBAN,HCA,HD,HOLX,HON,HPE,HPQ,HRL,HSIC,HST,HSY,HUM,HWM,IBM,ICE,IDXX,IEX,IFF,ILMN,INCY,INTC,INTU,INVH,IP,IPG,IQV,IR,IRM,ISRG,IT,ITW,IVZ,J,JBHT,JCI,JKHY,JNJ,JNPR,JPM,K,KDP,KEY,KEYS,KHC,KIM,KLAC,KMB,KMI,KMX,KO,KR,L,LDOS,LEN,LH,LHX,LIN,LKQ,LLY,LMT,LNT,LOW,LRCX,LULU,LUV,LVS,LW,LYB,LYV,MA,MAA,MAR,MAS,MCD,MCHP,MCK,MCO,MDLZ,MDT,MET,META,MGM,MHK,MKC,MKTX,MLM,MMC,MMM,MNST,MO,MOH,MOS,MPC,MPWR,MRK,MRNA,MRO,MS,MSCI,MSFT,MSI,MTB,MTCH,MTD,MU,NCLH,NDAQ,NDSN,NEE,NEM,NFLX,NI,NKE,NOC,NOW,NRG,NSC,NTAP,NTRS,NUE,NVDA,NVR,NWL,NWS,NWSA,NXPI,O,ODFL,OGN,OKE,OMC,ON,ORCL,ORLY,OTIS,OXY,PARA,PAYC,PAYX,PCAR,PCG,PEAK,PEG,PEP,PFE,PFG,PG,PGR,PH,PHM,PKG,PKI,PLD,PM,PNC,PNR,PNW,POOL,PPG,PPL,PRU,PSA,PSX,PTC,PVH,PWR,PXD,PYPL,QCOM,QRVO,RCL,RE,REG,REGN,RF,RHI,RJF,RL,RMD,ROK,ROL,ROP,ROST,RSG,RTX,RVTY,SBAC,SBNY,SBUX,SCHW,SEE,SHW,SIVB,SJM,SLB,SNA,SNPS,SO,SPG,SPGI,SRE,STE,STLD,STT,STX,STZ,SWK,SWKS,SYF,SYK,SYY,T,TAP,TDG,TDY,TECH,TEL,TER,TFC,TFX,TGT,TMO,TMUS,TPR,TRGP,TRMB,TROW,TRV,TSCO,TSLA,TSN,TT,TTWO,TXN,TXT,TYL,UAL,UDR,UHS,ULTA,UNH,UNP,UPS,URI,USB,V,VFC,VICI,VLO,VMC,VRSK,VRSN,VRTX,VTR,VTRS,VZ,WAB,WAT,WBA,WBD,WDC,WEC,WELL,WFC,WHR,WM,WMB,WMT,WRB,WRK,WST,WTW,WY,WYNN,XEL,XOM,XRAY,XYL,YUM,ZBH,ZBRA,ZION,ZTS',
    tech: 'NVDA,AAPL,MSFT,AVGO,AMD,CRM,ADBE,NOW,ORCL,PLTR,NFLX,PANW,CRWD,SNOW,NET,DDOG,MDB,ZS,FTNT,CYBR',
    energy: 'XOM,CVX,COP,EOG,SLB,MPC,PSX,VLO,OXY,DVN,HAL,FANG,PXD,HES,BKR,TRGP,WMB,KMI,OKE,CTRA',
    finance: 'JPM,BAC,WFC,GS,MS,C,BLK,SCHW,AXP,USB,PNC,COF,BK,CME,ICE,SPGI,MCO,MMC,AIG,MET',
    health: 'LLY,UNH,JNJ,MRK,ABBV,PFE,TMO,ABT,DHR,BMY,AMGN,GILD,ISRG,VRTX,REGN,SYK,MDT,ZTS,BSX,HCA',
    etf: 'SPY,QQQ,IWM,DIA,XLF,XLE,XLK,XLV,XLI,XLU,XLP,XLY,XLC,XLRE,XLB,SMH,XBI,ARKK,SOXX,VTI',
  };

  let screenerResults = [];
  let screenerSortKey = 'score';
  let screenerSortDir = -1;

  function setScreenerList(key) {
    const val = SCREENER_LISTS[key] || '';
    document.getElementById('screenerSymbols').value = val;
    const count = val.split(',').filter(s => s).length;
    const est = Math.ceil(count * 1.2);
    const mins = Math.floor(est / 60);
    const secs = est % 60;
    const timeStr = mins > 0 ? `~${mins}m ${secs}s` : `~${secs}s`;
    document.getElementById('screenerEstimate').innerHTML = `<strong>${count} symbols</strong> ¬∑ Estimated scan time: <strong>${timeStr}</strong>`;
  }

  async function runScreener() {
    const input = document.getElementById('screenerSymbols').value.trim().toUpperCase();
    if (!input) { alert('Enter at least one symbol'); return; }
    const symbols = input.split(/[,\s]+/).filter(s => s.length > 0 && s.length < 10);
    if (symbols.length === 0) return;

    document.getElementById('screenerEmpty').style.display = 'none';
    document.getElementById('screenerResults').style.display = 'none';
    const progress = document.getElementById('screenerProgress');
    progress.classList.add('visible');
    document.getElementById('screenerSpinner').style.display = 'inline-block';

    screenerResults = [];
    let completed = 0;

    // Fetch SPY baseline first
    let spyData = null;
    try {
      document.getElementById('screenerProgressText').textContent = `Fetching SPY baseline‚Ä¶`;
      const spyJson = await fetchWithProxy(yahooChartUrl('SPY', 1100));
      const spyResult = spyJson.chart?.result?.[0];
      if (spyResult) {
        spyData = spyResult.indicators.quote[0].close.filter(c => c != null);
      }
    } catch (e) { /* proceed without RS */ }

    for (const sym of symbols) {
      completed++;
      document.getElementById('screenerProgressText').textContent = `Scanning ${sym} (${completed}/${symbols.length})‚Ä¶`;
      document.getElementById('screenerProgressFill').style.width = ((completed / symbols.length) * 100) + '%';

      try {
        const json = await fetchWithProxy(yahooChartUrl(sym, 1100));
        const result = json.chart?.result?.[0];
        if (!result || !result.timestamp) continue;

        const secName = result.meta?.shortName || result.meta?.longName || sym;

        const closes = [];
        const rawCloses = result.indicators.quote[0].close;
        for (let i = 0; i < rawCloses.length; i++) {
          if (rawCloses[i] != null) closes.push(rawCloses[i]);
        }
        if (closes.length < 50) continue;

        const price = closes[closes.length - 1];
        const yearSlice = closes.slice(-252);
        const h52 = Math.max(...yearSlice);
        const l52 = Math.min(...yearSlice);
        const sma = (n) => closes.slice(-n).reduce((s, v) => s + v, 0) / n;
        const s50 = closes.length >= 50 ? sma(50) : null;
        const s150 = closes.length >= 150 ? sma(150) : null;
        const s200 = closes.length >= 200 ? sma(200) : null;

        let rs = null;
        if (spyData && spyData.length >= 126 && closes.length >= 126) {
          const stockRet = price / closes[closes.length - 127];
          const spyRet = spyData[spyData.length - 1] / spyData[spyData.length - 127];
          if (spyRet > 0) rs = stockRet / spyRet;
        }

        const pctFromHigh = ((h52 - price) / h52) * 100;
        const pctAboveLow = ((price - l52) / l52) * 100;
        const c1 = pctFromHigh <= 25;
        const c2 = pctAboveLow >= 30;
        const c3 = s50 ? price > s50 : false;
        const c4 = s150 ? price > s150 : false;
        const c5 = s200 ? price > s200 : false;
        const c6 = (s50 && s150 && s200) ? (s50 > s150 && s150 > s200) : false;
        const c7 = rs !== null && rs > 1.0;
        const score = [c1, c2, c3, c4, c5, c6, c7].filter(Boolean).length;

        screenerResults.push({
          symbol: sym, name: secName, score, price, h52, l52, s50, s150, s200, rs,
          pctFromHigh, pctAboveLow, c1, c2, c3, c4, c5, c6, c7,
          smaAlign: c6,
        });
      } catch (e) {
        screenerResults.push({ symbol: sym, name: sym, score: -1, error: e.message });
      }

      // Small delay to not hammer proxies
      if (completed < symbols.length) {
        await new Promise(r => setTimeout(r, 300));
      }
    }

    // Sort by score descending
    screenerSortKey = 'score';
    screenerSortDir = -1;
    renderScreenerTable();

    progress.classList.remove('visible');
    document.getElementById('screenerSpinner').style.display = 'none';
    document.getElementById('screenerResults').style.display = 'block';
  }

  function renderScreenerTable() {
    const sorted = [...screenerResults].sort((a, b) => {
      const aV = getSortVal(a, screenerSortKey);
      const bV = getSortVal(b, screenerSortKey);
      if (aV < bV) return screenerSortDir;
      if (aV > bV) return -screenerSortDir;
      return 0;
    });

    const tbody = document.getElementById('screenerBody');
    tbody.innerHTML = '';

    sorted.forEach((r, i) => {
      if (r.score === -1) {
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${r.symbol}</td><td>${r.name}</td><td colspan="7" style="color:var(--accent-red)">Error: ${r.error}</td></tr>`;
        return;
      }

      const scoreCls = r.score === 7 ? 'score-7' : r.score >= 5 ? 'score-56' : r.score >= 3 ? 'score-34' : 'score-low';
      const verdict = r.score === 7 ? 'üü¢ BUY' : r.score >= 5 ? 'üîµ WATCH' : r.score >= 3 ? 'üü° HOLD' : 'üî¥ AVOID';
      const verdictColor = r.score === 7 ? 'var(--accent-green)' : r.score >= 5 ? 'var(--accent-cyan)' : r.score >= 3 ? 'var(--accent-amber)' : 'var(--accent-red)';
      const rsStr = r.rs !== null ? r.rs.toFixed(2) : '‚Äî';
      const rsColor = r.rs !== null ? (r.rs > 1 ? 'var(--accent-green)' : 'var(--accent-red)') : 'var(--text-muted)';
      const truncName = r.name.length > 22 ? r.name.slice(0, 20) + '‚Ä¶' : r.name;

      tbody.innerHTML += `<tr>
        <td>${i+1}</td>
        <td style="color:var(--text-primary); font-weight:600">${r.symbol}</td>
        <td style="color:var(--text-secondary); font-size:12px; max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${r.name}">${truncName}</td>
        <td><span class="score-pill ${scoreCls}">${r.score}/7</span></td>
        <td>$${r.price.toFixed(2)}</td>
        <td style="color:${r.pctFromHigh <= 25 ? 'var(--accent-green)' : 'var(--accent-red)'}">${r.pctFromHigh.toFixed(1)}%</td>
        <td style="color:${r.pctAboveLow >= 30 ? 'var(--accent-green)' : 'var(--accent-red)'}">+${r.pctAboveLow.toFixed(1)}%</td>
        <td style="color:${r.smaAlign ? 'var(--accent-green)' : 'var(--accent-red)'}">${r.smaAlign ? '‚úì Yes' : '‚úó No'}</td>
        <td style="color:${rsColor}">${rsStr}</td>
        <td style="color:${verdictColor}; font-weight:600">${verdict}</td>
      </tr>`;
    });
  }

  function getSortVal(r, key) {
    if (r.score === -1) return -999;
    switch(key) {
      case 'rank': return 0;
      case 'symbol': return r.symbol;
      case 'name': return r.name?.toLowerCase() || '';
      case 'score': return r.score;
      case 'price': return r.price;
      case 'fromHigh': return -r.pctFromHigh;
      case 'aboveLow': return r.pctAboveLow;
      case 'smaAlign': return r.smaAlign ? 1 : 0;
      case 'rs': return r.rs || 0;
      case 'verdict': return r.score;
      default: return 0;
    }
  }

  function sortScreener(key) {
    if (screenerSortKey === key) screenerSortDir *= -1;
    else { screenerSortKey = key; screenerSortDir = -1; }
    renderScreenerTable();
  }
</script>
</body>
</html>
